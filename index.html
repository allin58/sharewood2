<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geo-Point App</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
 <style>
    /* ------------------------------------------- */
    /* 1. –ë–ê–ó–û–í–´–ï –ù–ê–°–¢–†–û–ô–ö–ò –ò –¢–ò–ü–û–ì–†–ê–§–ò–ö–ê */
    /* ------------------------------------------- */
    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* –£–ª—É—á—à–µ–Ω–Ω–∞—è —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å */
        color: #333; /* –ë–∞–∑–æ–≤—ã–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ */
    }
    #map {
        height: 100vh;
        width: 100%;
    }
    :root{
        --primary-color: #007bff;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --cell-size: 48px;
        --grid-gap-color: #e9ecef; /* –ë–æ–ª–µ–µ —Å–≤–µ—Ç–ª—ã–π */
        --line-size: 1px;
        --header-bg: #f8f9fa;
        --firstcol-bg: #f8f9fa;
        --accent-hover: rgba(0, 123, 255, 0.15); /* –ë–æ–ª–µ–µ –∑–∞–º–µ—Ç–Ω—ã–π —Ö–æ–≤–µ—Ä */
    }

    /* ------------------------------------------- */
    /* 2. –≠–õ–ï–ú–ï–ù–¢–´ –ö–ê–†–¢–´ –ò –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô (FAB) */
    /* ------------------------------------------- */

    /* –°—Ç–∞—Ç—É—Å –°–æ–µ–¥–∏–Ω–µ–Ω–∏—è */
    #connectionStatus {
        position: fixed;
        top: 15px;
        right: 15px;
        z-index: 3000;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        font-size: 14px;
        font-weight: bold;
        pointer-events: auto; /* –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è */
        background: rgba(255, 255, 255, 0.95);
        padding: 8px 12px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        transition: background 0.2s;
        cursor: default;
    }
    #connectionStatusRow {
        display: flex;
        align-items: center;
    }
    #connectionDot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 6px;
        background: var(--danger-color); /* –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –∫—Ä–∞—Å–Ω—ã–π (–Ω–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è/–∑–∞–≥—Ä—É–∑–∫–∞) */
    }
    #telegramUsername {
        font-size: 11px; /* –ú–µ–Ω—å—à–µ –∏ –º–µ–Ω–µ–µ –∑–∞–º–µ—Ç–Ω–æ */
        color: #888;
        margin-top: 2px;
        font-weight: normal;
    }

    /* –ö—Ä–µ—Å—Ç–∏–∫ */
    #crosshair {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 24px; /* –ß—É—Ç—å –±–æ–ª—å—à–µ */
        height: 24px;
        margin-left: -12px;
        margin-top: -12px;
        pointer-events: none;
        z-index: 999;
        opacity: 0.7; /* –ú–µ–Ω–µ–µ –Ω–∞–≤—è–∑—á–∏–≤—ã–π */
    }
    #crosshair::before, #crosshair::after {
        content: '';
        position: absolute;
        background: #000; /* –ß–µ—Ä–Ω—ã–π */
    }
    #crosshair::before {
        left: 50%; top: 0; width: 2px; height: 100%; margin-left: -1px;
    }
    #crosshair::after {
        top: 50%; left: 0; width: 100%; height: 2px; margin-top: -1px;
    }

    /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π (FAB & Admin) */
    #newPointBtn {
        /* FAB —Å—Ç–∏–ª—å, –ø—Ä–∞–≤—ã–π –Ω–∏–∂–Ω–∏–π —É–≥–æ–ª */
        position: absolute;
        bottom: 15px;
        right: 15px;
        left: auto;
        transform: none;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background-color: var(--success-color);
        color: white;
        font-size: 28px;
        line-height: 56px;
        text-align: center;
        padding: 0;
        border: none;
        cursor: pointer;
        z-index: 1000;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        transition: background-color 0.2s, transform 0.2s;
    }
    #newPointBtn:hover {
        background-color: #1e7e34;
        transform: scale(1.05);
    }

    #adminPanelBtn {
        /* –í—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞, –ª–µ–≤—ã–π –Ω–∏–∂–Ω–∏–π —É–≥–æ–ª */
        position: absolute;
        bottom: 15px;
        left: 15px;
        transform: none;
        z-index: 1000;
        background-color: #6c757d;
        color: white;
        padding: 10px 16px; /* –ß—É—Ç—å –±–æ–ª—å—à–µ padding */
        border: none;
        border-radius: 6px;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: background-color 0.2s;
    }
    #adminPanelBtn:hover {
        background-color: #5a6268;
    }

    /* ------------------------------------------- */
    /* 3. –û–°–ù–û–í–ù–û–ï –û–ö–ù–û –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø (#popupWindow) */
    /* ------------------------------------------- */

    /* –ú–æ–±–∏–ª—å–Ω—ã–π —Å—Ç–∏–ª—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
    #popupWindow {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤–µ—Å—å —ç–∫—Ä–∞–Ω –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        z-index: 999998 !important;
        background: white;
        display: none;
        overflow-y: auto;
        padding: 20px;
        box-sizing: border-box;
        transition: opacity 0.3s, transform 0.3s;
    }

    #popupClose {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 30px;
        color: #333;
        cursor: pointer;
        font-weight: 200;
    }

    /* –°—Ç–∏–ª—å –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ö */
    #popupWindow label {
        display: block;
        margin-top: 12px;
        font-weight: 600; /* –ë–æ–ª–µ–µ –∂–∏—Ä–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
        font-size: 14px;
        color: #555;
    }
    #popupWindow input[type="text"], #popupWindow textarea, #popupWindow input[type="file"], #popupWindow select {
        width: 100%;
        padding: 8px; /* –ß—É—Ç—å –±–æ–ª—å—à–µ padding */
        margin-top: 5px;
        box-sizing: border-box;
        border-radius: 4px;
        border: 1px solid #ced4da; /* –°–≤–µ—Ç–ª–µ–µ —Ä–∞–º–∫–∞ */
        font-size: 15px;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    #popupWindow input[type="text"]:focus, #popupWindow textarea:focus, #popupWindow select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
        outline: none;
    }

    #popupWindow textarea {
        resize: vertical;
    }

    /* –°—Ç–∏–ª—å –¥–ª—è –±–ª–æ–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç */
    .form-group > div {
        border: 1px solid #ced4da;
        padding: 8px;
        border-radius: 4px;
    }
    #popupCoords {
        font-weight: 600;
        color: #333;
    }
    #copyCoordsBtn {
        font-size: 16px;
        opacity: 0.7;
    }
    #copyCoordsBtn:hover {
        opacity: 1;
        color: #0056b3;
    }

    /* –°–ø–∏—Å–æ–∫ —Ñ–æ—Ç–æ */
    #photoList {
        margin-top: 10px;
        max-height: 180px; /* –ß—É—Ç—å –±–æ–ª—å—à–µ –≤—ã—Å–æ—Ç–∞ */
        overflow-y: auto;
        display: flex;
        flex-wrap: wrap;
        gap: 8px; /* –ü—Ä–æ–º–µ–∂—É—Ç–∫–∏ –º–µ–∂–¥—É —Ñ–æ—Ç–æ */
        border: 1px solid #eee; /* –õ–µ–≥–∫–∞—è —Ä–∞–º–∫–∞ */
        padding: 8px 4px;
        border-radius: 4px;
    }
    .photoItem {
        position: relative;
    }
    .photoItem img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 6px;
        cursor: pointer;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
    }
    .photoItem img:hover {
        transform: scale(1.05);
    }
    .removePhoto {
        position: absolute;
        top: -8px;
        right: -8px;
        background: var(--danger-color);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        text-align: center;
        line-height: 20px;
        font-size: 12px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    /* –ö–Ω–æ–ø–∫–∏ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å/–£–¥–∞–ª–∏—Ç—å */
    #saveBtn, #deleteBtn {
        margin-top: 20px; /* –£–≤–µ–ª–∏—á–∏—Ç—å –æ—Ç—Å—Ç—É–ø */
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        color: white;
        cursor: pointer;
        transition: background-color 0.2s, box-shadow 0.2s;
        font-weight: 600;
    }
    #saveBtn {
        background: var(--primary-color);
        box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
    }
    #saveBtn:hover {
        background: #0056b3;
    }
    #deleteBtn {
        background: var(--danger-color);
        opacity: 0.9;
    }
    #deleteBtn:hover {
        opacity: 1;
        background: #bd2130;
    }

    /* –ó–∞–≥—Ä—É–∑–∫–∞ */
    #spinner { display: none; text-align: center; margin-top: 15px; }
    .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        width: 30px; height: 30px;
        animation: spin 1s linear infinite;
        display: inline-block;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }


    /* ------------------------------------------- */
    /* 4. –ê–î–ê–ü–¢–ê–¶–ò–Ø –î–õ–Ø –î–ï–°–ö–¢–û–ü–ê (Popup) */
    /* ------------------------------------------- */
    @media (min-width: 768px) {
        #popupWindow {
            /* –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∏ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å */
            width: 450px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
            height: auto;
            max-height: 90vh;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 10px; /* –°–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            padding: 30px;
        }
        #popupClose {
            top: 15px;
            right: 15px;
        }
    }


    /* ------------------------------------------- */
    /* 5. –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –§–û–¢–û (#photoModal) */
    /* ------------------------------------------- */
    #photoModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9); /* –ë–æ–ª–µ–µ —Ç–µ–º–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ */
        justify-content: center;
        align-items: center;
        z-index: 999999;
    }
    #photoModal img {
        max-width: 90%;
        max-height: 90%;
        border-radius: 6px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
    }
    #closePhotoModal { /* –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ –∏–∑ #photoModal span */
        position: absolute;
        top: 20px;
        right: 30px;
        font-size: 40px; /* –ë–æ–ª—å—à–µ, –ª–µ–≥—á–µ –ø–æ–ø–∞—Å—Ç—å */
        color: white;
        cursor: pointer;
        text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
    }
    #photoWrapper {
        position: relative;
    }

    /* –ö–Ω–æ–ø–∫–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏—è (Doodle Buttons) */
    .circleButton {
        position: absolute;
        bottom: 20px; /* –û—Ç—Å—Ç—É–ø –æ—Ç –Ω–∏–∂–Ω–µ–≥–æ –∫—Ä–∞—è —Ñ–æ—Ç–æ */
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        font-size: 24px;
        color: white;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 1;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
        transition: background-color 0.2s, transform 0.2s;
    }
    .circleButton:hover {
        transform: scale(1.1);
    }
    #startDoodle {
        left: 50%;
        transform: translateX(-50%);
        background-color: #17a2b8; /* Info Blue */
    }
    #saveDoodle {
        left: 20px;
        background-color: var(--success-color);
    }
    #cancelDoodle {
        right: 20px;
        background-color: var(--danger-color);
    }


    /* ------------------------------------------- */
    /* 6. –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ –ò –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê */
    /* ------------------------------------------- */

    .admin-modal-window {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.7); z-index: 4000; justify-content: center; align-items: center;
    }
    .admin-modal-content {
        background: white; padding: 25px; border-radius: 8px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        max-width: 90%; max-height: 90%; overflow-y: auto; position: relative;
    }
    #adminPanelWindow .admin-modal-content { width: 90%; max-width: 800px; min-height: 400px; } /* –ß—É—Ç—å —à–∏—Ä–µ */
    #userEditModal .admin-modal-content, #objectEditModal .admin-modal-content { width: 90%; max-width: 450px; }
    .modal-close-btn { position: absolute; top: 10px; right: 15px; font-size: 30px; cursor: pointer; color: #555; }

    /* –ü–æ–ª—è –≤–≤–æ–¥–∞ –≤ –∞–¥–º–∏–Ω–∫–µ */
    .admin-modal-content label { display: block; margin-top: 10px; font-weight: 600; font-size: 14px; color: #555; }
    .admin-modal-content input[type="text"],
    .admin-modal-content input[type="password"],
    .admin-modal-content textarea,
    .admin-modal-content select {
        width: 100%; padding: 8px; margin-top: 4px; box-sizing: border-box; border-radius: 4px; border: 1px solid #ced4da; font-size: 15px;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .admin-modal-content input:focus, .admin-modal-content textarea:focus, .admin-modal-content select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
        outline: none;
    }
    .admin-modal-content textarea { resize: vertical; }

    /* –ö–Ω–æ–ø–∫–∏ –≤ –∞–¥–º–∏–Ω–∫–µ */
    .admin-action-button {
        padding: 8px 12px; border: none; border-radius: 4px; background-color: var(--primary-color); color: white;
        cursor: pointer; margin-bottom: 10px; font-size: 14px; font-weight: 600;
        transition: background-color 0.2s;
    }
    .admin-action-button:hover { background-color: #0056b3; }
    #deleteUserBtn, #deleteObjectBtn { background: var(--danger-color); margin-left: 10px; }
    #deleteUserBtn:hover, #deleteObjectBtn:hover { background: #bd2130; }

    /* –í–∫–ª–∞–¥–∫–∏ –≤ –∞–¥–º–∏–Ω–∫–µ */
    .admin-tabs { display: flex; border-bottom: 2px solid #ccc; margin-bottom: 10px; }
    .adminTabButton {
        padding: 10px 15px; cursor: pointer; background: #f4f4f4; border-radius: 4px 4px 0 0;
        border: 1px solid #ccc; border-bottom: none; margin-bottom: -2px; margin-right: 5px; font-size: 15px;
        font-weight: 600; transition: background-color 0.2s;
    }
    .adminTabButton.active { background: white; border-bottom: 2px solid white; color: var(--primary-color); }
    .adminTabButton:hover:not(.active) { background-color: #e9ecef; }
    .adminTabContentPane { display: none; padding-top: 10px; }

    /* –¢–∞–±–ª–∏—Ü—ã –≤ –∞–¥–º–∏–Ω–∫–µ - –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
    .adminTabContentPane table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
    .adminTabContentPane th, .adminTabContentPane td { padding: 8px 10px; border: 1px solid #e9ecef; text-align: left; }
    .adminTabContentPane th { background-color: #f8f9fa; font-weight: 600; }
    /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫ –¥–ª—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü */
    #usersTable tbody tr, #objectsTable tbody tr {
        cursor: pointer;
        transition: background-color 0.15s;
    }
    #usersTable tbody tr:hover, #objectsTable tbody tr:hover {
        background-color: #e9ecef;
    }

    /* ------------------------------------------- */
    /* 7. –°–ï–¢–ö–ê –ù–ê–ó–ù–ê–ß–ï–ù–ò–ô (GRID) */
    /* ------------------------------------------- */

    .table-wrap{
        border:1px solid #e2e8f0;
        overflow:auto;
        max-height:60vh;
        max-width:100%;
        position:relative;
        cursor:grab; /* –î–ª—è UX –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è */
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    .table-wrap::-webkit-scrollbar { display: none; }
    .table-wrap:active { cursor: grabbing; } /* –ö—É—Ä—Å–æ—Ä –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ */

    #assignment-table{
        border-collapse:separate;
        border-spacing:0;
        width:max-content;
        min-width:100%;
    }

    /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ —è—á–µ–µ–∫ */
    #assignment-table th, #assignment-table td{
        width:var(--cell-size);
        height:var(--cell-size);
        min-width:var(--cell-size);
        min-height:var(--cell-size);
        padding:6px 8px;
        box-sizing:border-box;
        text-align:left;
        vertical-align:middle;
        border-right: var(--line-size) solid var(--grid-gap-color);
        border-bottom: var(--line-size) solid var(--grid-gap-color);
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
        cursor: pointer;
        background-color: #fcfcfc; /* –û—á–µ–Ω—å —Å–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω –¥–ª—è –Ω–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–π –∫–ª–µ—Ç–∫–∏ */
        transition: background-color 0.2s;
        font-size: 13px;
    }

    /* –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ */
    #assignment-table thead th:first-child{
        position: sticky; top:0; left:0;
        background: var(--header-bg); z-index: 5;
    }
    #assignment-table thead th:not(:first-child){
        position: sticky; top:0;
        background: var(--header-bg); z-index: 4;
        text-align:center; font-weight:700;
    }
    #assignment-table tbody td:first-child{
        position: sticky; left:0;
        background: var(--firstcol-bg); z-index: 3;
        box-shadow:2px 0 4px rgba(0,0,0,0.04);
        cursor: default;
        font-weight: bold;
    }

    /* –°–¢–ò–õ–ò –ü–û–î–°–í–ï–¢–ö–ò –ò –ù–ê–ó–ù–ê–ß–ï–ù–ò–Ø */
    .assigned {
        background-color: var(--success-color) !important;
        color: white;
        text-align: center;
        font-weight: bold;
    }
    .assigned::after {
        content: '‚úì'; /* –í–∏–∑—É–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è */
        font-size: 16px;
    }
    .unassigned {
        background-color: #fcfcfc;
    }

    /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
    .col-hover, .row-hover {
        background-color: var(--accent-hover) !important; /* –ë–æ–ª–µ–µ –∑–∞–º–µ—Ç–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ */
    }

    /* –°–±—Ä–æ—Å –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —è—á–µ–µ–∫ */
    .col-hover:first-child, .row-hover:first-child { background-color: var(--firstcol-bg) !important; }
    #assignment-table thead th:first-child.col-hover { background-color: var(--header-bg) !important; }

    /* –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–∞—è —è—á–µ–π–∫–∞ –Ω–µ —Ç–µ—Ä—è–µ—Ç —Ü–≤–µ—Ç */
    .assigned.col-hover,
    .assigned.row-hover {
        background-color: var(--success-color) !important;
        color: white !important;
    }

    /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
    #assignment-table tbody tr:hover td:not(:first-child){
        background-color: rgba(0, 123, 255, 0.05); /* –õ–µ–≥–∫–∏–π –æ—Ç—Ç–µ–Ω–æ–∫ */
    }
    /* –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ–Ω –ø–µ—Ä–≤–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ —Å—Ç—Ä–æ–∫—É */
    #assignment-table tbody tr:hover td:first-child{
        background-color: var(--firstcol-bg) !important;
    }


 /* ------------------------------------------- */
/* 8. –§–û–†–ú–ê –í–•–û–î–ê (#loginForm) */
/* ------------------------------------------- */

#loginForm {
    /* –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;

    /* –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–Ω –∏ z-index */
    background: white;
    z-index: 5000;

    /* –ò—Å–ø–æ–ª—å–∑—É–µ–º Flexbox –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ */
    display: flex;
    justify-content: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ */
    align-items: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
    flex-direction: column; /* –≠–ª–µ–º–µ–Ω—Ç—ã –≤ —Å—Ç–æ–ª–±–µ—Ü */
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤–Ω—É—Ç—Ä–∏ —Ñ–æ—Ä–º—ã */
#loginForm h3 {
    font-size: 20px;
    margin-bottom: 15px;
    color: #333;
}
#loginForm input[type="text"],
#loginForm input[type="password"] {
    padding: 10px;
    margin: 6px 0;
    width: 250px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
    box-sizing: border-box;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 16px;
}
#loginForm button {
    width: 250px;
    padding: 10px;
    margin-top: 15px;
    background-color: var(--primary-color, #007bff);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.2s;
}
#loginForm button:hover {
    background-color: #0056b3;
}


</style>
</head>
<body>

    <div id="map"></div>

    <div id="crosshair"></div>

    <div id="spinner"><div class="loader"></div></div>

    <div id="connectionStatus" role="status">
        <div id="connectionStatusRow">
            <div id="connectionDot" aria-hidden="true"></div>
            <div id="connectionText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        <div id="telegramUsername"></div>
    </div>

    <button id="newPointBtn" title="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–µ—Ç–∫—É">‚ûï</button>
    <button id="adminPanelBtn" class="admin-action-button hidden-by-default" title="–û—Ç–∫—Ä—ã—Ç—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—É—é –ø–∞–Ω–µ–ª—å">–ê–¥–º–∏–Ω–∫–∞</button>


    <div id="loginForm">
        <h3>–í—Ö–æ–¥</h3>
        <input type="text" id="loginUsername" placeholder="–õ–æ–≥–∏–Ω (Username)" required aria-label="–õ–æ–≥–∏–Ω">
        <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" required aria-label="–ü–∞—Ä–æ–ª—å">
        <button id="loginBtn">–í–æ–π—Ç–∏</button>
    </div>

    <div id="popupWindow" role="dialog" aria-modal="true" aria-labelledby="popupTitle">
        <span id="popupClose" title="–ó–∞–∫—Ä—ã—Ç—å" aria-label="–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ">&times;</span>
        <h3 id="popupTitle" style="font-size: 18px; margin: 0px 0;">–ù–æ–≤–∞—è –º–µ—Ç–∫–∞ #</h3>

        <div class="form-group">
            <label>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</label>
            <div style="display: flex; align-items: center; border: 1px solid #ccc; padding: 6px; border-radius: 4px;">
                <span id="popupCoords" style="flex-grow: 1;" aria-live="polite">‚Äî</span>
                <button id="copyCoordsBtn" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã" aria-label="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã" style="background: none; color: #007bff; border: none; cursor: pointer; padding: 0 5px; font-size: 14px;">üìã</button>
            </div>
        </div>

        <div class="form-group">
            <label for="pointObjectSelect">–û–±—ä–µ–∫—Ç (*):</label>
            <select id="pointObjectSelect" required>
                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç --</option>
            </select>
        </div>

        <div class="form-group">
            <label for="breedInput">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Ä–æ–¥–∞ –¥–µ—Ä–µ–≤–∞):</label>
            <input type="text" id="breedInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã">
        </div>

        <div class="form-group">
            <label for="noteInput">–ó–∞–º–µ—Ç–∫–∞:</label>
            <textarea id="noteInput" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é"></textarea>
        </div>


        <div class="form-group">
            <label for="markerColor">–¶–≤–µ—Ç –º–µ—Ç–∫–∏:</label>
            <select id="markerColor">
                <option value="green">–ó–µ–ª–µ–Ω—ã–π</option>
                <option value="blue">–°–∏–Ω–∏–π</option>
                <option value="red">–ö—Ä–∞—Å–Ω—ã–π</option>
                <option value="yellow">–ñ–µ–ª—Ç—ã–π</option>
                <option value="black">–ß–µ—Ä–Ω—ã–π</option>
            </select>
        </div>

        <div class="form-group">
            <label for="photoInput">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏:</label>
            <input type="file" id="photoInput" accept="image/*" multiple aria-describedby="photo_hint">
            <small id="photo_hint" style="display: block; font-size: 11px; color: #666; margin-top: 4px;">–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.</small>
            <div id="photoList"></div>
        </div>

        <div style="display: flex; gap: 10px;">
            <button id="saveBtn" style="flex-grow: 1;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="deleteBtn" style="width: auto; flex-grow: 1; margin-top: 12px; display:none;">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>

<div id="photoModal" role="dialog" aria-modal="true" aria-labelledby="photoModalTitle">
    <h2 id="photoModalTitle" style="position: absolute; left: -9999px;">–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ</h2>
    <span id="closePhotoModal" title="–ó–∞–∫—Ä—ã—Ç—å" aria-label="–ó–∞–∫—Ä—ã—Ç—å —Ñ–æ—Ç–æ">&times;</span>

    <div id="photoWrapper" style="position: relative;">
        <img id="photoImage" src="" alt="Photo" style="max-width: 100%; max-height: 80vh;">
        <canvas id="doodleCanvas" style="position: absolute; top: 0; left: 0; display: none;"></canvas>

        <button id="startDoodle" class="circleButton" title="–ù–∞—á–∞—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ" aria-label="–ù–∞—á–∞—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ">‚úé</button>
        <button id="saveDoodle" class="circleButton" style="display: none;" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫" aria-label="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫">‚úî</button>
        <button id="cancelDoodle" class="circleButton" style="display: none;" title="–û—Ç–º–µ–Ω–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫" aria-label="–û—Ç–º–µ–Ω–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫">‚úñ</button>
    </div>
</div>


    <div id="adminPanelWindow" class="admin-modal-window" role="dialog" aria-modal="true" aria-labelledby="adminPanelTitle">
        <div class="admin-modal-content">
            <span id="adminPanelClose" class="modal-close-btn" title="–ó–∞–∫—Ä—ã—Ç—å" aria-label="–ó–∞–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å">&times;</span>
            <h3 id="adminPanelTitle">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>

            <div role="tablist" class="admin-tabs">
                <button role="tab" class="adminTabButton active" data-tab="users" aria-selected="true" aria-controls="tab-users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
                <button role="tab" class="adminTabButton" data-tab="objects" aria-selected="false" aria-controls="tab-objects">–û–±—ä–µ–∫—Ç—ã</button>
                <button role="tab" class="adminTabButton" data-tab="assignments" aria-selected="false" aria-controls="tab-assignments">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</button>
            </div>

            <div id="tab-users" class="adminTabContentPane" role="tabpanel" style="display: block;">
                <button id="createUserBtn" class="admin-action-button" style="background-color: #28a745;">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
                <h4>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</h4>
                <table id="usersTable">
                    <thead>
                        <tr><th>–§–ò–û</th><th>–†–æ–ª—å</th></tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="2">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>

            <div id="tab-objects" class="adminTabContentPane" role="tabpanel">
                <button id="createObjectBtn" class="admin-action-button" style="background-color: #28a745;">‚ûï –°–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç</button>
                <h4>–°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤:</h4>
                <table id="objectsTable">
                    <thead>
                        <tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>

            <div id="tab-assignments" class="adminTabContentPane" role="tabpanel">
                <h4>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:</h4>

                <div class="table-wrap" id="assignmentWrap">
                    <table id="assignment-table" aria-label="–¢–∞–±–ª–∏—Ü–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º">
                        <thead>
                            <tr id="headerRow">
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å \ –û–±—ä–µ–∫—Ç</th>
                            </tr>
                        </thead>
                        <tbody id="bodyRows">
                            <tr><td colspan="100">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <div id="userEditModal" class="admin-modal-window" role="dialog" aria-modal="true" aria-labelledby="userEditTitle">
        <div class="admin-modal-content">
            <span id="userEditModalClose" class="modal-close-btn" title="–ó–∞–∫—Ä—ã—Ç—å" aria-label="–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ">&times;</span>
            <h3 id="userEditTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            <input type="hidden" id="editUserId">

            <label for="editFullName">–§–ò–û (*):</label>
            <input type="text" id="editFullName" required>

            <label for="editRole">–†–æ–ª—å:</label>
            <select id="editRole">
                <option value="user">user</option>
                <option value="admin">admin</option>
            </select>

            <div id="newAccountFields" style="border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 10px;">
                <label style="font-size: 12px; font-weight: normal;">–î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞ (–∑–∞–ø–æ–ª–Ω–∏—Ç—å –ò–õ–ò Telegram ID):</label>
                <input type="text" id="editUsername" placeholder="Username">
                <input type="password" id="editPassword" placeholder="–ü–∞—Ä–æ–ª—å">
                <input type="text" id="editTelegramId" placeholder="Telegram ID">
            </div>

            <div id="optionalInfoFields">
                <label for="editPhone">–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                <input type="text" id="editPhone">
                <label for="editAdditionalInfo">–î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</label>
                <textarea id="editAdditionalInfo" rows="2"></textarea>
            </div>

            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button id="saveUserBtn" class="admin-action-button" style="flex-grow: 1;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button id="deleteUserBtn" class="admin-action-button" style="display: none;">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="objectEditModal" class="admin-modal-window" role="dialog" aria-modal="true" aria-labelledby="objectEditTitle">
        <div class="admin-modal-content">
            <span id="objectEditModalClose" class="modal-close-btn" title="–ó–∞–∫—Ä—ã—Ç—å" aria-label="–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ">&times;</span>
            <h3 id="objectEditTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞</h3>
            <input type="hidden" id="editObjectId">

            <label for="editObjectName">–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ (*):</label>
            <input type="text" id="editObjectName" required>

            <label for="editObjectInfo">–î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</label>
            <textarea id="editObjectInfo" rows="3"></textarea>
            <div id="objectPointsList" style="margin-top: 15px;">
                <label>–ú–µ—Ç–∫–∏, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ –æ–±—ä–µ–∫—Ç—É:</label>
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; border-radius: 4px;">
                    <table id="pointTable" style="width: 100%; border-collapse: collapse; text-align: left;">
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button id="saveObjectBtn" class="admin-action-button" style="flex-grow: 1;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button id="deleteObjectBtn" class="admin-action-button" style="display: none;">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        // =========================================================
        // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
        // =========================================================
        const SERVER_URL = "https://sweet-meals-greet.loca.lt";
        let TELEGRAM_INIT_DATA = null;
        let telegramUsername = null;
        let isAdmin = false;
        let appInitialized = false;
        const params = new URLSearchParams(window.location.search);
        let currentEntryId = null;
        let selectedFiles = [];
        let existingPhotos = [];
        let markersMap = {};
        let currentCenter = {lat: 54.1032, lon: 28.3186};

        const COPY_SYMBOL = 'üìã';
        const COPIED_SYMBOL = '‚úîÔ∏è';

        // =========================================================
        // –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø –ò –£–¢–ò–õ–ò–¢–´ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        // =========================================================
        async function fetchWithAuth(url, options={}) {
            options = options || {};
            options.credentials = 'include';
            options.headers = options.headers || {};
            if(TELEGRAM_INIT_DATA){
                options.headers['X-Telegram-Init-Data'] = TELEGRAM_INIT_DATA;
            }
            return fetch(url, options);
        }
        function getTelegramUser() {
            if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe){
                const user = Telegram.WebApp.initDataUnsafe.user;
                return {username: user?.username, firstName: user?.first_name};
            }
            return null;
        }
        function getTelegramUsername() {
            const u = getTelegramUser();
            return u?.username || u?.firstName || null;
        }
        function updateUsernameDisplay(){
            const el = document.getElementById('telegramUsername');
            let displayUsername = telegramUsername;
            if (isAdmin) {
                displayUsername = (displayUsername || "Admin") + "_admin";
            }
            if(displayUsername){
                let finalDisplay = displayUsername.startsWith("@") ? displayUsername : "@" + displayUsername;
                el.textContent = finalDisplay;
                el.style.display='block';
            } else {
                el.style.display='none';
            }
        }
        function updateAdminPanelVisibility() {
            const adminPanelBtn = document.getElementById('adminPanelBtn');
            if (adminPanelBtn) {
                adminPanelBtn.style.display = isAdmin ? 'block' : 'none';
            }
        }
        async function fetchMeAndStatus(){
            const connectionDot = document.getElementById("connectionDot");
            const connectionText = document.getElementById("connectionText");

            try{
                const r = await fetchWithAuth(`${SERVER_URL}/me`);

                let d;
                try {
                    d = await r.json();
                } catch (e) {
                    connectionDot.style.background="#d9534f";
                    connectionText.textContent="–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö";
                    telegramUsername = null; isAdmin = false; updateUsernameDisplay(); updateAdminPanelVisibility();
                    return;
                }

                if(d.status==="success" && d.user){
                    connectionDot.style.background="#28a745";
                    connectionText.textContent="–ü–æ–¥–∫–ª—é—á–µ–Ω–æ";
                    telegramUsername = d.user.username;
                    isAdmin = d.user.role === 'admin';
                    updateUsernameDisplay();
                    updateAdminPanelVisibility();
                } else {
                    connectionDot.style.background="#d9534f";
                    connectionText.textContent="–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω";
                    telegramUsername = null; isAdmin = false;
                    updateUsernameDisplay();
                    updateAdminPanelVisibility();
                }
            } catch {
                connectionDot.style.background="#d9534f";
                connectionText.textContent="–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è";
                telegramUsername = null; isAdmin = false; updateUsernameDisplay(); updateAdminPanelVisibility();
            }
        }

        async function handleBrowserLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            if (!username || !password) return alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å!');

            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.textContent = '–í—Ö–æ–¥...';

            const fd = new FormData();
            fd.append('username', username);
            fd.append('password', password);

            try {
                const r = await fetch(`${SERVER_URL}/login`, {
                    method: 'POST',
                    body: fd,
                    credentials: 'include'
                });

                if (r.ok) {
                    const d = await r.json();
                    if (d.status === 'success') {
                        await fetchMeAndStatus();
                        document.getElementById('loginForm').style.display='none';
                        initApp();
                       // loadMarkers();
                    } else {
                        alert(d.message || '–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
                    }
                } else {
                    const errorText = await r.text();
                    alert(`–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: –°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—Ç–∏–ª —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º ${r.status}. ${errorText.substring(0, 50)}...`);
                }

            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞:", e);
                alert('‚ùå –û—à–∏–±–∫–∞: –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏–ª–∏ –∞–¥—Ä–µ—Å.');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = '–í–æ–π—Ç–∏';
            }

        }

        function getInitData(){
            if(window.Telegram && Telegram.WebApp && Telegram.WebApp.initData){
                TELEGRAM_INIT_DATA = Telegram.WebApp.initData;
                telegramUsername = getTelegramUsername();
                document.getElementById('loginForm').style.display='none';
                initApp();
            } else {
                TELEGRAM_INIT_DATA = null;
                telegramUsername = null;
                document.getElementById('loginForm').style.display='flex';
                initApp();
            }
        }

        function compressImage(file, quality = 0.6, maxWidth = 800) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;

                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob(blob => {
                            if (blob) {
                                const compressedFile = new File([blob], file.name.replace(/\.(png|gif)$/i, '.jpeg'), {
                                    type: 'image/jpeg',
                                    lastModified: Date.now()
                                });
                                resolve(compressedFile);
                            } else {
                                reject(new Error('Canvas to Blob failed'));
                            }
                        }, 'image/jpeg', quality);
                    };

                    img.onerror = error => reject(error);
                };
                reader.onerror = error => reject(error);
            });
        }

        // =========================================================
        // –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        // =========================================================
        function initApp(){
            if(appInitialized) return;
            appInitialized = true;

            // --- HTML –≠–õ–ï–ú–ï–ù–¢–´ ---
            const popupWindow = document.getElementById('popupWindow');
            const popupClose = document.getElementById('popupClose');
            const noteInput = document.getElementById('noteInput');
            const breedInput = document.getElementById('breedInput');
            const pointObjectSelect = document.getElementById('pointObjectSelect');
            const markerColorSelect = document.getElementById('markerColor');
            const photoInput = document.getElementById('photoInput');
            const photoList = document.getElementById('photoList');
            const saveBtn = document.getElementById('saveBtn');
            const deleteBtn = document.getElementById('deleteBtn');
            const spinner = document.getElementById('spinner');
            const photoModal = document.getElementById('photoModal');
            const closePhotoModal = document.getElementById('closePhotoModal');
            const newPointBtn = document.getElementById('newPointBtn');
            const popupCoords = document.getElementById('popupCoords');
            const copyCoordsBtn = document.getElementById('copyCoordsBtn');
            const crosshair = document.getElementById('crosshair');
            const adminPanelBtn = document.getElementById('adminPanelBtn');
            const adminPanelWindow = document.getElementById('adminPanelWindow');
            const adminPanelClose = document.getElementById('adminPanelClose');
            const adminTabButtons = document.querySelectorAll('.adminTabButton');
            const usersTableBody = document.querySelector('#usersTable tbody');
            const createUserBtn = document.getElementById('createUserBtn');
            const userEditModal = document.getElementById('userEditModal');
            const userEditModalClose = document.getElementById('userEditModalClose');
            const userEditTitle = document.getElementById('userEditTitle');
            const saveUserBtn = document.getElementById('saveUserBtn');
            const editUserId = document.getElementById('editUserId');
            const editFullName = document.getElementById('editFullName');
            const editRole = document.getElementById('editRole');
            const editTelegramId = document.getElementById('editTelegramId');
            const editUsername = document.getElementById('editUsername');
            const editPassword = document.getElementById('editPassword');
            const editPhone = document.getElementById('editPhone');
            const editAdditionalInfo = document.getElementById('editAdditionalInfo');
            const newAccountFields = document.getElementById('newAccountFields');
            const optionalInfoFields = document.getElementById('optionalInfoFields');
            const deleteUserBtn = document.getElementById('deleteUserBtn');
            const objectsTableBody = document.querySelector('#objectsTable tbody');
            const createObjectBtn = document.getElementById('createObjectBtn');
            const objectEditModal = document.getElementById('objectEditModal');
            const objectEditModalClose = document.getElementById('objectEditModalClose');
            const objectEditTitle = document.getElementById('objectEditTitle');
            const saveObjectBtn = document.getElementById('saveObjectBtn');
            const deleteObjectBtn = document.getElementById('deleteObjectBtn');
            const editObjectId = document.getElementById('editObjectId');
            const editObjectName = document.getElementById('editObjectName');
            const editObjectInfo = document.getElementById('editObjectInfo');
            const assignmentWrap = document.getElementById('assignmentWrap');
            const assignmentTable = document.getElementById('assignment-table');
            let currentAssignments = new Set();

            const photoImage = document.getElementById('photoImage');
            const doodleCanvas = document.getElementById('doodleCanvas');
            const startDoodleBtn = document.getElementById('startDoodle');
            const saveDoodleBtn = document.getElementById('saveDoodle');
            const cancelDoodleBtn = document.getElementById('cancelDoodle');

let currentEditingImg = null;
let ctx, drawing = false;

// –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–µ–∂–∏–º –¥—É–¥–ª–∞
startDoodleBtn.onclick = () => {
    // –ù–∞—Å—Ç—Ä–æ–∏–º canvas –ø–æ —Ä–∞–∑–º–µ—Ä—É —Ñ–æ—Ç–æ
    doodleCanvas.width = photoImage.clientWidth;
    doodleCanvas.height = photoImage.clientHeight;
    doodleCanvas.style.display = 'block';

    ctx = doodleCanvas.getContext('2d');
    ctx.strokeStyle = "red";   // –¶–≤–µ—Ç —Ä–∏—Å–æ–≤–∞–Ω–∏—è
    ctx.lineWidth = 3;         // –¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–∏

    startDoodleBtn.style.display = 'none';
    saveDoodleBtn.style.display = 'inline-block';
    cancelDoodleBtn.style.display = 'inline-block';

    // –°–ª—É—à–∞–µ–º —Ä–∏—Å–æ–≤–∞–Ω–∏–µ
    doodleCanvas.onmousedown = (e) => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); };
    doodleCanvas.onmousemove = (e) => { if (drawing) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); }};
    doodleCanvas.onmouseup = () => drawing = false;
    doodleCanvas.onmouseleave = () => drawing = false;


// --- üì± –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ö–∞—Å–∞–Ω–∏—è (–ù–æ–≤—ã–π –∫–æ–¥) ---

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∫–∞—Å–∞–Ω–∏—è
    const getTouchPos = (e) => {
        // e.touches[0] - —ç—Ç–æ –ø–µ—Ä–≤–æ–µ –∫–∞—Å–∞–Ω–∏–µ
        const rect = doodleCanvas.getBoundingClientRect();
        return {
            x: e.touches[0].clientX - rect.left,
            y: e.touches[0].clientY - rect.top
        };
    };

    doodleCanvas.addEventListener('touchstart', (e) => {
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤–æ –≤—Ä–µ–º—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
        e.preventDefault();

        const pos = getTouchPos(e);
        drawing = true;
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
    }, { passive: false }); // { passive: false } –≤–∞–∂–µ–Ω –¥–ª—è preventDefault

    doodleCanvas.addEventListener('touchmove', (e) => {
        if (drawing) {
            const pos = getTouchPos(e);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
        }
    });

    doodleCanvas.addEventListener('touchend', () => {
        drawing = false;
    });

    doodleCanvas.addEventListener('touchcancel', () => {
        drawing = false;
    });

 ////////////////////////////////////////////////////////
};

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å —Ä–∏—Å—É–Ω–∫–æ–º
saveDoodleBtn.onclick = () => {
    const finalCanvas = document.createElement('canvas');
    finalCanvas.width = doodleCanvas.width;
    finalCanvas.height = doodleCanvas.height;
    const ctx = finalCanvas.getContext('2d');

    // –°–ª–æ—è–º–∏: –æ—Ä–∏–≥–∏–Ω–∞–ª + –¥—É–¥–ª
    ctx.drawImage(photoImage, 0, 0, finalCanvas.width, finalCanvas.height);
    ctx.drawImage(doodleCanvas, 0, 0);

    const dataUrl = finalCanvas.toDataURL('image/png');

    // –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–Ω—å—à–µ –º—ã –¥–µ–ª–∞–ª–∏ —Ç–æ–ª—å–∫–æ replace –≤ DOM, –∞ –Ω–∞–¥–æ –µ—â—ë –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ File üëá
    replacePhotoInList(currentEditingImg, dataUrl);
    resetDoodleCanvas();
    photoModal.style.display = 'none';
};

function resetDoodleCanvas() {
    doodleCanvas.style.display = 'none';
    doodleCanvas.getContext('2d').clearRect(0, 0, doodleCanvas.width, doodleCanvas.height);

    startDoodleBtn.style.display = 'inline-block';
    saveDoodleBtn.style.display = 'none';
    cancelDoodleBtn.style.display = 'none';

    currentEditingImg = null; // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—É—é –º–∏–Ω–∏–∞—Ç—é—Ä—É
}


// –û—Ç–º–µ–Ω–∏—Ç—å
cancelDoodleBtn.onclick = resetDoodle;

function resetDoodle() {
    doodleCanvas.style.display = 'none';
    doodleCanvas.getContext('2d').clearRect(0, 0, doodleCanvas.width, doodleCanvas.height);

    startDoodleBtn.style.display = 'inline-block';
    saveDoodleBtn.style.display = 'none';
    cancelDoodleBtn.style.display = 'none';
}


// --- 1. –§–£–ù–ö–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò –î–ê–ù–ù–´–• (–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ switchAdminTab) ---
async function loadAssignmentData() {
    // –í—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ, –ø–æ–∫–∞ –∂–¥–µ–º –æ—Ç–≤–µ—Ç–∞
    const bodyRows = document.getElementById('bodyRows');
    if (bodyRows) bodyRows.innerHTML = '<tr><td colspan="100">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>';

    try {
        const response = await fetchWithAuth(`${SERVER_URL}/assignments`);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.users && data.objects) {
            currentAssignments = new Set(data.assignments);
            renderAssignmentTable(data.users, data.objects, currentAssignments);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:', error);
        if (assignmentTable) assignmentTable.innerHTML = '<tbody><tr><td colspan="100">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π.</td></tr></tbody>';
    }
}


// --- 2. –§–£–ù–ö–¶–ò–Ø –û–¢–†–ï–°–û–í–ö–ò –¢–ê–ë–õ–ò–¶–´ ---
function renderAssignmentTable(users, objects, assignmentsSet) {
    const headerRow = document.getElementById('headerRow');
    const bodyRows = document.getElementById('bodyRows');

    // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ —Ç–µ–ª–æ
    headerRow.innerHTML = '<th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å \\ –û–±—ä–µ–∫—Ç</th>';
    bodyRows.innerHTML = '';

    // 1. –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ (–û–±—ä–µ–∫—Ç—ã)
    objects.forEach(obj => {
        const th = document.createElement('th');
        th.textContent = obj.name;
        th.title = `–û–±—ä–µ–∫—Ç ID: ${obj.id}`;
        th.dataset.objectId = obj.id;
        headerRow.appendChild(th);
    });

    // 2. –°—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)
    users.forEach(user => {
        const tr = document.createElement('tr');

        const displayName = user.full_name && user.full_name.trim() !== '' ? user.full_name : user.username;

        const firstCell = document.createElement('td');
        firstCell.innerHTML = `<strong>${displayName}</strong>`;
        firstCell.dataset.userId = user.id;
        tr.appendChild(firstCell);

        // –Ø—á–µ–π–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
        objects.forEach(obj => {
            const assignmentKey = `${user.id}_${obj.id}`;
            const isAssigned = assignmentsSet.has(assignmentKey);
            const cellClass = isAssigned ? 'assigned' : 'unassigned';

            const td = document.createElement('td');
            td.className = cellClass;
            td.dataset.userId = user.id;
            td.dataset.objectId = obj.id;
            td.onclick = handleAssignmentToggle;

            tr.appendChild(td);
        });
        bodyRows.appendChild(tr);
    });
}


// --- 3. –§–£–ù–ö–¶–ò–Ø –û–ë–†–ê–ë–û–¢–ö–ò –ö–õ–ò–ö–ê (–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è) ---
async function handleAssignmentToggle(event) {
    const cell = event.target;
    if (cell.tagName !== 'TD' || cell.cellIndex === 0) return;

    cell.style.pointerEvents = 'none';

    const userId = cell.dataset.userId;
    const objectId = cell.dataset.objectId;

    try {
        const response = await fetchWithAuth(`${SERVER_URL}/assignments/toggle`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId, object_id: objectId })
        });
        const data = await response.json();

        if (data.status === 'success') {
            const assignmentKey = `${userId}_${objectId}`;
            if (data.action === 'added') {
                cell.classList.remove('unassigned');
                cell.classList.add('assigned');
                currentAssignments.add(assignmentKey);
            } else {
                cell.classList.remove('assigned');
                cell.classList.add('unassigned');
                currentAssignments.delete(assignmentKey);
            }
        } else {
            alert(`–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è: ${data.message}`);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:', error);
        alert('–°–±–æ–π —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è.');
    } finally {
        cell.style.pointerEvents = 'auto';
    }
    refreshMarkers()
}


// --- 4. –õ–û–ì–ò–ö–ê –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–û–°–¢–ò (–ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∏ Drag-Scroll) ---

// –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫–∏ –∏ —Å—Ç–æ–ª–±—Ü–∞
assignmentTable.addEventListener('mousemove', e=>{
    assignmentTable.querySelectorAll('.col-hover').forEach(c=>c.classList.remove('col-hover'));
    assignmentTable.querySelectorAll('.row-hover').forEach(c=>c.classList.remove('row-hover'));

    const cell = e.target.closest('td, th');
    if(!cell) return;
    const colIndex = cell.cellIndex;
    const row = cell.parentElement;

    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–æ–ª–æ–Ω–∫–∏ (—Ç–µ–ª–æ –∏ —à–∞–ø–∫–∞, –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞)
    if(colIndex > 0){
        assignmentTable.querySelectorAll('tbody tr').forEach(r=>{
            const c = r.children[colIndex];
            if(c) c.classList.add('col-hover');
        });
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å—Ç–æ–ª–±—Ü–∞
        headerRow.children[colIndex].classList.add('col-hover');
    }

    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫–∏ (—Ç–æ–ª—å–∫–æ —Ç–µ–ª–æ)
    if(row.parentElement.tagName==='TBODY'){
        row.querySelectorAll('td').forEach(c => c.classList.add('row-hover'));
    }
});

assignmentTable.addEventListener('mouseleave', ()=>{
    assignmentTable.querySelectorAll('.col-hover').forEach(c=>c.classList.remove('col-hover'));
    assignmentTable.querySelectorAll('.row-hover').forEach(c=>c.classList.remove('row-hover'));
});

// –í—ã–¥–µ–ª–µ–Ω–∏–µ —è—á–µ–π–∫–∏ –∫–ª–∏–∫–æ–º (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ)
assignmentTable.addEventListener('click', e=>{
    if(e.target.tagName==='TD' && e.target.cellIndex !== 0){
        assignmentTable.querySelectorAll('td').forEach(x=>x.style.outline='');
        e.target.style.outline='2px solid rgba(11,105,255,0.25)';
    }
});

// Drag-scroll
let isDown=false, startX=0, startY=0, scrollLeft=0, scrollTop=0;

assignmentWrap.addEventListener('mousedown', e=>{
    const cell = e.target.closest('td, th');
    if(!cell) return;
    const row = cell.parentElement;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º –ø—Ä–æ–∫—Ä—É—Ç–∫–∏: –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π (—à–∞–ø–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤) –∏–ª–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π (–ø–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü)
    if(cell.tagName==='TH' && row.parentElement.tagName==='THEAD' && cell.cellIndex>0) {
        isDown = 'hor';
    } else if(cell.tagName==='TD' && cell.cellIndex===0) {
        isDown = 'ver';
    } else {
        isDown = false;
        return;
    }

    startX = e.pageX - assignmentWrap.offsetLeft;
    startY = e.pageY - assignmentWrap.offsetTop;
    scrollLeft = assignmentWrap.scrollLeft;
    scrollTop = assignmentWrap.scrollTop;
    assignmentWrap.style.cursor='grabbing';
});

assignmentWrap.addEventListener('mouseup', ()=>{ isDown=false; assignmentWrap.style.cursor='grab'; });
assignmentWrap.addEventListener('mouseleave', ()=>{ isDown=false; assignmentWrap.style.cursor='grab'; });

assignmentWrap.addEventListener('mousemove', e=>{
    if(!isDown) return;
    e.preventDefault();
    const x = e.pageX - assignmentWrap.offsetLeft;
    const y = e.pageY - assignmentWrap.offsetTop;
    if(isDown==='hor') assignmentWrap.scrollLeft = scrollLeft - (x - startX);
    if(isDown==='ver') assignmentWrap.scrollTop¬† = scrollTop¬† - (y - startY);
});

            // --- MAP INIT ---
            const defaultLat = parseFloat(params.get("lat")) || 54.1032;
            const defaultLon = parseFloat(params.get("lon")) || 28.3186;
            currentCenter={lat:defaultLat, lon:defaultLon};
            const map = L.map('map', { center:[defaultLat, defaultLon], zoom:12, attributionControl:false });
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            // –û–ë–ù–û–í–õ–ï–ù–ò–ï –¶–ï–ù–¢–†–ê: –û–±–Ω–æ–≤–ª—è–µ–º currentCenter –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –∫–∞—Ä—Ç—ã
            map.on('move',()=>{
                const c=map.getCenter();
                currentCenter={lat:c.lat, lon:c.lng};
            });

            // –°–ö–†–´–¢–ò–ï POPUP –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–∞—Ä—Ç—É
            map.on('click', () => {
                popupWindow.style.display = 'none';
            });

            // --- PERIODIC CHECK ---
            setInterval(fetchMeAndStatus, 60000);
            fetchMeAndStatus();

            // =========================================================
            // MAP & MARKER LOGIC
            // =========================================================

            function getIcon(color) {
                const urls={green:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                             red:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                             blue:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                             yellow:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png',
                             black:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-black.png'};
                return L.icon({iconUrl:urls[color]||urls.green, shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                                iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]});
            }

            function addMarkerToMap(entry){
                const idStr=String(entry.id);
                if(markersMap[idStr]) return;
                const marker=L.marker([entry.lat,entry.lon],{icon:getIcon(entry.color)}).addTo(map);
                marker.entryId=idStr;
                marker.on('click',()=>handleOpenMarkerPopup(idStr));

            const tooltipContent = `ID –º–µ—Ç–∫–∏: ${entry.id}<br>–û–±—ä–µ–∫—Ç: ${entry.object_name || '‚Äî'}`;
            marker.bindTooltip(tooltipContent, {
                permanent: false,   // –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
                direction: 'bottom',   // –≥–¥–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –º–∞—Ä–∫–µ—Ä–∞
                className: 'marker-tooltip' // –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π —Å—Ç–∏–ª—å
            });


                markersMap[idStr]=marker;
            }

            async function loadMarkers(){
                try{
                    const r = await fetchWithAuth(`${SERVER_URL}/markers`);
                    const d = await r.json();
                    if(d.status==='success') d.markers.forEach(addMarkerToMap);
                }catch(err){ console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–∞—Ä–∫–µ—Ä–æ–≤',err);}
            }

            async function refreshMarkers(){
                try{
                    const r = await fetchWithAuth(`${SERVER_URL}/markers`);
                    let d={status:'error', markers:[]};
                    try{ d = await r.json(); } catch(e){ return; }
                    if(d.status!=='success') return;
                    const serverIds=new Set(d.markers.map(m=>String(m.id)));

                    d.markers.forEach(m=>{
                        const idStr=String(m.id);
                        if(markersMap[idStr]){
                            markersMap[idStr].setLatLng([m.lat,m.lon]);
                            markersMap[idStr].setIcon(getIcon(m.color));
                        } else addMarkerToMap(m);
                    });

                    Object.keys(markersMap).forEach(id=>{
                        if(!serverIds.has(id) && id!==String(currentEntryId)){
                            map.removeLayer(markersMap[id]);
                            delete markersMap[id];
                        }
                    });
                }catch(err){console.error(err);}
            }

            // --- PHOTO & POPUP UTILITIES ---

// –í –≤–∞—à–µ–º <script>
async function fetchProtectedImage(filename) {
    const url = `${SERVER_URL}/photo/${filename}`;
    const initData = TELEGRAM_INIT_DATA || ''; // –ü–æ–ª—É—á–∞–µ–º initData, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ

    const options = {
        method: 'GET',
        headers: {},
        credentials: 'include' // üî• –í–ê–ñ–ù–û: –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É –∫—É–∫–∏ —Å–µ—Å—Å–∏–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
    };

    if (initData) {
        // üî• –î–ª—è Telegram Mini App: –≤—Ä—É—á–Ω—É—é –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        options.headers['X-Telegram-Init-Data'] = initData;
    }

    try {
        const response = await fetch(url, options);
        if (!response.ok) {
            console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${filename}: ${response.status} ${response.statusText}`);
            return null;
        }

        // –ü–æ–ª—É—á–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —Å–æ–∑–¥–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π URL
        const blob = await response.blob();
        return URL.createObjectURL(blob);
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ:", e);
        return null;
    }
}


function renderPhotoList() {
    photoList.innerHTML = '';

    // –ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–æ—Ç–æ (—Å —Å–µ—Ä–≤–µ—Ä–∞) –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –Ω–æ–≤—ã–µ (–ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã)
    const allPhotos = [
        ...existingPhotos.map((p, i) => ({filename: p.filename || p, isExisting: true, index: i})),
        ...selectedFiles.map((f, i) => ({file: f, isExisting: false, index: i}))
    ];

    allPhotos.forEach(p => {
    const div = document.createElement('div');
    div.className = 'photoItem';

    let imgUrl;
    let dataSrc = '';
    let isExisting = p.isExisting; // true –µ—Å–ª–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞, false –µ—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ

    if (isExisting) {
        imgUrl = ''; // –ü–æ–∫–∞ –∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å
        dataSrc = p.filename;
    } else {
        imgUrl = URL.createObjectURL(p.file);
    }

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID —Ñ–æ—Ç–æ (–ø–æ –∏–Ω–¥–µ–∫—Å—É –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º —Å–ø–∏—Å–∫–µ)
    const photoIndex = p.index;

    div.innerHTML = `
        <img src="${imgUrl}"
             data-index="${photoIndex}"
             data-is-existing="${isExisting}"
             data-full-src="${imgUrl}">
        <div class="removePhoto" data-index="${photoIndex}" data-is-existing="${isExisting}">√ó</div>
    `;

    photoList.appendChild(div);

    // üî• –¢–æ–ª—å–∫–æ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–æ—Ç–æ ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º –∑–∞—â–∏—â—ë–Ω–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    if (isExisting) {
        const imgElement = div.querySelector('img');
        fetchProtectedImage(p.filename)
            .then(localUrl => {
                if (localUrl) {
                    imgElement.src = localUrl;
                    imgElement.setAttribute('data-full-src', localUrl);
                } else {
                    imgElement.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 24 24" fill="none" stroke="red" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x-octagon"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
                }
            })
            .catch(error => console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ fetchProtectedImage:", error));
    }
});


    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
photoList.querySelectorAll('.removePhoto').forEach(btn => {
    btn.onclick = (e) => {
        e.stopPropagation();
        const index = parseInt(btn.dataset.index);
        const isExisting = btn.dataset.isExisting === 'true';

        if (isExisting) {
            existingPhotos.splice(index, 1);
        } else {
            selectedFiles.splice(index, 1);
        }

        renderPhotoList();
    };
});


    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
photoList.querySelectorAll('img').forEach(img => {
    img.onclick = (e) => {
        e.stopPropagation();

        const src = img.getAttribute('data-full-src') || img.src;
        if (!src || src.startsWith('data:image/svg')) return;

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º canvas –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –Ω–æ–≤–æ–π —Ñ–æ—Ç–æ
        resetDoodleCanvas();

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Ñ–æ—Ç–æ –¥–ª—è –¥—É–¥–ª–∞
        currentEditingImg = img;

        photoImage.src = src;
        photoModal.style.display = 'flex';
    };
});
}



function replacePhotoInList(imgElement, dataUrl) {
    const index = parseInt(imgElement.dataset.index);
    const isExisting = imgElement.dataset.isExisting === 'true';

    // –£–¥–∞–ª—è–µ–º —Ñ–æ—Ç–æ –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –º–∞—Å—Å–∏–≤–∞
    if (isExisting) {
        existingPhotos.splice(index, 1);
    } else {
        selectedFiles.splice(index, 1);
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–µ —Ñ–æ—Ç–æ
    const newFile = dataURLtoFile(dataUrl, `edited_${Date.now()}.png`);
    selectedFiles.push(newFile);

    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
    renderPhotoList();
}


function dataURLtoFile(dataurl, filename) {
    let arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1];
    let bstr = atob(arr[1]);
    let n = bstr.length;
    let u8arr = new Uint8Array(n);
    while(n--) {
        u8arr[n] = bstr.charCodeAt(n);
    }
    return new File([u8arr], filename, {type: mime});
}


function dataURLtoFile(dataurl, filename) {
    const arr = dataurl.split(',');
    const mime = arr[0].match(/:(.*?);/)[1];
    const bstr = atob(arr[1]);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    while(n--) u8arr[n] = bstr.charCodeAt(n);
    return new File([u8arr], filename, { type: mime });
}



            // =========================================================
            // MARKER POPUP HANDLERS
            // =========================================================

            async function loadObjectOptions() {
                pointObjectSelect.innerHTML = '<option value="">-- –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤... --</option>';

                try {
                    const r = await fetchWithAuth(`${SERVER_URL}/objects`);
                    const d = await r.json();

                    pointObjectSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç --</option>';

                    if (d.status === 'success' && d.objects) {
                        d.objects.forEach(obj => {
                            const option = document.createElement('option');
                            option.value = obj.id;
                            option.textContent = obj.name;
                            pointObjectSelect.appendChild(option);
                        });
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–±—ä–µ–∫—Ç–æ–≤:', e);
                    pointObjectSelect.innerHTML = '<option value="">-- –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ --</option>';
                }
            }

            async function loadMarkerData(pointId) {
                spinner.style.display = 'block';

                try {
                    const response = await fetchWithAuth(`${SERVER_URL}/marker/${pointId}`);
                    const data = await response.json();

                    if (data.status === 'success' && data.marker) {
                        const marker = data.marker;
                        popupCoords.textContent = `${marker.lat.toFixed(6)}, ${marker.lon.toFixed(6)}`;
                        document.getElementById('popupTitle').textContent = `–ú–µ—Ç–∫–∞ #${pointId}`;
                        noteInput.value = marker.note || '';
                        breedInput.value = marker.breed || '';

                        pointObjectSelect.value = marker.object_id || '';

                        markerColorSelect.value = marker.color || 'green';

                        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ photos - —ç—Ç–æ –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –∫–ª—é—á–æ–º 'filename'
                        existingPhotos = (marker.photos || []).map(p => {
                            if (typeof p === 'string') {
                                return { filename: p };
                            }
                            return p;
                        });

                        renderPhotoList();

                        map.setView([marker.lat, marker.lon], map.getZoom());

                        return true;
                    } else {
                        alert(data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –º–µ—Ç–∫–∏.');
                        return false;
                    }
                } catch(e) {
                    alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –º–µ—Ç–∫–∏.');
                    console.error("Load Marker Data Error:", e);
                    return false;
                } finally {
                    spinner.style.display = 'none';
                }
            }


            async function handleOpenMarkerPopup(pointId = null) {
                currentEntryId = pointId;
                selectedFiles = [];
                existingPhotos = [];
                document.getElementById('popupTitle').textContent = `–ú–µ—Ç–∫–∞ #`;
                noteInput.value = '';
                breedInput.value = '';
                markerColorSelect.value = 'green';
                photoInput.value = '';
                photoList.innerHTML = '';
                document.getElementById('copyCoordsBtn').textContent = COPY_SYMBOL;

                spinner.style.display = 'block';
                await loadObjectOptions();
                spinner.style.display = 'none';

                if (pointId) {
                    // –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –°–£–©–ï–°–¢–í–£–Æ–©–ï–ô –¢–û–ß–ö–ò

                    const success = await loadMarkerData(pointId);




                    if (!success) {
                        popupWindow.style.display = 'none';
                        return;
                    }

                    pointObjectSelect.disabled = true;
                    saveBtn.textContent = '–û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–∫—É';
                    deleteBtn.style.display = 'block';

                } else {
                    // –°–û–ó–î–ê–ù–ò–ï –ù–û–í–û–ô –¢–û–ß–ö–ò
                    const {lat, lon} = currentCenter;
                    popupCoords.textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;

                    pointObjectSelect.disabled = false;
                    pointObjectSelect.value = '';
                    saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                    deleteBtn.style.display = 'none';
                }


                popupWindow.style.display = 'block';

            }


            // =========================================================
            // POPUP BUTTON HANDLERS (–£–ë–†–ê–ù–´ –ê–õ–ï–†–¢–´ –£–°–ü–ï–•–ê –ò CONFIRM)
            // =========================================================

            // –ö–Ω–æ–ø–∫–∞ "–ù–æ–≤–∞—è —Ç–æ—á–∫–∞" —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ —Ü–µ–Ω—Ç—Ä–∞ –∫–∞—Ä—Ç—ã
            newPointBtn.onclick = () => handleOpenMarkerPopup(null);

 saveBtn.onclick = async () => {
    // 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ UX
    spinner.style.display = 'block';
    saveBtn.disabled = true;

    const isNew = currentEntryId === null;
    const selectedObjectId = pointObjectSelect.value;

    if (isNew && !selectedObjectId) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –û–±—ä–µ–∫—Ç –¥–ª—è –Ω–æ–≤–æ–π –º–µ—Ç–∫–∏.');
        saveBtn.disabled = false;
        spinner.style.display = 'none';
        return;
    }

    // 2. –°–∂–∞—Ç–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤
    const compressedFilesPromises = selectedFiles.map(file => compressImage(file));
    let compressedFiles = [];
    try {
        compressedFiles = await Promise.all(compressedFilesPromises);
    } catch (err) {
        spinner.style.display = 'none';
        saveBtn.disabled = false;
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∂–∞—Ç–∏–∏ —Ñ–æ—Ç–æ:', err);
        return alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π.');
    }

    // 3. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ FormData
    const fd = new FormData();
    fd.append('note', noteInput.value);
    fd.append('breed', breedInput.value);

    if (selectedObjectId) {
        fd.append('object_id', selectedObjectId);
    }

    fd.append('color', markerColorSelect.value);

    // --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –î–õ–Ø existing_photos ---
    if (!isNew) {
        // –ï—Å–ª–∏ –º–µ—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –º—ã –¥–æ–ª–∂–Ω—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è.

        if (existingPhotos.length > 0) {
            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –æ—Å—Ç–∞—Ç—å—Å—è, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏—Ö —Å–ø–∏—Å–æ–∫.
            fd.append('existing_photos', JSON.stringify(existingPhotos.map(p => p.filename)));
        } else {
            // –ï—Å–ª–∏ existingPhotos.length === 0, –∑–Ω–∞—á–∏—Ç, –≤—Å–µ —Å—Ç–∞—Ä—ã–µ —Ñ–æ—Ç–æ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã.
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π JSON-–º–∞—Å—Å–∏–≤ '[]', —á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä —è–≤–Ω–æ —É–¥–∞–ª–∏–ª –≤—Å–µ –∑–∞–ø–∏—Å–∏.
            fd.append('existing_photos', '[]');
        }
    }
    // –ï—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤–∞—è –º–µ—Ç–∫–∞ (isNew), 'existing_photos' –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤–æ–æ–±—â–µ.
    // ----------------------------------------------------

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
    compressedFiles.forEach(f => fd.append('photos[]', f));

    // 4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤–æ–π –º–µ—Ç–∫–∏)
    if (isNew) {
        const [lat, lon] = popupCoords.textContent.split(',').map(s => s.trim());
        if (!lat || !lon || lat === '‚Äî') {
            alert('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã. –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ –∫–∞—Ä—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
            saveBtn.disabled = false;
            spinner.style.display = 'none';
            return;
        }
        fd.append('lat', lat);
        fd.append('lon', lon);
    }

    // 5. –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
    const url = isNew ? `${SERVER_URL}/upload` : `${SERVER_URL}/marker/${currentEntryId}`;
    const method = 'POST';

    try {
        const r = await fetchWithAuth(url, { method: method, body: fd });

        if (!r.ok) {
            const errorData = await r.json().catch(() => ({ message: `HTTP Error: ${r.status}` }));
            alert(errorData.message || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${r.statusText}`);
            return;
        }

        const d = await r.json();

        if (d.status === 'success') {
            popupWindow.style.display = 'none';
            loadMarkers();
        } else {
            alert(d.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.');
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –º–µ—Ç–∫–∏.');
        console.error("Save Point Error:", e);
    } finally {
        // 6. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ UX
        spinner.style.display = 'none';
        saveBtn.disabled = false;
    }

    refreshMarkers()
};

            deleteBtn.onclick = async () => {
                if (!currentEntryId) return;

                try {
                    const r = await fetchWithAuth(`${SERVER_URL}/marker/${currentEntryId}`, { method: 'DELETE' });
                    const d = await r.json();
                    if (d.status === 'success') {
                        if (markersMap[currentEntryId]) { map.removeLayer(markersMap[currentEntryId]); delete markersMap[currentEntryId]; }
                        popupWindow.style.display = 'none';
                        selectedFiles = [];
                        existingPhotos = [];
                    } else alert(d.message);
                } catch (err) { console.error(err); alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏'); }
            };

            // --- GENERAL EVENT HANDLERS (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---

            photoInput.addEventListener('change', () => {
                selectedFiles = Array.from(photoInput.files);
                renderPhotoList();
            });

            popupClose.onclick = () => {
                popupWindow.style.display = 'none';
                currentEntryId = null;
            };

            closePhotoModal.onclick = () => photoModal.style.display = 'none';

            copyCoordsBtn.onclick = async () => {
                const coordsText = popupCoords.textContent;
                if (coordsText && coordsText !== '‚Äî') {
                    try {
                        await navigator.clipboard.writeText(coordsText);
                        copyCoordsBtn.textContent = COPIED_SYMBOL;
                        setTimeout(() => {
                            copyCoordsBtn.textContent = COPY_SYMBOL;
                        }, 1500);

                    } catch (err) {
                        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                        alert(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${coordsText}`);
                    }
                }
            };

            // --- LOGIN HANDLERS (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
            document.getElementById('loginBtn').onclick = async () => { await handleBrowserLogin(); };
            document.getElementById('loginUsername').addEventListener('keypress', (e) => { if (e.key === 'Enter') { handleBrowserLogin(); } });
            document.getElementById('loginPassword').addEventListener('keypress', (e) => { if (e.key === 'Enter') { handleBrowserLogin(); } });


            // =========================================================
            // ADMIN PANEL LOGIC (–£–ë–†–ê–ù–´ –ê–õ–ï–†–¢–´ –£–°–ü–ï–•–ê –ò CONFIRM)
            // =========================================================

            // --- USER LOGIC ---
            async function loadUsersTable() {
                if (!isAdmin) return;
                usersTableBody.innerHTML = '<tr><td colspan="2">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';

                try {
                    const r = await fetchWithAuth(`${SERVER_URL}/admin/users`);
                    const d = await r.json();

                    usersTableBody.innerHTML = '';
                    if (d.status === 'success' && d.users) {
                        d.users.forEach(user => {
                            const row = usersTableBody.insertRow();
                            row.onclick = () => openUserEditModal(user.id);
                            row.style.cursor = 'pointer';
                            row.innerHTML = `
                                <td>${user.full_name}</td>
                                <td>${user.role}</td>
                            `;
                        });
                    } else {
                        usersTableBody.innerHTML = `<tr><td colspan="2">${d.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π'}</td></tr>`;
                    }
                } catch (e) {
                    usersTableBody.innerHTML = '<tr><td colspan="2">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º</td></tr>';
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', e);
                }
            }

            async function openUserEditModal(userId = null) {
                editUserId.value = userId || '';
                editFullName.value = '';
                editRole.value = 'user';
                editTelegramId.value = '';
                editUsername.value = '';
                editPassword.value = '';
                editPhone.value = '';
                editAdditionalInfo.value = '';

                if (userId) {
                    userEditTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
                    newAccountFields.style.display = 'none';
                    optionalInfoFields.style.display = 'block';
                    deleteUserBtn.style.display = 'block';
                    try {
                        const r = await fetchWithAuth(`${SERVER_URL}/admin/user/${userId}`);
                        const d = await r.json();

                        if (d.status === 'success' && d.user) {
                            editFullName.value = d.user.full_name || '';
                            editRole.value = d.user.role;
                            editPhone.value = d.user.phone || '';
                            editAdditionalInfo.value = d.user.additional_info || '';
                        } else {
                            alert(d.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
                            userEditModal.style.display = 'none';
                            return;
                        }
                    } catch (e) {
                        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
                        userEditModal.style.display = 'none';
                        return;
                    }
                } else {
                    userEditTitle.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
                    newAccountFields.style.display = 'block';
                    optionalInfoFields.style.display = 'block';
                    deleteUserBtn.style.display = 'none';
                }

                userEditModal.style.display = 'flex';
            }

            saveUserBtn.onclick = async () => {
                const userId = editUserId.value;
                const url = userId ? `${SERVER_URL}/admin/user/${userId}` : `${SERVER_URL}/admin/user`;

                const data = {
                    full_name: editFullName.value.trim(),
                    role: editRole.value,
                    phone: editPhone.value.trim(),
                    additional_info: editAdditionalInfo.value.trim()
                };

                if (!data.full_name) {
                    alert('–ü–æ–ª–µ –§–ò–û –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.');
                    return;
                }

                if (!userId) {
                    data.telegram_id = editTelegramId.value.trim();
                    data.username = editUsername.value.trim();
                    data.password = editPassword.value.trim();

                    if (!(data.telegram_id || (data.username && data.password))) {
                        alert('–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å Telegram ID –ò–õ–ò Username –∏ Password.');
                        return;
                    }
                }

                try {
                    const r = await fetchWithAuth(url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });

                    if (!r.ok) {
                        const errorData = await r.json().catch(() => ({ message: `HTTP Error: ${r.status}` }));
                        alert(errorData.message || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${r.statusText}`);
                        return;
                    }

                    const d = await r.json();

                    if (d.status === 'success') {
                        userEditModal.style.display = 'none';
                        loadUsersTable();
                    } else {
                        alert(d.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.');
                    }
                } catch (e) {
                    alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.');
                    console.error("Save User Error:", e);
                }
            };

            deleteUserBtn.onclick = async () => {
                const userId = editUserId.value;

                if (!userId) return;

                try {
                    const url = `${SERVER_URL}/admin/user/${userId}`;
                    const r = await fetchWithAuth(url, { method: 'DELETE' });

                    if (!r.ok) {
                        const errorData = await r.json().catch(() => ({ message: `HTTP Error: ${r.status}` }));
                        alert(errorData.message || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${r.statusText}`);
                        return;
                    }

                    const d = await r.json();

                    if (d.status === 'success') {
                        userEditModal.style.display = 'none';
                        loadUsersTable();
                    } else {
                        alert(d.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è.');
                    }
                } catch (e) {
                    alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
                    console.error("Delete User Error:", e);
                }
            };

            createUserBtn.onclick = () => openUserEditModal();
            userEditModalClose.onclick = () => userEditModal.style.display = 'none';

            // --- OBJECT LOGIC ---
            async function loadObjectsTable() {
                if (!isAdmin) return;
                objectsTableBody.innerHTML = '<tr><td>–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';

                try {
                    const r = await fetchWithAuth(`${SERVER_URL}/admin/objects`);
                    const d = await r.json();

                    objectsTableBody.innerHTML = '';
                    if (d.status === 'success' && d.objects) {
                        d.objects.forEach(obj => {
                            const row = objectsTableBody.insertRow();
                            row.onclick = () => openObjectEditModal(obj.id);
                            row.style.cursor = 'pointer';
                            row.innerHTML = `<td>${obj.name}</td>`;
                        });

                        loadObjectOptions();

                    } else {
                        objectsTableBody.innerHTML = `<tr><td>${d.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä–µ–∫—Ç–æ–≤'}</td></tr>`;
                    }
                } catch (e) {
                    objectsTableBody.innerHTML = '<tr><td>–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º</td></tr>';
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–±—ä–µ–∫—Ç–æ–≤:', e);
                }
            }

            async function openObjectEditModal(objectId = null) {
                editObjectId.value = objectId || '';
                editObjectName.value = '';
                editObjectInfo.value = '';

                if (objectId) {
                    objectEditTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞';
                    deleteObjectBtn.style.display = 'block';
                    const objectPointsList = document.getElementById('objectPointsList');
                    objectPointsList.style.display = 'block';
                    try {
                        const r = await fetchWithAuth(`${SERVER_URL}/admin/object/${objectId}`);
                        const d = await r.json();

                        if (d.status === 'success' && d.object) {
                            editObjectName.value = d.object.name;
                            editObjectInfo.value = d.object.additional_info || '';
                        } else {
                            alert(d.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.');
                            objectEditModal.style.display = 'none';
                            return;
                        }
                    } catch (e) {
                        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–∞.');
                        objectEditModal.style.display = 'none';
                        return;
                    }
                } else {
                    objectEditTitle.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞';
                    deleteObjectBtn.style.display = 'none';
                    objectPointsList.style.display = 'none';
                }
                loadObjectPoints(objectId);
                objectEditModal.style.display = 'flex';


            }

            saveObjectBtn.onclick = async () => {
                const objectId = editObjectId.value;
                const url = objectId ? `${SERVER_URL}/admin/object/${objectId}` : `${SERVER_URL}/admin/object`;

                const data = {
                    name: editObjectName.value.trim(),
                    additional_info: editObjectInfo.value.trim()
                };

                if (!data.name) {
                    alert('–ü–æ–ª–µ "–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞" –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.');
                    return;
                }

                try {
                    const r = await fetchWithAuth(url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });

                    if (!r.ok) {
                        const errorData = await r.json().catch(() => ({ message: `HTTP Error: ${r.status}` }));
                        alert(errorData.message || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${r.statusText}`);
                        return;
                    }

                    const d = await r.json();

                    if (d.status === 'success') {
                        objectEditModal.style.display = 'none';
                        await loadObjectsTable();
                    } else {
                        alert(d.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.');
                    }
                } catch (e) {
                    alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–∞.');
                    console.error("Save Object Error:", e);
                }
            };

            deleteObjectBtn.onclick = async () => {
                const objectId = editObjectId.value;

                if (!objectId) return;

                try {
                    const url = `${SERVER_URL}/admin/object/${objectId}`;
                    const r = await fetchWithAuth(url, { method: 'DELETE' });

                    if (!r.ok) {
                        const errorData = await r.json().catch(() => ({ message: `HTTP Error: ${r.status}` }));
                        alert(errorData.message || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${r.statusText}`);
                        return;
                    }

                    const d = await r.json();

                    if (d.status === 'success') {
                        objectEditModal.style.display = 'none';
                        loadObjectsTable();
                    } else {
                        alert(d.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è.');
                    }
                } catch (e) {
                    alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞.');
                    console.error("Delete Object Error:", e);
                }
                refreshMarkers()
            };

            createObjectBtn.onclick = () => openObjectEditModal();
            objectEditModalClose.onclick = () => objectEditModal.style.display = 'none';




            // --- ADMIN PANEL GENERAL LOGIC (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
            function switchAdminTab(tabName) {
                const adminTabContentPanes = document.querySelectorAll('.adminTabContentPane');

                adminTabButtons.forEach(btn => {
                    btn.classList.remove('active');
                    btn.style.background = '#f4f4f4';
                    btn.style.borderBottom = 'none';
                });

                adminTabContentPanes.forEach(pane => {
                    pane.style.display = 'none';
                });

                const selectedButton = document.querySelector(`.adminTabButton[data-tab="${tabName}"]`);
                const selectedContent = document.getElementById(`tab-${tabName}`);

                if (selectedButton && selectedContent) {
                    selectedButton.classList.add('active');
                    selectedButton.style.background = 'white';

                    selectedContent.style.display = 'block';
                }
            }

            adminTabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabName = btn.getAttribute('data-tab');
                    switchAdminTab(tabName);

                    if (tabName === 'users') {
                        loadUsersTable();
                    } else if (tabName === 'objects') {
                        loadObjectsTable();
                    } else if (tabName === 'assignments') {
                        loadAssignmentData();
                    }
                });
            });

            adminPanelBtn.onclick = () => {
                if (isAdmin) {
                    adminPanelWindow.style.display = 'flex';
                    switchAdminTab('users');
                    loadUsersTable();
                } else {
                    alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.');
                }
            };
            adminPanelClose.onclick = () => {
                adminPanelWindow.style.display = 'none';
            };


async function loadObjectPoints(objectId) {
    try {
        const response = await fetchWithAuth(`${SERVER_URL}/markers/by-object/${objectId}`);
        const data = await response.json();

        const tbody = document.querySelector("#pointTable tbody");
        tbody.innerHTML = ""; // –æ—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π

        if (data.status === "success" && Array.isArray(data.markers) && data.markers.length > 0) {
            data.markers.forEach(marker => {
                const tr = document.createElement("tr");
                tr.style.cursor = "pointer";

                tr.innerHTML = `
                    <td style="padding: 6px; border-bottom: 1px solid #eee;">–ú–µ—Ç–∫–∞ #${marker.id}</td>
                `;

                // –ö–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–ø–∞–ø —Å –¥–∞–Ω–Ω—ã–º–∏ –º–µ—Ç–∫–∏
                tr.onclick = () => handleOpenMarkerPopup(marker.id);

                tbody.appendChild(tr);
            });
        } else {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td style="padding: 6px; text-align: center;">–ù–µ—Ç –º–µ—Ç–æ–∫</td>`;
            tbody.appendChild(tr);
        }
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç–æ–∫:", e);
        const tbody = document.querySelector("#pointTable tbody");
        tbody.innerHTML = `<tr><td style="padding: 6px; text-align: center;">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</td></tr>`;
    }
}




            // --- FINAL CALLS ---
            loadMarkers();
            setInterval(refreshMarkers, 30000);
        }


        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM ---
        document.addEventListener('DOMContentLoaded', getInitData);
    </script>
</body>
</html>
