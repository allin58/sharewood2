<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geo-Point App</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        /* –í–ê–®–ò –ò–ó–ù–ê–ß–ê–õ–¨–ù–´–ï –°–¢–ò–õ–´ + –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø */
        html, body {margin:0; padding:0; height:100%; font-family:sans-serif;}
        #map {height:100vh; width:100%;}
        #connectionStatus {position: fixed; top: 10px; right: 40px; z-index: 3000; display:flex; flex-direction:column; align-items:flex-end; font-size:14px; font-weight:bold; pointer-events:none; background:rgba(255,255,255,0.9); padding:8px 12px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.2);}
        #connectionStatusRow {display:flex; align-items:center;}
        #connectionDot {width:12px; height:12px; border-radius:50%; margin-right:6px; background:#d9534f;}
        #telegramUsername {font-size:12px; color:#666; margin-top:4px; font-weight:normal;}
        /* –û—Å–Ω–æ–≤–Ω–æ–π Popup –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –∑–∞–ø–æ–ª–Ω—è—è —ç–∫—Ä–∞–Ω */
        #popupWindow {position: fixed; top:80px; left:0; width:100%; height:calc(100% - 80px); z-index:2000; background:white; display:none; overflow-y:auto; padding:16px; box-sizing:border-box;}

        /* –°—Ç–∏–ª—å –∫—Ä–µ—Å—Ç–∏–∫–∞ - –≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º—ã–π */
        #crosshair {
            position:absolute; top:50%; left:50%; width:20px; height:20px;
            margin-left:-10px; margin-top:-10px; pointer-events:none; z-index:999;
            display: block; /* –í—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º */
        }
        #crosshair::before, #crosshair::after {content:''; position:absolute; background:black;}
        #crosshair::before {left:50%; top:0; width:2px; height:100%; margin-left:-1px;}
        #crosshair::after {top:50%; left:0; width:100%; height:2px; margin-top:-1px;}

        #newPointBtn {position:absolute; bottom:10px; left:50%; transform:translateX(-50%); z-index:1000; padding:8px 16px; border:none; border-radius:6px; background-color:#28a745; color:white; cursor:pointer;}
        #popupWindow label {display:block; margin-top:10px; font-weight:bold;}
        #popupWindow input[type="text"], #popupWindow textarea, #popupWindow input[type="file"], #popupWindow select {width:100%; padding:6px; margin-top:4px; box-sizing:border-box; border-radius:4px; border:1px solid #ccc; font-size:14px;}
        #popupWindow textarea {resize:vertical;}
        #photoList {margin-top:8px; max-height:150px; overflow-y:auto; display:flex; flex-wrap:wrap;}
        .photoItem {position:relative; margin:4px;}
        .photoItem img {width:70px; height:70px; object-fit:cover; border-radius:4px; cursor:pointer;}
        .removePhoto {position:absolute; top:-5px; right:-5px; background:red; color:white; border-radius:50%; width:18px; height:18px; text-align:center; line-height:18px; font-weight:bold; cursor:pointer;}
        #popupClose {position:absolute; top:10px; right:10px; font-size:24px; cursor:pointer;}
        #saveBtn, #deleteBtn {margin-top:12px; padding:8px 12px; border:none; border-radius:4px; background:#007bff; color:white; cursor:pointer; width:100%;}
        #deleteBtn {background:red; margin-top:6px;}
        #spinner {display:none; text-align:center; margin-top:10px;}
        .loader {border:4px solid #f3f3f3; border-top:4px solid #007bff; border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite; display:inline-block;}
        #photoModal {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:3000;}
        #photoModal img {max-width:90%; max-height:90%; border-radius:6px;}
        #photoModal span {position:absolute; top:20px; right:30px; font-size:30px; color:white; cursor:pointer;}
        @keyframes spin {0%{transform:rotate(0);}100%{transform:rotate(360deg);}}
        #loginForm {position:fixed; top:0; left:0; width:100%; height:100%; background:white; display:none; z-index:5000; justify-content:center; align-items:center; flex-direction:column;}
        #loginForm input {margin:4px 0; padding:6px; width:200px;}
        #loginForm button {padding:6px 12px; margin-top:8px;}

        /* –ê–î–ê–ü–¢–ê–¶–ò–Ø –∏ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –¥–ª—è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–Ω–µ–ª–∏ –∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
        .admin-modal-window {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7); z-index: 4000; justify-content: center; align-items: center;
        }
        .admin-modal-content {
            background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            max-width: 90%; max-height: 90%; overflow-y: auto; position: relative;
        }
        #adminPanelWindow .admin-modal-content { width: 700px; min-height: 400px; }
        #userEditModal .admin-modal-content, #objectEditModal .admin-modal-content { width: 350px; }
        .modal-close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #333; }

        /* –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–µ–π –≤ –∞–¥–º–∏–Ω-–æ–∫–Ω–∞—Ö */
        .admin-modal-content label { display: block; margin-top: 10px; font-weight: bold; font-size: 14px; }
        .admin-modal-content input[type="text"],
        .admin-modal-content input[type="password"],
        .admin-modal-content textarea,
        .admin-modal-content select {
            width: 100%; padding: 6px; margin-top: 4px; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc; font-size: 14px;
        }
        .admin-modal-content textarea { resize: vertical; }

        /* –ö–Ω–æ–ø–∫–∏ –≤ –∞–¥–º–∏–Ω–∫–µ */
        .admin-action-button {
            padding: 6px 10px; border: none; border-radius: 4px; background-color: #007bff; color: white;
            cursor: pointer; margin-bottom: 10px; font-size: 14px;
        }
        .admin-action-button:hover { background-color: #0056b3; }

        /* –í–∫–ª–∞–¥–∫–∏ –≤ –∞–¥–º–∏–Ω–∫–µ */
        .admin-tabs { display: flex; border-bottom: 2px solid #ccc; margin-bottom: 10px; }
        .adminTabButton {
            padding: 8px 12px; cursor: pointer; background: #f4f4f4; border-radius: 4px 4px 0 0;
            border: 1px solid #ccc; border-bottom: none; margin-bottom: -1px; margin-right: 5px; font-size: 14px;
        }
        .adminTabButton.active { background: white; border-bottom: 2px solid white; }
        .adminTabContentPane { display: none; padding-top: 5px; }
        .adminTabContentPane table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        .adminTabContentPane th, .adminTabContentPane td { padding: 6px; border: 1px solid #ccc; text-align: left; }
        .adminTabContentPane th { background-color: #f9f9f9; }

        /* –ê–¥–º–∏–Ω-–∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è */
        #deleteUserBtn, #deleteObjectBtn { background: red; margin-left: 10px; }

        /* --- –°—Ç–∏–ª–∏ –¥–ª—è –°–µ—Ç–∫–∏ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–π --- */

/* ... –í–ê–®–ò –ò–ó–ù–ê–ß–ê–õ–¨–ù–´–ï –°–¢–ò–õ–´ ... */

/* --- –ù–û–í–´–ï/–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –°–ï–¢–ö–ò –ù–ê–ó–ù–ê–ß–ï–ù–ò–ô --- */

:root{
    --cell-size: 48px;
    --grid-gap-color: #d0d7de;
    --line-size: 1px;
    --header-bg: #f7fafc;
    --firstcol-bg: #f7fafc;
    --accent: #0b69ff;
    /* font-family —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω –≤ –Ω–∞—á–∞–ª–µ */
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–∞–±–ª–∏—Ü—ã */
.table-wrap{
    border:1px solid #e2e8f0;
    overflow:auto; /* –†–∞–∑—Ä–µ—à–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É */
    max-height:60vh;
    max-width:100%;
    position:relative;
    cursor:grab;

    /* –°–∫—Ä—ã—Ç–∏–µ –ø–æ–ª–æ—Å –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
    -ms-overflow-style: none; /* IE –∏ Edge */
    scrollbar-width: none;  /* Firefox */
}
.table-wrap::-webkit-scrollbar { display: none; } /* Chrome, Safari */

table{
    border-collapse:separate; /* –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è border-spacing */
    border-spacing:0;
    width:max-content;
    min-width:100%;
}

/* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ —è—á–µ–µ–∫ */
#assignment-table th, #assignment-table td{
    width:var(--cell-size);
    height:var(--cell-size);
    min-width:var(--cell-size);
    min-height:var(--cell-size);
    padding:6px 8px;
    box-sizing:border-box;
    text-align:left;
    vertical-align:middle;
    border-right: var(--line-size) solid var(--grid-gap-color);
    border-bottom: var(--line-size) solid var(--grid-gap-color);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;

    /* –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–µ—Ç–æ–∫ */
    cursor: pointer;
    background-color: #e9ecef; /* –§–æ–Ω –¥–ª—è –Ω–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–π –∫–ª–µ—Ç–∫–∏ */
    transition: background-color 0.2s;
}

/* –£–≥–ª–æ–≤–∞—è —è—á–µ–π–∫–∞ */
#assignment-table thead th:first-child{
    position: sticky;
    top:0;
    left:0;
    background: var(--header-bg);
    z-index: 5; /* –°–∞–º—ã–π –≤—ã—Å–æ–∫–∏–π */
}

/* –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ (–û–±—ä–µ–∫—Ç—ã) */
#assignment-table thead th:not(:first-child){
    position: sticky;
    top:0;
    background: var(--header-bg);
    z-index: 4;
    text-align:center;
    font-weight:700;
}

/* –ü–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏) */
#assignment-table tbody td:first-child{
    position: sticky;
    left:0;
    background: var(--firstcol-bg);
    z-index: 3;
    box-shadow:2px 0 4px rgba(0,0,0,0.04);
    cursor: default; /* –ù–µ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è */
    font-weight: bold;
}

/* –û—Å—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–∫–ª–µ—Ç–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è) */
#assignment-table tbody td:not(:first-child){
    position: relative;
    z-index:1;
}

/* --- –°–¢–ò–õ–ò –ü–û–î–°–í–ï–¢–ö–ò –ò –ù–ê–ó–ù–ê–ß–ï–ù–ò–Ø --- */

/* –ö–ª–∞—Å—Å "–Ω–∞–∑–Ω–∞—á–µ–Ω–æ" */
.assigned {
    background-color: #28a745 !important; /* –ó–µ–ª–µ–Ω—ã–π */
    color: white;
}
.unassigned {
    background-color: #e9ecef; /* –°–µ—Ä—ã–π */
}

/* üî• –ù–û–í–û–ï –ü–†–ê–í–ò–õ–û: –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–∞—è —è—á–µ–π–∫–∞ –Ω–µ —Ç–µ—Ä—è–µ—Ç —Ü–≤–µ—Ç –ø—Ä–∏ –ø–æ–¥—Å–≤–µ—Ç–∫–µ —Å—Ç–æ–ª–±—Ü–∞ –∏–ª–∏ —Å—Ç—Ä–æ–∫–∏ */
.assigned.col-hover,
.assigned.row-hover {
    background-color: #28a745 !important; /* –ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π —Ü–≤–µ—Ç –≤—Å–µ–≥–¥–∞ –≤—ã–∏–≥—Ä—ã–≤–∞–µ—Ç */
    color: white !important;
}

/* üî• –ù–û–í–û–ï –ü–†–ê–í–ò–õ–û: –Ø—á–µ–π–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ (–≤—ã–¥–µ–ª–µ–Ω–∏–∏) –¥–æ–ª–∂–Ω–∞ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–≤–æ–π —Ñ–æ–Ω, –Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–º–∫—É */
#assignment-table td:not(:first-child) {
    /* –°–±—Ä–æ—Å outline, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –∑–∞–¥–∞–Ω inline —Å—Ç–∏–ª–µ–º */
    outline: none !important;
}

/* --- –°–¢–ò–õ–ò –ü–û–î–°–í–ï–¢–ö–ò --- */

.col-hover {background-color: rgba(11,105,255,0.08) !important;}
.row-hover {background-color: rgba(11,105,255,0.08) !important;}

/* –°–±—Ä–æ—Å –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —è—á–µ–µ–∫ */
.col-hover:first-child, .row-hover:first-child {background-color: var(--firstcol-bg) !important;}
#assignment-table thead th:first-child.col-hover {background-color: var(--header-bg) !important;}

/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
#assignment-table tbody tr:hover td:not(:first-child){background-color:rgba(11,105,255,0.03);}
/* –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ–Ω –ø–µ—Ä–≤–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ —Å—Ç—Ä–æ–∫—É */
#assignment-table tbody tr:hover td:first-child{background-color: var(--firstcol-bg) !important;}


    </style>
</head>
<body>

    <div id="map"></div>

    <div id="crosshair"></div>

    <div id="spinner"><div class="loader"></div></div>

    <div id="connectionStatus">
        <div id="connectionStatusRow">
            <div id="connectionDot"></div>
            <div id="connectionText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        <div id="telegramUsername"></div>
    </div>

    <button id="newPointBtn">‚ûï –ù–æ–≤–∞—è —Ç–æ—á–∫–∞</button>
    <button id="adminPanelBtn" class="admin-action-button" style="display:none; background-color: #6c757d; position:absolute; bottom:55px; left:50%; transform:translateX(-50%); z-index:1000;">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</button>


    <div id="loginForm">
        <h3>–í—Ö–æ–¥</h3>
        <input type="text" id="loginUsername" placeholder="–õ–æ–≥–∏–Ω (Username)" required>
        <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" required>
        <button id="loginBtn">–í–æ–π—Ç–∏</button>
    </div>

    <div id="popupWindow">
        <span id="popupClose">&times;</span>
        <h3>–î–µ—Ç–∞–ª–∏ –º–µ—Ç–∫–∏</h3>

        <div class="form-group">
            <label>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</label>
            <div style="display: flex; align-items: center; border: 1px solid #ccc; padding: 6px; border-radius: 4px;">
                <span id="popupCoords" style="flex-grow: 1;">‚Äî</span>
                <button id="copyCoordsBtn" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å" style="background: none; color: #007bff; border: none; cursor: pointer; padding: 0 5px; font-size: 14px;">üìã</button>
            </div>
        </div>

        <div class="form-group">
            <label for="pointObjectSelect">–û–±—ä–µ–∫—Ç (*):</label>
            <select id="pointObjectSelect" required>
                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç --</option>
            </select>
        </div>

        <div class="form-group">
            <label for="noteInput">–ó–∞–º–µ—Ç–∫–∞:</label>
            <textarea id="noteInput" rows="3"></textarea>
        </div>

        <div class="form-group">
            <label for="breedInput">–ü–æ—Ä–æ–¥–∞ / –¢–∏–ø:</label>
            <input type="text" id="breedInput">
        </div>

        <div class="form-group">
            <label for="markerColor">–¶–≤–µ—Ç –º–µ—Ç–∫–∏:</label>
            <select id="markerColor">
                <option value="green">–ó–µ–ª–µ–Ω—ã–π</option>
                <option value="blue">–°–∏–Ω–∏–π</option>
                <option value="red">–ö—Ä–∞—Å–Ω—ã–π</option>
                <option value="yellow">–ñ–µ–ª—Ç—ã–π</option>
                <option value="black">–ß–µ—Ä–Ω—ã–π</option>
            </select>
        </div>

        <div class="form-group">
            <label for="photoInput">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏:</label>
            <input type="file" id="photoInput" accept="image/*" multiple>
            <div id="photoList"></div>
        </div>

        <div style="display: flex; gap: 10px;">
            <button id="saveBtn" style="flex-grow: 1;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="deleteBtn" style="width: auto; flex-grow: 1; margin-top: 12px; display:none;">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>

    <div id="photoModal">
        <span id="closePhotoModal">&times;</span>
        <img src="" alt="Full Photo">
    </div>

    <div id="adminPanelWindow" class="admin-modal-window">
        <div class="admin-modal-content">
            <span id="adminPanelClose" class="modal-close-btn">&times;</span>
            <h3>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>

            <div class="admin-tabs">
                <div class="adminTabButton active" data-tab="users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
                <div class="adminTabButton" data-tab="objects">–û–±—ä–µ–∫—Ç—ã</div>
                <div class="adminTabButton" data-tab="assignments">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</div>
            </div>

            <div id="tab-users" class="adminTabContentPane" style="display: block;">
                <button id="createUserBtn" class="admin-action-button" style="background-color: #28a745;">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
                <h4>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</h4>
                <table id="usersTable">
                    <thead>
                        <tr><th>–§–ò–û</th><th>–†–æ–ª—å</th></tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="2">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>

            <div id="tab-objects" class="adminTabContentPane">
                <button id="createObjectBtn" class="admin-action-button" style="background-color: #28a745;">‚ûï –°–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç</button>
                <h4>–°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤:</h4>
                <table id="objectsTable">
                    <thead>
                        <tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>

            <div id="tab-assignments" class="adminTabContentPane">
                <h4>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:</h4>

                <div class="table-wrap" id="assignmentWrap">
                    <table id="assignment-table" aria-label="–¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –æ–±—ä–µ–∫—Ç–æ–≤">
                        <thead>
                            <tr id="headerRow">
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å \ –û–±—ä–µ–∫—Ç</th>
                            </tr>
                        </thead>
                        <tbody id="bodyRows">
                            <tr><td colspan="100">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <div id="userEditModal" class="admin-modal-window">
        <div class="admin-modal-content">
            <span id="userEditModalClose" class="modal-close-btn">&times;</span>
            <h3 id="userEditTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            <input type="hidden" id="editUserId">

            <label for="editFullName">–§–ò–û (*):</label>
            <input type="text" id="editFullName" required>

            <label for="editRole">–†–æ–ª—å:</label>
            <select id="editRole">
                <option value="user">user</option>
                <option value="admin">admin</option>
            </select>

            <div id="newAccountFields" style="border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 10px;">
                <label style="font-size: 12px; font-weight: normal;">–î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞ (–∑–∞–ø–æ–ª–Ω–∏—Ç—å –ò–õ–ò Telegram ID):</label>
                <input type="text" id="editUsername" placeholder="Username">
                <input type="password" id="editPassword" placeholder="–ü–∞—Ä–æ–ª—å">
                <input type="text" id="editTelegramId" placeholder="Telegram ID">
            </div>

            <div id="optionalInfoFields">
                <label for="editPhone">–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                <input type="text" id="editPhone">
                <label for="editAdditionalInfo">–î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</label>
                <textarea id="editAdditionalInfo" rows="2"></textarea>
            </div>

            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button id="saveUserBtn" class="admin-action-button" style="flex-grow: 1;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button id="deleteUserBtn" class="admin-action-button" style="display: none;">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="objectEditModal" class="admin-modal-window">
        <div class="admin-modal-content">
            <span id="objectEditModalClose" class="modal-close-btn">&times;</span>
            <h3 id="objectEditTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞</h3>
            <input type="hidden" id="editObjectId">

            <label for="editObjectName">–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ (*):</label>
            <input type="text" id="editObjectName" required>

            <label for="editObjectInfo">–î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</label>
            <textarea id="editObjectInfo" rows="3"></textarea>

            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button id="saveObjectBtn" class="admin-action-button" style="flex-grow: 1;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button id="deleteObjectBtn" class="admin-action-button" style="display: none;">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        // =========================================================
        // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
        // =========================================================
        const SERVER_URL = "https://a8bddfc0cecf.ngrok-free.app";
        let TELEGRAM_INIT_DATA = null;
        let telegramUsername = null;
        let isAdmin = false;
        let appInitialized = false;
        const params = new URLSearchParams(window.location.search);
        let currentEntryId = null;
        let selectedFiles = [];
        let existingPhotos = [];
        let markersMap = {};
        let currentCenter = {lat: 54.1032, lon: 28.3186};

        const COPY_SYMBOL = 'üìã';
        const COPIED_SYMBOL = '‚úîÔ∏è';

        // =========================================================
        // –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø –ò –£–¢–ò–õ–ò–¢–´ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        // =========================================================
        async function fetchWithAuth(url, options={}) {
            options = options || {};
            options.credentials = 'include';
            options.headers = options.headers || {};
            if(TELEGRAM_INIT_DATA){
                options.headers['X-Telegram-Init-Data'] = TELEGRAM_INIT_DATA;
            }
            return fetch(url, options);
        }
        function getTelegramUser() {
            if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe){
                const user = Telegram.WebApp.initDataUnsafe.user;
                return {username: user?.username, firstName: user?.first_name};
            }
            return null;
        }
        function getTelegramUsername() {
            const u = getTelegramUser();
            return u?.username || u?.firstName || null;
        }
        function updateUsernameDisplay(){
            const el = document.getElementById('telegramUsername');
            let displayUsername = telegramUsername;
            if (isAdmin) {
                displayUsername = (displayUsername || "Admin") + "_admin";
            }
            if(displayUsername){
                let finalDisplay = displayUsername.startsWith("@") ? displayUsername : "@" + displayUsername;
                el.textContent = finalDisplay;
                el.style.display='block';
            } else {
                el.style.display='none';
            }
        }
        function updateAdminPanelVisibility() {
            const adminPanelBtn = document.getElementById('adminPanelBtn');
            if (adminPanelBtn) {
                adminPanelBtn.style.display = isAdmin ? 'block' : 'none';
            }
        }
        async function fetchMeAndStatus(){
            const connectionDot = document.getElementById("connectionDot");
            const connectionText = document.getElementById("connectionText");

            try{
                const r = await fetchWithAuth(`${SERVER_URL}/me`);

                let d;
                try {
                    d = await r.json();
                } catch (e) {
                    connectionDot.style.background="#d9534f";
                    connectionText.textContent="–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö";
                    telegramUsername = null; isAdmin = false; updateUsernameDisplay(); updateAdminPanelVisibility();
                    return;
                }

                if(d.status==="success" && d.user){
                    connectionDot.style.background="#28a745";
                    connectionText.textContent="–ü–æ–¥–∫–ª—é—á–µ–Ω–æ";
                    telegramUsername = d.user.username;
                    isAdmin = d.user.role === 'admin';
                    updateUsernameDisplay();
                    updateAdminPanelVisibility();
                } else {
                    connectionDot.style.background="#d9534f";
                    connectionText.textContent="–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω";
                    telegramUsername = null; isAdmin = false;
                    updateUsernameDisplay();
                    updateAdminPanelVisibility();
                }
            } catch {
                connectionDot.style.background="#d9534f";
                connectionText.textContent="–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è";
                telegramUsername = null; isAdmin = false; updateUsernameDisplay(); updateAdminPanelVisibility();
            }
        }

        async function handleBrowserLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            if (!username || !password) return alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å!');

            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.textContent = '–í—Ö–æ–¥...';

            const fd = new FormData();
            fd.append('username', username);
            fd.append('password', password);

            try {
                const r = await fetch(`${SERVER_URL}/login`, {
                    method: 'POST',
                    body: fd,
                    credentials: 'include'
                });

                if (r.ok) {
                    const d = await r.json();
                    if (d.status === 'success') {
                        await fetchMeAndStatus();
                        document.getElementById('loginForm').style.display='none';
                        initApp();
                    } else {
                        alert(d.message || '–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
                    }
                } else {
                    const errorText = await r.text();
                    alert(`–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: –°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—Ç–∏–ª —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º ${r.status}. ${errorText.substring(0, 50)}...`);
                }

            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞:", e);
                alert('‚ùå –û—à–∏–±–∫–∞: –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏–ª–∏ –∞–¥—Ä–µ—Å.');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = '–í–æ–π—Ç–∏';
            }
        }

        function getInitData(){
            if(window.Telegram && Telegram.WebApp && Telegram.WebApp.initData){
                TELEGRAM_INIT_DATA = Telegram.WebApp.initData;
                telegramUsername = getTelegramUsername();
                document.getElementById('loginForm').style.display='none';
                initApp();
            } else {
                TELEGRAM_INIT_DATA = null;
                telegramUsername = null;
                document.getElementById('loginForm').style.display='flex';
                initApp();
            }
        }

        function compressImage(file, quality = 0.6, maxWidth = 800) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;

                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob(blob => {
                            if (blob) {
                                const compressedFile = new File([blob], file.name.replace(/\.(png|gif)$/i, '.jpeg'), {
                                    type: 'image/jpeg',
                                    lastModified: Date.now()
                                });
                                resolve(compressedFile);
                            } else {
                                reject(new Error('Canvas to Blob failed'));
                            }
                        }, 'image/jpeg', quality);
                    };

                    img.onerror = error => reject(error);
                };
                reader.onerror = error => reject(error);
            });
        }

        // =========================================================
        // –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        // =========================================================
        function initApp(){
            if(appInitialized) return;
            appInitialized = true;

            // --- HTML –≠–õ–ï–ú–ï–ù–¢–´ ---
            const popupWindow = document.getElementById('popupWindow');
            const popupClose = document.getElementById('popupClose');
            const noteInput = document.getElementById('noteInput');
            const breedInput = document.getElementById('breedInput');
            const pointObjectSelect = document.getElementById('pointObjectSelect');
            const markerColorSelect = document.getElementById('markerColor');
            const photoInput = document.getElementById('photoInput');
            const photoList = document.getElementById('photoList');
            const saveBtn = document.getElementById('saveBtn');
            const deleteBtn = document.getElementById('deleteBtn');
            const spinner = document.getElementById('spinner');
            const photoModal = document.getElementById('photoModal');
            const closePhotoModal = document.getElementById('closePhotoModal');
            const newPointBtn = document.getElementById('newPointBtn');
            const popupCoords = document.getElementById('popupCoords');
            const copyCoordsBtn = document.getElementById('copyCoordsBtn');
            const crosshair = document.getElementById('crosshair');
            const adminPanelBtn = document.getElementById('adminPanelBtn');
            const adminPanelWindow = document.getElementById('adminPanelWindow');
            const adminPanelClose = document.getElementById('adminPanelClose');
            const adminTabButtons = document.querySelectorAll('.adminTabButton');
            const usersTableBody = document.querySelector('#usersTable tbody');
            const createUserBtn = document.getElementById('createUserBtn');
            const userEditModal = document.getElementById('userEditModal');
            const userEditModalClose = document.getElementById('userEditModalClose');
            const userEditTitle = document.getElementById('userEditTitle');
            const saveUserBtn = document.getElementById('saveUserBtn');
            const editUserId = document.getElementById('editUserId');
            const editFullName = document.getElementById('editFullName');
            const editRole = document.getElementById('editRole');
            const editTelegramId = document.getElementById('editTelegramId');
            const editUsername = document.getElementById('editUsername');
            const editPassword = document.getElementById('editPassword');
            const editPhone = document.getElementById('editPhone');
            const editAdditionalInfo = document.getElementById('editAdditionalInfo');
            const newAccountFields = document.getElementById('newAccountFields');
            const optionalInfoFields = document.getElementById('optionalInfoFields');
            const deleteUserBtn = document.getElementById('deleteUserBtn');
            const objectsTableBody = document.querySelector('#objectsTable tbody');
            const createObjectBtn = document.getElementById('createObjectBtn');
            const objectEditModal = document.getElementById('objectEditModal');
            const objectEditModalClose = document.getElementById('objectEditModalClose');
            const objectEditTitle = document.getElementById('objectEditTitle');
            const saveObjectBtn = document.getElementById('saveObjectBtn');
            const deleteObjectBtn = document.getElementById('deleteObjectBtn');
            const editObjectId = document.getElementById('editObjectId');
            const editObjectName = document.getElementById('editObjectName');
            const editObjectInfo = document.getElementById('editObjectInfo');
            const assignmentWrap = document.getElementById('assignmentWrap');
            const assignmentTable = document.getElementById('assignment-table');
            let currentAssignments = new Set();



// --- 1. –§–£–ù–ö–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò –î–ê–ù–ù–´–• (–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ switchAdminTab) ---
async function loadAssignmentData() {
    // –í—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ, –ø–æ–∫–∞ –∂–¥–µ–º –æ—Ç–≤–µ—Ç–∞
    const bodyRows = document.getElementById('bodyRows');
    if (bodyRows) bodyRows.innerHTML = '<tr><td colspan="100">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>';

    try {
        const response = await fetchWithAuth(`${SERVER_URL}/assignments`);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.users && data.objects) {
            currentAssignments = new Set(data.assignments);
            renderAssignmentTable(data.users, data.objects, currentAssignments);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:', error);
        if (assignmentTable) assignmentTable.innerHTML = '<tbody><tr><td colspan="100">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π.</td></tr></tbody>';
    }
}


// --- 2. –§–£–ù–ö–¶–ò–Ø –û–¢–†–ï–°–û–í–ö–ò –¢–ê–ë–õ–ò–¶–´ ---
function renderAssignmentTable(users, objects, assignmentsSet) {
    const headerRow = document.getElementById('headerRow');
    const bodyRows = document.getElementById('bodyRows');

    // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ —Ç–µ–ª–æ
    headerRow.innerHTML = '<th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å \\ –û–±—ä–µ–∫—Ç</th>';
    bodyRows.innerHTML = '';

    // 1. –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ (–û–±—ä–µ–∫—Ç—ã)
    objects.forEach(obj => {
        const th = document.createElement('th');
        th.textContent = obj.name;
        th.title = `–û–±—ä–µ–∫—Ç ID: ${obj.id}`;
        th.dataset.objectId = obj.id;
        headerRow.appendChild(th);
    });

    // 2. –°—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)
    users.forEach(user => {
        const tr = document.createElement('tr');

        const displayName = user.full_name && user.full_name.trim() !== '' ? user.full_name : user.username;

        const firstCell = document.createElement('td');
        firstCell.innerHTML = `<strong>${displayName}</strong>`;
        firstCell.dataset.userId = user.id;
        tr.appendChild(firstCell);

        // –Ø—á–µ–π–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
        objects.forEach(obj => {
            const assignmentKey = `${user.id}_${obj.id}`;
            const isAssigned = assignmentsSet.has(assignmentKey);
            const cellClass = isAssigned ? 'assigned' : 'unassigned';

            const td = document.createElement('td');
            td.className = cellClass;
            td.dataset.userId = user.id;
            td.dataset.objectId = obj.id;
            td.onclick = handleAssignmentToggle;

            tr.appendChild(td);
        });
        bodyRows.appendChild(tr);
    });
}


// --- 3. –§–£–ù–ö–¶–ò–Ø –û–ë–†–ê–ë–û–¢–ö–ò –ö–õ–ò–ö–ê (–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è) ---
async function handleAssignmentToggle(event) {
    const cell = event.target;
    if (cell.tagName !== 'TD' || cell.cellIndex === 0) return;

    cell.style.pointerEvents = 'none';

    const userId = cell.dataset.userId;
    const objectId = cell.dataset.objectId;

    try {
        const response = await fetchWithAuth(`${SERVER_URL}/assignments/toggle`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId, object_id: objectId })
        });
        const data = await response.json();

        if (data.status === 'success') {
            const assignmentKey = `${userId}_${objectId}`;
            if (data.action === 'added') {
                cell.classList.remove('unassigned');
                cell.classList.add('assigned');
                currentAssignments.add(assignmentKey);
            } else {
                cell.classList.remove('assigned');
                cell.classList.add('unassigned');
                currentAssignments.delete(assignmentKey);
            }
        } else {
            alert(`–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è: ${data.message}`);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:', error);
        alert('–°–±–æ–π —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è.');
    } finally {
        cell.style.pointerEvents = 'auto';
    }
}


// --- 4. –õ–û–ì–ò–ö–ê –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–û–°–¢–ò (–ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∏ Drag-Scroll) ---

// –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫–∏ –∏ —Å—Ç–æ–ª–±—Ü–∞
assignmentTable.addEventListener('mousemove', e=>{
    assignmentTable.querySelectorAll('.col-hover').forEach(c=>c.classList.remove('col-hover'));
    assignmentTable.querySelectorAll('.row-hover').forEach(c=>c.classList.remove('row-hover'));

    const cell = e.target.closest('td, th');
    if(!cell) return;
    const colIndex = cell.cellIndex;
    const row = cell.parentElement;

    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–æ–ª–æ–Ω–∫–∏ (—Ç–µ–ª–æ –∏ —à–∞–ø–∫–∞, –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞)
    if(colIndex > 0){
        assignmentTable.querySelectorAll('tbody tr').forEach(r=>{
            const c = r.children[colIndex];
            if(c) c.classList.add('col-hover');
        });
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å—Ç–æ–ª–±—Ü–∞
        headerRow.children[colIndex].classList.add('col-hover');
    }

    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫–∏ (—Ç–æ–ª—å–∫–æ —Ç–µ–ª–æ)
    if(row.parentElement.tagName==='TBODY'){
        row.querySelectorAll('td').forEach(c => c.classList.add('row-hover'));
    }
});

assignmentTable.addEventListener('mouseleave', ()=>{
    assignmentTable.querySelectorAll('.col-hover').forEach(c=>c.classList.remove('col-hover'));
    assignmentTable.querySelectorAll('.row-hover').forEach(c=>c.classList.remove('row-hover'));
});

// –í—ã–¥–µ–ª–µ–Ω–∏–µ —è—á–µ–π–∫–∏ –∫–ª–∏–∫–æ–º (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ)
assignmentTable.addEventListener('click', e=>{
    if(e.target.tagName==='TD' && e.target.cellIndex !== 0){
        assignmentTable.querySelectorAll('td').forEach(x=>x.style.outline='');
        e.target.style.outline='2px solid rgba(11,105,255,0.25)';
    }
});

// Drag-scroll
let isDown=false, startX=0, startY=0, scrollLeft=0, scrollTop=0;

assignmentWrap.addEventListener('mousedown', e=>{
    const cell = e.target.closest('td, th');
    if(!cell) return;
    const row = cell.parentElement;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º –ø—Ä–æ–∫—Ä—É—Ç–∫–∏: –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π (—à–∞–ø–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤) –∏–ª–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π (–ø–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü)
    if(cell.tagName==='TH' && row.parentElement.tagName==='THEAD' && cell.cellIndex>0) {
        isDown = 'hor';
    } else if(cell.tagName==='TD' && cell.cellIndex===0) {
        isDown = 'ver';
    } else {
        isDown = false;
        return;
    }

    startX = e.pageX - assignmentWrap.offsetLeft;
    startY = e.pageY - assignmentWrap.offsetTop;
    scrollLeft = assignmentWrap.scrollLeft;
    scrollTop = assignmentWrap.scrollTop;
    assignmentWrap.style.cursor='grabbing';
});

assignmentWrap.addEventListener('mouseup', ()=>{ isDown=false; assignmentWrap.style.cursor='grab'; });
assignmentWrap.addEventListener('mouseleave', ()=>{ isDown=false; assignmentWrap.style.cursor='grab'; });

assignmentWrap.addEventListener('mousemove', e=>{
    if(!isDown) return;
    e.preventDefault();
    const x = e.pageX - assignmentWrap.offsetLeft;
    const y = e.pageY - assignmentWrap.offsetTop;
    if(isDown==='hor') assignmentWrap.scrollLeft = scrollLeft - (x - startX);
    if(isDown==='ver') assignmentWrap.scrollTop¬† = scrollTop¬† - (y - startY);
});

            // --- MAP INIT ---
            const defaultLat = parseFloat(params.get("lat")) || 54.1032;
            const defaultLon = parseFloat(params.get("lon")) || 28.3186;
            currentCenter={lat:defaultLat, lon:defaultLon};
            const map = L.map('map', { center:[defaultLat, defaultLon], zoom:12, attributionControl:false });
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            // –û–ë–ù–û–í–õ–ï–ù–ò–ï –¶–ï–ù–¢–†–ê: –û–±–Ω–æ–≤–ª—è–µ–º currentCenter –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –∫–∞—Ä—Ç—ã
            map.on('move',()=>{
                const c=map.getCenter();
                currentCenter={lat:c.lat, lon:c.lng};
            });

            // –°–ö–†–´–¢–ò–ï POPUP –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–∞—Ä—Ç—É
            map.on('click', () => {
                popupWindow.style.display = 'none';
            });

            // --- PERIODIC CHECK ---
            setInterval(fetchMeAndStatus, 5000);
            fetchMeAndStatus();

            // =========================================================
            // MAP & MARKER LOGIC
            // =========================================================

            function getIcon(color) {
                const urls={green:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                             red:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                             blue:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                             yellow:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png',
                             black:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-black.png'};
                return L.icon({iconUrl:urls[color]||urls.green, shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                                iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]});
            }

            function addMarkerToMap(entry){
                const idStr=String(entry.id);
                if(markersMap[idStr]) return;
                const marker=L.marker([entry.lat,entry.lon],{icon:getIcon(entry.color)}).addTo(map);
                marker.entryId=idStr;
                marker.on('click',()=>handleOpenMarkerPopup(idStr));
                markersMap[idStr]=marker;
            }

            async function loadMarkers(){
                try{
                    const r = await fetchWithAuth(`${SERVER_URL}/markers`);
                    const d = await r.json();
                    if(d.status==='success') d.markers.forEach(addMarkerToMap);
                }catch(err){ console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–∞—Ä–∫–µ—Ä–æ–≤',err);}
            }

            async function refreshMarkers(){
                try{
                    const r = await fetchWithAuth(`${SERVER_URL}/markers`);
                    let d={status:'error', markers:[]};
                    try{ d = await r.json(); } catch(e){ return; }
                    if(d.status!=='success') return;
                    const serverIds=new Set(d.markers.map(m=>String(m.id)));

                    d.markers.forEach(m=>{
                        const idStr=String(m.id);
                        if(markersMap[idStr]){
                            markersMap[idStr].setLatLng([m.lat,m.lon]);
                            markersMap[idStr].setIcon(getIcon(m.color));
                        } else addMarkerToMap(m);
                    });

                    Object.keys(markersMap).forEach(id=>{
                        if(!serverIds.has(id) && id!==String(currentEntryId)){
                            map.removeLayer(markersMap[id]);
                            delete markersMap[id];
                        }
                    });
                }catch(err){console.error(err);}
            }

            // --- PHOTO & POPUP UTILITIES ---

// –í –≤–∞—à–µ–º <script>
async function fetchProtectedImage(filename) {
    const url = `${SERVER_URL}/photo/${filename}`;
    const initData = TELEGRAM_INIT_DATA || ''; // –ü–æ–ª—É—á–∞–µ–º initData, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ

    const options = {
        method: 'GET',
        headers: {},
        credentials: 'include' // üî• –í–ê–ñ–ù–û: –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É –∫—É–∫–∏ —Å–µ—Å—Å–∏–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
    };

    if (initData) {
        // üî• –î–ª—è Telegram Mini App: –≤—Ä—É—á–Ω—É—é –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        options.headers['X-Telegram-Init-Data'] = initData;
    }

    try {
        const response = await fetch(url, options);
        if (!response.ok) {
            console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${filename}: ${response.status} ${response.statusText}`);
            return null;
        }

        // –ü–æ–ª—É—á–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —Å–æ–∑–¥–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π URL
        const blob = await response.blob();
        return URL.createObjectURL(blob);
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ:", e);
        return null;
    }
}


function renderPhotoList() {
    photoList.innerHTML = '';

    // –ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–æ—Ç–æ (—Å —Å–µ—Ä–≤–µ—Ä–∞) –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –Ω–æ–≤—ã–µ (–ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã)
    const allPhotos = [
        ...existingPhotos.map((p, i) => ({filename: p.filename || p, isExisting: true, index: i})),
        ...selectedFiles.map((f, i) => ({file: f, isExisting: false, index: i}))
    ];

    allPhotos.forEach(p => {
        const div = document.createElement('div');
        div.className = 'photoItem';

        let imgUrl;
        let dataSrc = '';
        let isProtected = p.isExisting; // –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–æ—Ç–æ —Å —Å–µ—Ä–≤–µ—Ä–∞ –∑–∞—â–∏—â–µ–Ω—ã

        if (p.isExisting) {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—É—Å—Ç–æ–π SRC –∏–ª–∏ –∑–∞–≥–ª—É—à–∫—É, –ø–æ–∫–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
            imgUrl = '';
            dataSrc = p.filename;
        } else {
            // –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã (–Ω–æ–≤—ã–µ) –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Å—Ä–∞–∑—É —á–µ—Ä–µ–∑ Blob URL
            imgUrl = URL.createObjectURL(p.file);
        }

        const removeBtnId = p.isExisting ? p.index : `s${p.index}`;

        // data-full-src –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Ä–∞–≤–µ–Ω imgUrl. –ë—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –¥–ª—è –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ.
        div.innerHTML = `<img src="${imgUrl}" data-filename="${dataSrc}" data-is-protected="${isProtected}" data-full-src="${imgUrl}">
                         <div class="removePhoto" data-i="${removeBtnId}">√ó</div>`;
        photoList.appendChild(div);

        // üî• –ó–∞–ø—É—Å–∫ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö) —Ñ–æ—Ç–æ
        if (isProtected) {
            const imgElement = div.querySelector('img');
            fetchProtectedImage(p.filename)
                .then(localUrl => {
                    if (localUrl) {
                        imgElement.src = localUrl;
                        imgElement.setAttribute('data-full-src', localUrl); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                    } else {
                        // –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
                        console.error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞—â–∏—â–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ: ${p.filename}`);
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º Base64 –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏ "–æ—à–∏–±–∫–∞"
                        imgElement.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 24 24" fill="none" stroke="red" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x-octagon"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
                    }
                })
                .catch(error => console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ fetchProtectedImage:", error));
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
    photoList.querySelectorAll('.removePhoto').forEach(btn => {
        btn.onclick = (e) => {
            e.stopPropagation();
            const id = btn.dataset.i;
            if (String(id).startsWith('s')) {
                selectedFiles.splice(parseInt(id.slice(1)), 1);
            } else {
                existingPhotos.splice(parseInt(id), 1);
            }
            renderPhotoList();
        };
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    photoList.querySelectorAll('img').forEach(img => {
        img.onclick = (e) => {
            e.stopPropagation();

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º data-full-src, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏–±–æ –ª–æ–∫–∞–ª—å–Ω—ã–π URL –¥–ª—è Blob,
            // –ª–∏–±–æ –ª–æ–∫–∞–ª—å–Ω—ã–π URL –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞.
            const src = img.getAttribute('data-full-src') || img.src;

            if (!src || src.startsWith('data:image/svg')) {
                 // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–æ–¥–∞–ª–∫—É, –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏–ª–∏ —ç—Ç–æ –∏–∫–æ–Ω–∫–∞ –æ—à–∏–±–∫–∏
                 return;
            }

            photoModal.querySelector('img').src = src;
            photoModal.style.display = 'flex';
        };
    });
}


            // =========================================================
            // MARKER POPUP HANDLERS
            // =========================================================

            async function loadObjectOptions() {
                pointObjectSelect.innerHTML = '<option value="">-- –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤... --</option>';

                try {
                    const r = await fetchWithAuth(`${SERVER_URL}/admin/objects`);
                    const d = await r.json();

                    pointObjectSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç --</option>';

                    if (d.status === 'success' && d.objects) {
                        d.objects.forEach(obj => {
                            const option = document.createElement('option');
                            option.value = obj.id;
                            option.textContent = obj.name;
                            pointObjectSelect.appendChild(option);
                        });
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–±—ä–µ–∫—Ç–æ–≤:', e);
                    pointObjectSelect.innerHTML = '<option value="">-- –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ --</option>';
                }
            }

            async function loadMarkerData(pointId) {
                spinner.style.display = 'block';

                try {
                    const response = await fetchWithAuth(`${SERVER_URL}/marker/${pointId}`);
                    const data = await response.json();

                    if (data.status === 'success' && data.marker) {
                        const marker = data.marker;
                        popupCoords.textContent = `${marker.lat.toFixed(6)}, ${marker.lon.toFixed(6)}`;
                        noteInput.value = marker.note || '';
                        breedInput.value = marker.breed || '';

                        pointObjectSelect.value = marker.object_id || '';

                        markerColorSelect.value = marker.color || 'green';

                        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ photos - —ç—Ç–æ –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –∫–ª—é—á–æ–º 'filename'
                        existingPhotos = (marker.photos || []).map(p => {
                            if (typeof p === 'string') {
                                return { filename: p };
                            }
                            return p;
                        });

                        renderPhotoList();

                        map.setView([marker.lat, marker.lon], map.getZoom());

                        return true;
                    } else {
                        alert(data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –º–µ—Ç–∫–∏.');
                        return false;
                    }
                } catch(e) {
                    alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –º–µ—Ç–∫–∏.');
                    console.error("Load Marker Data Error:", e);
                    return false;
                } finally {
                    spinner.style.display = 'none';
                }
            }

            async function handleOpenMarkerPopup(pointId = null) {
                currentEntryId = pointId;
                selectedFiles = [];
                existingPhotos = [];

                noteInput.value = '';
                breedInput.value = '';
                markerColorSelect.value = 'green';
                photoInput.value = '';
                photoList.innerHTML = '';
                document.getElementById('copyCoordsBtn').textContent = COPY_SYMBOL;

                spinner.style.display = 'block';
                await loadObjectOptions();
                spinner.style.display = 'none';

                if (pointId) {
                    // –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –°–£–©–ï–°–¢–í–£–Æ–©–ï–ô –¢–û–ß–ö–ò
                    const success = await loadMarkerData(pointId);
                    if (!success) {
                        popupWindow.style.display = 'none';
                        return;
                    }

                    pointObjectSelect.disabled = true;
                    saveBtn.textContent = '–û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–∫—É';
                    deleteBtn.style.display = 'block';

                } else {
                    // –°–û–ó–î–ê–ù–ò–ï –ù–û–í–û–ô –¢–û–ß–ö–ò
                    const {lat, lon} = currentCenter;
                    popupCoords.textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;

                    pointObjectSelect.disabled = false;
                    pointObjectSelect.value = '';
                    saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                    deleteBtn.style.display = 'none';
                }

                popupWindow.style.display = 'block';
            }


            // =========================================================
            // POPUP BUTTON HANDLERS (–£–ë–†–ê–ù–´ –ê–õ–ï–†–¢–´ –£–°–ü–ï–•–ê –ò CONFIRM)
            // =========================================================

            // –ö–Ω–æ–ø–∫–∞ "–ù–æ–≤–∞—è —Ç–æ—á–∫–∞" —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ —Ü–µ–Ω—Ç—Ä–∞ –∫–∞—Ä—Ç—ã
            newPointBtn.onclick = () => handleOpenMarkerPopup(null);

            saveBtn.onclick = async () => {
                spinner.style.display = 'block';
                saveBtn.disabled = true;

                const isNew = currentEntryId === null;
                const selectedObjectId = pointObjectSelect.value;

                if (isNew && !selectedObjectId) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –û–±—ä–µ–∫—Ç –¥–ª—è –Ω–æ–≤–æ–π –º–µ—Ç–∫–∏.');
                    saveBtn.disabled = false;
                    spinner.style.display = 'none';
                    return;
                }

                const compressedFilesPromises = selectedFiles.map(file => compressImage(file));
                let compressedFiles = [];
                try {
                    compressedFiles = await Promise.all(compressedFilesPromises);
                } catch (err) {
                    spinner.style.display = 'none';
                    saveBtn.disabled = false;
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∂–∞—Ç–∏–∏ —Ñ–æ—Ç–æ:', err);
                    return alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π.');
                }

                const fd = new FormData();
                fd.append('note', noteInput.value);
                fd.append('breed', breedInput.value);

                if (selectedObjectId) {
                    fd.append('object_id', selectedObjectId);
                }

                fd.append('color', markerColorSelect.value);
                // –ü–µ—Ä–µ–¥–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–º–µ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã
                fd.append('existing_photos', JSON.stringify(existingPhotos.map(p => p.filename)));

                // *** –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –í–µ—Ä–Ω—É–ª–∏ 'photos' (–±–µ–∑ []) –∏ —É–±–µ–¥–∏–ª–∏—Å—å, —á—Ç–æ —Ü–∏–∫–ª –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç ***
                compressedFiles.forEach(f => fd.append('photos[]', f));

                if (isNew) {
                    const [lat, lon] = popupCoords.textContent.split(',').map(s => s.trim());
                    if (!lat || !lon || lat === '‚Äî') {
                        alert('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã. –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ –∫–∞—Ä—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                        saveBtn.disabled = false;
                        spinner.style.display = 'none';
                        return;
                    }
                    fd.append('lat', lat);
                    fd.append('lon', lon);
                }

                const url = isNew ? `${SERVER_URL}/upload` : `${SERVER_URL}/marker/${currentEntryId}`;
                const method = 'POST';

                try {
                    const r = await fetchWithAuth(url, { method: method, body: fd });

                    if (!r.ok) {
                        const errorData = await r.json().catch(() => ({ message: `HTTP Error: ${r.status}` }));
                        alert(errorData.message || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${r.statusText}`);
                        return;
                    }

                    const d = await r.json();

                    if (d.status === 'success') {
                        popupWindow.style.display = 'none';
                        loadMarkers();
                    } else {
                        alert(d.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.');
                    }
                } catch (e) {
                    alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –º–µ—Ç–∫–∏.');
                    console.error("Save Point Error:", e);
                } finally {
                    spinner.style.display = 'none';
                    saveBtn.disabled = false;
                }
            };

            deleteBtn.onclick = async () => {
                if (!currentEntryId) return;

                try {
                    const r = await fetchWithAuth(`${SERVER_URL}/marker/${currentEntryId}`, { method: 'DELETE' });
                    const d = await r.json();
                    if (d.status === 'success') {
                        if (markersMap[currentEntryId]) { map.removeLayer(markersMap[currentEntryId]); delete markersMap[currentEntryId]; }
                        popupWindow.style.display = 'none';
                        selectedFiles = [];
                        existingPhotos = [];
                    } else alert(d.message);
                } catch (err) { console.error(err); alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏'); }
            };

            // --- GENERAL EVENT HANDLERS (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---

            photoInput.addEventListener('change', () => {
                selectedFiles = Array.from(photoInput.files);
                renderPhotoList();
            });

            popupClose.onclick = () => {
                popupWindow.style.display = 'none';
                currentEntryId = null;
            };

            closePhotoModal.onclick = () => photoModal.style.display = 'none';

            copyCoordsBtn.onclick = async () => {
                const coordsText = popupCoords.textContent;
                if (coordsText && coordsText !== '‚Äî') {
                    try {
                        await navigator.clipboard.writeText(coordsText);
                        copyCoordsBtn.textContent = COPIED_SYMBOL;
                        setTimeout(() => {
                            copyCoordsBtn.textContent = COPY_SYMBOL;
                        }, 1500);

                    } catch (err) {
                        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                        alert(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${coordsText}`);
                    }
                }
            };

            // --- LOGIN HANDLERS (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
            document.getElementById('loginBtn').onclick = async () => { await handleBrowserLogin(); };
            document.getElementById('loginUsername').addEventListener('keypress', (e) => { if (e.key === 'Enter') { handleBrowserLogin(); } });
            document.getElementById('loginPassword').addEventListener('keypress', (e) => { if (e.key === 'Enter') { handleBrowserLogin(); } });


            // =========================================================
            // ADMIN PANEL LOGIC (–£–ë–†–ê–ù–´ –ê–õ–ï–†–¢–´ –£–°–ü–ï–•–ê –ò CONFIRM)
            // =========================================================

            // --- USER LOGIC ---
            async function loadUsersTable() {
                if (!isAdmin) return;
                usersTableBody.innerHTML = '<tr><td colspan="2">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';

                try {
                    const r = await fetchWithAuth(`${SERVER_URL}/admin/users`);
                    const d = await r.json();

                    usersTableBody.innerHTML = '';
                    if (d.status === 'success' && d.users) {
                        d.users.forEach(user => {
                            const row = usersTableBody.insertRow();
                            row.onclick = () => openUserEditModal(user.id);
                            row.style.cursor = 'pointer';
                            row.innerHTML = `
                                <td>${user.full_name}</td>
                                <td>${user.role}</td>
                            `;
                        });
                    } else {
                        usersTableBody.innerHTML = `<tr><td colspan="2">${d.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π'}</td></tr>`;
                    }
                } catch (e) {
                    usersTableBody.innerHTML = '<tr><td colspan="2">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º</td></tr>';
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', e);
                }
            }

            async function openUserEditModal(userId = null) {
                editUserId.value = userId || '';
                editFullName.value = '';
                editRole.value = 'user';
                editTelegramId.value = '';
                editUsername.value = '';
                editPassword.value = '';
                editPhone.value = '';
                editAdditionalInfo.value = '';

                if (userId) {
                    userEditTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
                    newAccountFields.style.display = 'none';
                    optionalInfoFields.style.display = 'block';
                    deleteUserBtn.style.display = 'block';
                    try {
                        const r = await fetchWithAuth(`${SERVER_URL}/admin/user/${userId}`);
                        const d = await r.json();

                        if (d.status === 'success' && d.user) {
                            editFullName.value = d.user.full_name || '';
                            editRole.value = d.user.role;
                            editPhone.value = d.user.phone || '';
                            editAdditionalInfo.value = d.user.additional_info || '';
                        } else {
                            alert(d.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
                            userEditModal.style.display = 'none';
                            return;
                        }
                    } catch (e) {
                        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
                        userEditModal.style.display = 'none';
                        return;
                    }
                } else {
                    userEditTitle.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
                    newAccountFields.style.display = 'block';
                    optionalInfoFields.style.display = 'block';
                    deleteUserBtn.style.display = 'none';
                }

                userEditModal.style.display = 'flex';
            }

            saveUserBtn.onclick = async () => {
                const userId = editUserId.value;
                const url = userId ? `${SERVER_URL}/admin/user/${userId}` : `${SERVER_URL}/admin/user`;

                const data = {
                    full_name: editFullName.value.trim(),
                    role: editRole.value,
                    phone: editPhone.value.trim(),
                    additional_info: editAdditionalInfo.value.trim()
                };

                if (!data.full_name) {
                    alert('–ü–æ–ª–µ –§–ò–û –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.');
                    return;
                }

                if (!userId) {
                    data.telegram_id = editTelegramId.value.trim();
                    data.username = editUsername.value.trim();
                    data.password = editPassword.value.trim();

                    if (!(data.telegram_id || (data.username && data.password))) {
                        alert('–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å Telegram ID –ò–õ–ò Username –∏ Password.');
                        return;
                    }
                }

                try {
                    const r = await fetchWithAuth(url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });

                    if (!r.ok) {
                        const errorData = await r.json().catch(() => ({ message: `HTTP Error: ${r.status}` }));
                        alert(errorData.message || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${r.statusText}`);
                        return;
                    }

                    const d = await r.json();

                    if (d.status === 'success') {
                        userEditModal.style.display = 'none';
                        loadUsersTable();
                    } else {
                        alert(d.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.');
                    }
                } catch (e) {
                    alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.');
                    console.error("Save User Error:", e);
                }
            };

            deleteUserBtn.onclick = async () => {
                const userId = editUserId.value;

                if (!userId) return;

                try {
                    const url = `${SERVER_URL}/admin/user/${userId}`;
                    const r = await fetchWithAuth(url, { method: 'DELETE' });

                    if (!r.ok) {
                        const errorData = await r.json().catch(() => ({ message: `HTTP Error: ${r.status}` }));
                        alert(errorData.message || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${r.statusText}`);
                        return;
                    }

                    const d = await r.json();

                    if (d.status === 'success') {
                        userEditModal.style.display = 'none';
                        loadUsersTable();
                    } else {
                        alert(d.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è.');
                    }
                } catch (e) {
                    alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
                    console.error("Delete User Error:", e);
                }
            };

            createUserBtn.onclick = () => openUserEditModal();
            userEditModalClose.onclick = () => userEditModal.style.display = 'none';

            // --- OBJECT LOGIC ---
            async function loadObjectsTable() {
                if (!isAdmin) return;
                objectsTableBody.innerHTML = '<tr><td>–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';

                try {
                    const r = await fetchWithAuth(`${SERVER_URL}/admin/objects`);
                    const d = await r.json();

                    objectsTableBody.innerHTML = '';
                    if (d.status === 'success' && d.objects) {
                        d.objects.forEach(obj => {
                            const row = objectsTableBody.insertRow();
                            row.onclick = () => openObjectEditModal(obj.id);
                            row.style.cursor = 'pointer';
                            row.innerHTML = `<td>${obj.name}</td>`;
                        });

                        loadObjectOptions();

                    } else {
                        objectsTableBody.innerHTML = `<tr><td>${d.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä–µ–∫—Ç–æ–≤'}</td></tr>`;
                    }
                } catch (e) {
                    objectsTableBody.innerHTML = '<tr><td>–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º</td></tr>';
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–±—ä–µ–∫—Ç–æ–≤:', e);
                }
            }

            async function openObjectEditModal(objectId = null) {
                editObjectId.value = objectId || '';
                editObjectName.value = '';
                editObjectInfo.value = '';

                if (objectId) {
                    objectEditTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞';
                    deleteObjectBtn.style.display = 'block';

                    try {
                        const r = await fetchWithAuth(`${SERVER_URL}/admin/object/${objectId}`);
                        const d = await r.json();

                        if (d.status === 'success' && d.object) {
                            editObjectName.value = d.object.name;
                            editObjectInfo.value = d.object.additional_info || '';
                        } else {
                            alert(d.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.');
                            objectEditModal.style.display = 'none';
                            return;
                        }
                    } catch (e) {
                        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–∞.');
                        objectEditModal.style.display = 'none';
                        return;
                    }
                } else {
                    objectEditTitle.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞';
                    deleteObjectBtn.style.display = 'none';
                }

                objectEditModal.style.display = 'flex';
            }

            saveObjectBtn.onclick = async () => {
                const objectId = editObjectId.value;
                const url = objectId ? `${SERVER_URL}/admin/object/${objectId}` : `${SERVER_URL}/admin/object`;

                const data = {
                    name: editObjectName.value.trim(),
                    additional_info: editObjectInfo.value.trim()
                };

                if (!data.name) {
                    alert('–ü–æ–ª–µ "–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞" –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.');
                    return;
                }

                try {
                    const r = await fetchWithAuth(url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });

                    if (!r.ok) {
                        const errorData = await r.json().catch(() => ({ message: `HTTP Error: ${r.status}` }));
                        alert(errorData.message || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${r.statusText}`);
                        return;
                    }

                    const d = await r.json();

                    if (d.status === 'success') {
                        objectEditModal.style.display = 'none';
                        await loadObjectsTable();
                    } else {
                        alert(d.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.');
                    }
                } catch (e) {
                    alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–∞.');
                    console.error("Save Object Error:", e);
                }
            };

            deleteObjectBtn.onclick = async () => {
                const objectId = editObjectId.value;

                if (!objectId) return;

                try {
                    const url = `${SERVER_URL}/admin/object/${objectId}`;
                    const r = await fetchWithAuth(url, { method: 'DELETE' });

                    if (!r.ok) {
                        const errorData = await r.json().catch(() => ({ message: `HTTP Error: ${r.status}` }));
                        alert(errorData.message || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${r.statusText}`);
                        return;
                    }

                    const d = await r.json();

                    if (d.status === 'success') {
                        objectEditModal.style.display = 'none';
                        loadObjectsTable();
                    } else {
                        alert(d.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è.');
                    }
                } catch (e) {
                    alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞.');
                    console.error("Delete Object Error:", e);
                }
            };

            createObjectBtn.onclick = () => openObjectEditModal();
            objectEditModalClose.onclick = () => objectEditModal.style.display = 'none';




            // --- ADMIN PANEL GENERAL LOGIC (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
            function switchAdminTab(tabName) {
                const adminTabContentPanes = document.querySelectorAll('.adminTabContentPane');

                adminTabButtons.forEach(btn => {
                    btn.classList.remove('active');
                    btn.style.background = '#f4f4f4';
                    btn.style.borderBottom = 'none';
                });

                adminTabContentPanes.forEach(pane => {
                    pane.style.display = 'none';
                });

                const selectedButton = document.querySelector(`.adminTabButton[data-tab="${tabName}"]`);
                const selectedContent = document.getElementById(`tab-${tabName}`);

                if (selectedButton && selectedContent) {
                    selectedButton.classList.add('active');
                    selectedButton.style.background = 'white';

                    selectedContent.style.display = 'block';
                }
            }

            adminTabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabName = btn.getAttribute('data-tab');
                    switchAdminTab(tabName);

                    if (tabName === 'users') {
                        loadUsersTable();
                    } else if (tabName === 'objects') {
                        loadObjectsTable();
                    } else if (tabName === 'assignments') {
                        loadAssignmentData();
                    }
                });
            });

            adminPanelBtn.onclick = () => {
                if (isAdmin) {
                    adminPanelWindow.style.display = 'flex';
                    switchAdminTab('users');
                    loadUsersTable();
                } else {
                    alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.');
                }
            };
            adminPanelClose.onclick = () => {
                adminPanelWindow.style.display = 'none';
            };


            // --- FINAL CALLS ---
            loadMarkers();
            setInterval(refreshMarkers, 30000);
        }


        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM ---
        document.addEventListener('DOMContentLoaded', getInitData);
    </script>
</body>
</html>
