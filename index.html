<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini App Map Markers</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<style>
html, body {margin:0; padding:0; height:100%; font-family:sans-serif;}
#map {height:100vh; width:100%;}
#connectionStatus {position:fixed; top:10px; right:10px; z-index:3000; display:flex; align-items:center;
    font-size:14px; font-weight:bold; pointer-events:none;}
#connectionDot {width:12px; height:12px; border-radius:50%; margin-right:6px; background:#d9534f;}
#initDataDisplay {position:fixed; top:40px; right:10px; z-index:3000; width:250px; max-height:200px; 
    overflow:auto; font-size:12px; background:rgba(255,255,255,0.9); padding:6px; border-radius:4px;}
</style>
</head>
<body>

<div id="connectionStatus">
    <div id="connectionDot"></div>
    <span id="connectionText">Нет соединения</span>
</div>

<div id="initDataDisplay">initData:</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const SERVER_URL = "https://YOUR_BACKEND_URL"; // замените на ваш backend

// --- Telegram WebApp ---
let tg;
let initData;
if (!window.Telegram || !window.Telegram.WebApp) {
    alert("Mini App нужно открыть через Telegram!");
} else {
    tg = window.Telegram.WebApp;
    tg.ready();
    initData = tg.initData;
    document.getElementById('initDataDisplay').textContent = JSON.stringify(tg.initDataUnsafe, null, 2);
}

// --- Получаем координаты из URL ---
const params = new URLSearchParams(window.location.search);
const defaultLat = parseFloat(params.get("lat")) || 54.1032;
const defaultLon = parseFloat(params.get("lon")) || 28.3186;

// --- Карта Leaflet ---
const map = L.map('map', {center:[defaultLat, defaultLon], zoom:12, attributionControl:false});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let currentCenter={lat:defaultLat, lon:defaultLon};
map.on('move',()=>{const c=map.getCenter(); currentCenter={lat:c.lat, lon:c.lng};});

// --- Индикатор соединения ---
const connectionDot = document.getElementById("connectionDot");
const connectionText = document.getElementById("connectionText");

async function pingServer() {
    if(!initData) return; // нет initData
    try {
        const r = await fetch(`${SERVER_URL}/ping`, {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({initData})
        });
        const d = await r.json();
        if(d.status==="success"){
            connectionDot.style.background = "#28a745";
            connectionText.textContent = "Есть соединение";
        } else {
            connectionDot.style.background = "#d9534f";
            connectionText.textContent = "Нет соединения";
        }
    } catch{
        connectionDot.style.background = "#d9534f";
        connectionText.textContent = "Нет соединения";
    }
}
setInterval(pingServer,5000); pingServer();

// --- Маркеры ---
let markersMap={};

function getIcon(color){
    const urls={green:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                red:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                blue:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                yellow:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png'};
    return L.icon({iconUrl:urls[color]||urls.green, shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                   iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]});
}

function addMarkerToMap(entry){
    const idStr=String(entry.id);
    if(markersMap[idStr]) return;
    const marker=L.marker([entry.lat,entry.lon],{icon:getIcon(entry.color)}).addTo(map);
    marker.entryId=idStr;
    markersMap[idStr]=marker;
}

async function loadMarkers(){
    try{
        const r = await fetch(`${SERVER_URL}/markers`,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({initData})
        });
        const d = await r.json();
        if(d.status==='success') d.markers.forEach(addMarkerToMap);
    } catch(err){console.error('Ошибка загрузки маркеров',err);}
}

loadMarkers();
</script>
</body>
</html>
