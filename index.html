<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geo-Point App</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
/* ------------------------------------------- */
/* 1. –ë–ê–ó–û–í–´–ï –ù–ê–°–¢–†–û–ô–ö–ò */
/* ------------------------------------------- */

/* –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ —à—Ä–∏—Ñ—Ç–æ–≤ */
html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #333;
}
/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Ä—Ç—ã Leaflet */
#map {
    height: 100vh;
    width: 100%;
}
/* –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö CSS (—Ü–≤–µ—Ç–∞, —Ä–∞–∑–º–µ—Ä—ã) */
:root{
    --primary-color: #007bff;
    --success-color: #28a745;
    --danger-color: #dc3545;
    --warning-color: #ffc107;
    --cell-size: 48px;
    --grid-gap-color: #e9ecef;
    --line-size: 1px;
    --header-bg: #f8f9fa;
    --firstcol-bg: #f8f9fa;
    --accent-hover: rgba(0, 123, 255, 0.15);
}


/* ------------------------------------------- */
/* 2. –ù–ê–í–ò–ì–ê–¶–ò–Ø –ò –ö–ù–û–ü–ö–ò –ù–ê –ö–ê–†–¢–ï */
/* ------------------------------------------- */

/* –ë–ª–æ–∫ —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ –≤–µ—Ä—Ö–Ω–µ–º –ø—Ä–∞–≤–æ–º —É–≥–ª—É */
#connectionStatus {
    position: fixed;
    top: 15px;
    right: 15px;
    z-index: 3000;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    font-size: 14px;
    font-weight: bold;
    pointer-events: auto;
    background: rgba(255, 255, 255, 0.95);
    padding: 8px 12px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    transition: background 0.2s;
    cursor: default;
}
#connectionStatusRow {
    display: flex;
    align-items: center;
}
/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä (—Ç–æ—á–∫–∞) —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è */
#connectionDot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 6px;
    background: var(--danger-color);
}
/* –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram */
#telegramUsername {
    font-size: 11px;
    color: #888;
    margin-top: 2px;
    font-weight: normal;
}

/* –≠–ª–µ–º–µ–Ω—Ç –ö—Ä–µ—Å—Ç–∏–∫ (Crosshair) –≤ —Ü–µ–Ω—Ç—Ä–µ –∫–∞—Ä—Ç—ã –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —É–∫–∞–∑–∞–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç */
#crosshair {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 24px;
    height: 24px;
    margin-left: -12px;
    margin-top: -12px;
    pointer-events: none;
    z-index: 999;
    opacity: 0.7;
}
/* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏–∏ –∫—Ä–µ—Å—Ç–∏–∫–∞ */
#crosshair::before, #crosshair::after {
    content: '';
    position: absolute;
    background: #000;
}
#crosshair::before {
    left: 50%; top: 0; width: 2px; height: 100%; margin-left: -1px;
}
#crosshair::after {
    top: 50%; left: 0; width: 100%; height: 2px; margin-top: -1px;
}

/* –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π —Ç–æ—á–∫–∏ (FAB) –≤ –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É */
#newPointBtn {
    position: absolute;
    bottom: 15px;
    right: 15px;
    left: auto;
    transform: none;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background-color: var(--success-color);
    color: white;
    font-size: 28px;
    line-height: 56px;
    text-align: center;
    padding: 0;
    border: none;
    cursor: pointer;
    z-index: 1000;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    transition: background-color 0.2s, transform 0.2s;
}
#newPointBtn:hover {
    background-color: #1e7e34;
    transform: scale(1.05);
}

/* –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ú–æ–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã" (–¶–µ–Ω—Ç—Ä —Å–Ω–∏–∑—É) */
#coordBtnWrapper {
    position: absolute;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%);
    width: 56px;
    height: 56px;
    z-index: 1000;
}

/* –ö–Ω–æ–ø–∫–∞ "–ú–æ–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã" */
#coordBtn {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background-color: var(--primary-color, #007bff);
    color: white;
    font-size: 28px;
    line-height: 56px;
    text-align: center;
    padding: 0;
    border: none;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    transition: background-color 0.2s;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –≤—Ä–∞—â–µ–Ω–∏—è –∏ –ø—É–ª—å—Å–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏ */
#coordBtn.loading {
    animation: rotateCompass 1s linear infinite, pulse 1.2s ease-in-out infinite;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –≤—Ä–∞—â–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏ –∫–æ–º–ø–∞—Å–∞ */
@keyframes rotateCompass {
    to { transform: rotate(360deg); }
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å—Å–∞—Ü–∏–∏ (–º–æ—Ä–≥–∞–Ω–∏—è) –∫–Ω–æ–ø–∫–∏ */
@keyframes pulse {
    0%, 100% { box-shadow: 0 4px 8px rgba(0,123,255,0.3); }
    50% { box-shadow: 0 0 12px rgba(0,123,255,0.7); }
}

/* –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ –ª–µ–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É */
#adminPanelBtn {
    position: absolute;
    bottom: 15px;
    left: 15px;
    transform: none;
    z-index: 1000;
    background-color: #6c757d;
    color: white;
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transition: background-color 0.2s;
}
#adminPanelBtn:hover {
    background-color: #5a6268;
}


/* ------------------------------------------- */
/* 3. –û–°–ù–û–í–ù–û–ï –û–ö–ù–û –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø (#popupWindow) */
/* ------------------------------------------- */

/* –ú–æ–±–∏–ª—å–Ω—ã–π —Å—Ç–∏–ª—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
#popupWindow {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 999998 !important;
    background: white;
    display: none;
    overflow-y: auto;
    padding: 20px;
    box-sizing: border-box;
    transition: opacity 0.3s, transform 0.3s;
}

/* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
#popupClose {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 30px;
    color: #333;
    cursor: pointer;
    font-weight: 200;
}

/* –°—Ç–∏–ª—å –¥–ª—è –≤—Å–µ—Ö –º–µ—Ç–æ–∫ (label) –≤ —Ñ–æ—Ä–º–µ */
#popupWindow label {
    display: block;
    margin-top: 12px;
    font-weight: 600;
    font-size: 14px;
    color: #555;
}

/* –°—Ç–∏–ª—å –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞, —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π, –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –∏ —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤ */
#popupWindow input[type="text"], #popupWindow textarea, #popupWindow input[type="file"], #popupWindow select {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    box-sizing: border-box;
    border-radius: 4px;
    border: 1px solid #ced4da;
    font-size: 15px;
    transition: border-color 0.2s, box-shadow 0.2s;
}
/* –≠—Ñ—Ñ–µ–∫—Ç —Ñ–æ–∫—É—Å–∞ */
#popupWindow input[type="text"]:focus, #popupWindow textarea:focus, #popupWindow select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
    outline: none;
}

/* –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –¥–ª—è textarea */
#popupWindow textarea {
    resize: vertical;
}

/* –û–±–≤–æ–¥–∫–∞ –¥–ª—è –±–ª–æ–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç */
.form-group > div {
    border: 1px solid #ced4da;
    padding: 8px;
    border-radius: 4px;
}
/* –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç */
#popupCoords {
    font-weight: 600;
    color: #333;
}
/* –ö–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç */
#copyCoordsBtn {
    font-size: 16px;
    opacity: 0.7;
}
#copyCoordsBtn:hover {
    opacity: 1;
    color: #0056b3;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ */
#photoList {
    margin-top: 10px;
    max-height: 180px;
    overflow-y: auto;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    border: 1px solid #eee;
    padding: 8px 4px;
    border-radius: 4px;
}
/* –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ñ–æ—Ç–æ */
.photoItem {
    position: relative;
}
/* –ú–∏–Ω–∏–∞—Ç—é—Ä–∞ —Ñ–æ—Ç–æ */
.photoItem img {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 6px;
    cursor: pointer;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s;
}
.photoItem img:hover {
    transform: scale(1.05);
}
/* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ */
.removePhoto {
    position: absolute;
    top: -8px;
    right: -8px;
    background: var(--danger-color);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    text-align: center;
    line-height: 20px;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

/* –ö–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è */
#saveBtn, #deleteBtn {
    margin-top: 20px;
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    transition: background-color 0.2s, box-shadow 0.2s;
    font-weight: 600;
}
/* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è */
#saveBtn {
    background: var(--primary-color);
    box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
}
#saveBtn:hover {
    background: #0056b3;
}
/* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è */
#deleteBtn {
    background: var(--danger-color);
    opacity: 0.9;
}
#deleteBtn:hover {
    opacity: 1;
    background: #bd2130;
}

/* Spinner —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ –≤ —Ü–µ–Ω—Ç—Ä–µ popup */
#spinner {
    display: none;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 2000;
    text-align: center;
}

/* –°–∞–º loader - –∞–Ω–∏–º–∞—Ü–∏—è –≤—Ä–∞—â–µ–Ω–∏—è */
.loader {
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    display: inline-block;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ (768px –∏ —à–∏—Ä–µ) */
@media (min-width: 768px) {
    #popupWindow {
        /* –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∏ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —ç–∫—Ä–∞–Ω–µ */
        width: 450px;
        height: auto;
        max-height: 90vh;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border-radius: 10px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        padding: 30px;
    }
    #popupClose {
        top: 15px;
        right: 15px;
    }
}


/* ------------------------------------------- */
/* 5. –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –§–û–¢–û (#photoModal) */
/* ------------------------------------------- */
#photoModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    justify-content: center;
    align-items: center;
    z-index: 999999;
}
/* –°—Ç–∏–ª—å –¥–ª—è –ø–æ–ª–Ω–æ—Ä–∞–∑–º–µ—Ä–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
#photoModal img {
    max-width: 90%;
    max-height: 90%;
    border-radius: 6px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
}
/* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ñ–æ—Ç–æ */
#closePhotoModal {
    position: absolute;
    top: 20px;
    right: 30px;
    font-size: 40px;
    color: white;
    cursor: pointer;
    text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
}
#photoWrapper {
    position: relative;
}

/* –ö–Ω–æ–ø–∫–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏—è (Doodle Buttons) */
.circleButton {
    position: absolute;
    bottom: 20px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: none;
    font-size: 24px;
    color: white;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 1;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
    transition: background-color 0.2s, transform 0.2s;
}
.circleButton:hover {
    transform: scale(1.1);
}
#startDoodle {
    left: 50%;
    transform: translateX(-50%);
    background-color: #17a2b8;
}
#saveDoodle {
    left: 20px;
    background-color: var(--success-color);
}
#cancelDoodle {
    right: 20px;
    background-color: var(--danger-color);
}


/* ------------------------------------------- */
/* 6. –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ –ò –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê */
/* ------------------------------------------- */

/* –û–±—â–∏–π —Å—Ç–∏–ª—å –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ */
.admin-modal-window {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 4000;
    justify-content: center;
    align-items: center;
}
/* –ö–æ–Ω—Ç–µ–Ω—Ç –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ */
.admin-modal-content {
    background: white;
    padding: 25px;
    border-radius: 8px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
    max-width: 90%;
    max-height: 90%;
    overflow-y: auto;
    position: relative;
}
/* –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –≥–ª–∞–≤–Ω–æ–π –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ */
#adminPanelWindow .admin-modal-content {
    width: 90%;
    max-width: 800px;
    min-height: 400px;
}
/* –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
#userEditModal .admin-modal-content, #objectEditModal .admin-modal-content {
    width: 90%;
    max-width: 450px;
}
/* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –∞–¥–º–∏–Ω–∫–∏ */
.modal-close-btn {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 30px;
    cursor: pointer;
    color: #555;
}

/* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –∞–¥–º–∏–Ω–∫–µ */
.admin-modal-content label {
    display: block;
    margin-top: 10px;
    font-weight: 600;
    font-size: 14px;
    color: #555;
}
.admin-modal-content input[type="text"],
.admin-modal-content input[type="password"],
.admin-modal-content textarea,
.admin-modal-content select {
    width: 100%;
    padding: 8px;
    margin-top: 4px;
    box-sizing: border-box;
    border-radius: 4px;
    border: 1px solid #ced4da;
    font-size: 15px;
    transition: border-color 0.2s, box-shadow 0.2s;
}
/* –≠—Ñ—Ñ–µ–∫—Ç —Ñ–æ–∫—É—Å–∞ –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –∞–¥–º–∏–Ω–∫–µ */
.admin-modal-content input:focus, .admin-modal-content textarea:focus, .admin-modal-content select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
    outline: none;
}
/* –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –¥–ª—è textarea */
.admin-modal-content textarea {
    resize: vertical;
}

/* –û–±—â–∏–π —Å—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π –≤ –∞–¥–º–∏–Ω–∫–µ */
.admin-action-button {
    padding: 8px 12px;
    border: none;
    border-radius: 4px;
    background-color: var(--primary-color);
    color: white;
    cursor: pointer;
    margin-bottom: 10px;
    font-size: 14px;
    font-weight: 600;
    transition: background-color 0.2s;
}
.admin-action-button:hover {
    background-color: #0056b3;
}
/* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è */
#deleteUserBtn, #deleteObjectBtn {
    background: var(--danger-color);
    margin-left: 10px;
}
#deleteUserBtn:hover, #deleteObjectBtn:hover {
    background: #bd2130;
}

/* –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º –≤ –∞–¥–º–∏–Ω–∫–µ */
.admin-tabs {
    display: flex;
    border-bottom: 2px solid #ccc;
    margin-bottom: 10px;
}
.adminTabButton {
    padding: 10px 15px;
    cursor: pointer;
    background: #f4f4f4;
    border-radius: 4px 4px 0 0;
    border: 1px solid #ccc;
    border-bottom: none;
    margin-bottom: -2px;
    margin-right: 5px;
    font-size: 15px;
    font-weight: 600;
    transition: background-color 0.2s;
}
/* –ê–∫—Ç–∏–≤–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ */
.adminTabButton.active {
    background: white;
    border-bottom: 2px solid white;
    color: var(--primary-color);
}
.adminTabButton:hover:not(.active) {
    background-color: #e9ecef;
}
/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –≤–∫–ª–∞–¥–∫–∏ */
.adminTabContentPane {
    display: none;
    padding-top: 10px;
}

/* –¢–∞–±–ª–∏—Ü—ã –≤ –∞–¥–º–∏–Ω–∫–µ - –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
.adminTabContentPane table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    font-size: 14px;
}
.adminTabContentPane th, .adminTabContentPane td {
    padding: 8px 10px;
    border: 1px solid #e9ecef;
    text-align: left;
}
.adminTabContentPane th {
    background-color: #f8f9fa;
    font-weight: 600;
}
/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫ –¥–ª—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü */
#usersTable tbody tr, #objectsTable tbody tr {
    cursor: pointer;
    transition: background-color 0.15s;
}
#usersTable tbody tr:hover, #objectsTable tbody tr:hover {
    background-color: #e9ecef;
}


/* ------------------------------------------- */
/* 7. –°–ï–¢–ö–ê –ù–ê–ó–ù–ê–ß–ï–ù–ò–ô (GRID) */
/* ------------------------------------------- */

/* –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã —Å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–º –∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–º —Å–∫—Ä–æ–ª–ª–æ–º */
.table-wrap{
    border:1px solid #e2e8f0;
    overflow:auto;
    max-height:60vh;
    max-width:100%;
    position:relative;
    cursor:grab;
    -ms-overflow-style: none; /* –°–∫—Ä—ã—Ç—å —Å–∫—Ä–æ–ª–ª–±–∞—Ä IE –∏ Edge */
    scrollbar-width: none; /* –°–∫—Ä—ã—Ç—å —Å–∫—Ä–æ–ª–ª–±–∞—Ä Firefox */
}
.table-wrap::-webkit-scrollbar {
    display: none; /* –°–∫—Ä—ã—Ç—å —Å–∫—Ä–æ–ª–ª–±–∞—Ä Chrome, Safari, Opera */
}
/* –ö—É—Ä—Å–æ—Ä –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ */
.table-wrap:active {
    cursor: grabbing;
}

#assignment-table{
    border-collapse:separate;
    border-spacing:0;
    width:max-content;
    min-width:100%;
}

/* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ —è—á–µ–µ–∫ */
#assignment-table th, #assignment-table td{
    width:var(--cell-size);
    height:var(--cell-size);
    min-width:var(--cell-size);
    min-height:var(--cell-size);
    padding:6px 8px;
    box-sizing:border-box;
    text-align:left;
    vertical-align:middle;
    border-right: var(--line-size) solid var(--grid-gap-color);
    border-bottom: var(--line-size) solid var(--grid-gap-color);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    cursor: pointer;
    background-color: #fcfcfc;
    transition: background-color 0.2s;
    font-size: 13px;
}

/* –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ */
/* –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–∞—è —è—á–µ–π–∫–∞ (–ª–µ–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª) */
#assignment-table thead th:first-child{
    position: sticky;
    top:0;
    left:0;
    background: var(--header-bg);
    z-index: 5;
}
/* –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–ª–æ–Ω–æ–∫ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏) */
#assignment-table thead th:not(:first-child){
    position: sticky;
    top:0;
    background: var(--header-bg);
    z-index: 4;
    text-align:center;
    font-weight:700;
}
/* –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π –ø–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü (–æ–±—ä–µ–∫—Ç—ã) */
#assignment-table tbody td:first-child{
    position: sticky;
    left:0;
    background: var(--firstcol-bg);
    z-index: 3;
    box-shadow:2px 0 4px rgba(0,0,0,0.04);
    cursor: default;
    font-weight: bold;
}

/* –°–¢–ò–õ–ò –ü–û–î–°–í–ï–¢–ö–ò –ò –ù–ê–ó–ù–ê–ß–ï–ù–ò–Ø */
/* –°—Ç–∏–ª—å –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —è—á–µ–µ–∫ */
.assigned {
    background-color: var(--success-color) !important;
    color: white;
    text-align: center;
    font-weight: bold;
}
/* –í–∏–∑—É–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è */
.assigned::after {
    content: '‚úì';
    font-size: 16px;
}
.unassigned {
    background-color: #fcfcfc;
}

/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ —Å—Ç–æ–ª–±–µ—Ü/—Å—Ç—Ä–æ–∫—É */
.col-hover, .row-hover {
    background-color: var(--accent-hover) !important;
}

/* –°–±—Ä–æ—Å –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —è—á–µ–µ–∫ */
.col-hover:first-child, .row-hover:first-child {
    background-color: var(--firstcol-bg) !important;
}
#assignment-table thead th:first-child.col-hover {
    background-color: var(--header-bg) !important;
}

/* –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–∞—è —è—á–µ–π–∫–∞ –Ω–µ —Ç–µ—Ä—è–µ—Ç —Ü–≤–µ—Ç –ø—Ä–∏ –ø–æ–¥—Å–≤–µ—Ç–∫–µ */
.assigned.col-hover,
.assigned.row-hover {
    background-color: var(--success-color) !important;
    color: white !important;
}

/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
#assignment-table tbody tr:hover td:not(:first-child){
    background-color: rgba(0, 123, 255, 0.05);
}
/* –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ–Ω –ø–µ—Ä–≤–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ —Å—Ç—Ä–æ–∫—É */
#assignment-table tbody tr:hover td:first-child{
    background-color: var(--firstcol-bg) !important;
}


/* ------------------------------------------- */
/* 8. –§–û–†–ú–ê –í–•–û–î–ê (#loginForm) */
/* ------------------------------------------- */

#loginForm {
    /* –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;

    /* –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–Ω –∏ z-index */
    background: white;
    z-index: 5000;

    /* –ò—Å–ø–æ–ª—å–∑—É–µ–º Flexbox –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ */
    display: flex;
    justify-content: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ */
    align-items: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
    flex-direction: column; /* –≠–ª–µ–º–µ–Ω—Ç—ã –≤ —Å—Ç–æ–ª–±–µ—Ü */
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤–Ω—É—Ç—Ä–∏ —Ñ–æ—Ä–º—ã */
#loginForm h3 {
    font-size: 20px;
    margin-bottom: 15px;
    color: #333;
}
#loginForm input[type="text"],
#loginForm input[type="password"] {
    padding: 10px;
    margin: 6px 0;
    width: 250px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
    box-sizing: border-box;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 16px;
}
#loginForm button {
    width: 250px;
    padding: 10px;
    margin-top: 15px;
    background-color: var(--primary-color, #007bff);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.2s;
}
#loginForm button:hover {
    background-color: #0056b3;
}
</style>
</head>
<body>

    <div id="map"></div>

    <div id="crosshair"></div>

    <div id="spinner"><div class="loader"></div></div>

    <div id="connectionStatus" role="status">
        <div id="connectionStatusRow">
            <div id="connectionDot" aria-hidden="true"></div>
            <div id="connectionText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        <div id="telegramUsername"></div>
    </div>

    <button id="newPointBtn" title="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–µ—Ç–∫—É">‚ûï</button>
    <div id="coordBtnWrapper"> <button id="coordBtn">üß≠</button></div>
    <button id="adminPanelBtn" class="admin-action-button hidden-by-default" title="–û—Ç–∫—Ä—ã—Ç—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—É—é –ø–∞–Ω–µ–ª—å">–ê–¥–º–∏–Ω–∫–∞</button>

    <div id="popupWindow" role="dialog" aria-modal="true" aria-labelledby="popupTitle">
        <span id="popupClose" title="–ó–∞–∫—Ä—ã—Ç—å" aria-label="–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ">&times;</span>
        <h3 id="popupTitle" style="font-size: 18px; margin: 0px 0;">–ù–æ–≤–∞—è –º–µ—Ç–∫–∞ #</h3>

        <div class="form-group">
            <label>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</label>
            <div style="display: flex; align-items: center; border: 1px solid #ccc; padding: 6px; border-radius: 4px;">
                <span id="popupCoords" style="flex-grow: 1;" aria-live="polite">‚Äî</span>
                <button id="copyCoordsBtn" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã" aria-label="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã" style="background: none; color: #007bff; border: none; cursor: pointer; padding: 0 5px; font-size: 14px;">üìã</button>
            </div>
        </div>

        <div class="form-group">
            <label for="pointObjectSelect">–û–±—ä–µ–∫—Ç (*):</label>
            <select id="pointObjectSelect" required>
                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç --</option>
            </select>
        </div>

        <div class="form-group">
            <label for="breedInput">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Ä–æ–¥–∞ –¥–µ—Ä–µ–≤–∞):</label>
            <input type="text" id="breedInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã">
        </div>

        <div class="form-group">
            <label for="noteInput">–ó–∞–º–µ—Ç–∫–∞:</label>
            <textarea id="noteInput" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é"></textarea>
        </div>


        <div class="form-group">
            <label for="markerColor">–¶–≤–µ—Ç –º–µ—Ç–∫–∏:</label>
            <select id="markerColor">
                <option value="green">–ó–µ–ª–µ–Ω—ã–π</option>
                <option value="blue">–°–∏–Ω–∏–π</option>
                <option value="red">–ö—Ä–∞—Å–Ω—ã–π</option>
                <option value="yellow">–ñ–µ–ª—Ç—ã–π</option>
                <option value="black">–ß–µ—Ä–Ω—ã–π</option>
            </select>
        </div>

        <div class="form-group">
            <label for="photoInput">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏:</label>
            <input type="file" id="photoInput" accept="image/*" multiple aria-describedby="photo_hint">
            <small id="photo_hint" style="display: block; font-size: 11px; color: #666; margin-top: 4px;">–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.</small>
            <div id="photoList"></div>
        </div>

        <div style="display: flex; gap: 10px;">
            <button id="saveBtn" style="flex-grow: 1;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="deleteBtn" style="width: auto; flex-grow: 1; margin-top: 12px; display:none;">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>

<div id="photoModal" role="dialog" aria-modal="true" aria-labelledby="photoModalTitle">
    <h2 id="photoModalTitle" style="position: absolute; left: -9999px;">–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ</h2>
    <span id="closePhotoModal" title="–ó–∞–∫—Ä—ã—Ç—å" aria-label="–ó–∞–∫—Ä—ã—Ç—å —Ñ–æ—Ç–æ">&times;</span>

    <div id="photoWrapper" style="position: relative;">
        <img id="photoImage" src="" alt="Photo" style="max-width: 100%; max-height: 80vh;">
        <canvas id="doodleCanvas" style="position: absolute; top: 0; left: 0; display: none;"></canvas>

        <button id="startDoodle" class="circleButton" title="–ù–∞—á–∞—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ" aria-label="–ù–∞—á–∞—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ">‚úé</button>
        <button id="saveDoodle" class="circleButton" style="display: none;" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫" aria-label="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫">‚úî</button>
        <button id="cancelDoodle" class="circleButton" style="display: none;" title="–û—Ç–º–µ–Ω–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫" aria-label="–û—Ç–º–µ–Ω–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫">‚úñ</button>
    </div>
</div>


    <div id="adminPanelWindow" class="admin-modal-window" role="dialog" aria-modal="true" aria-labelledby="adminPanelTitle">
        <div class="admin-modal-content">
            <span id="adminPanelClose" class="modal-close-btn" title="–ó–∞–∫—Ä—ã—Ç—å" aria-label="–ó–∞–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å">&times;</span>
            <h3 id="adminPanelTitle">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>

            <div role="tablist" class="admin-tabs">
                <button role="tab" class="adminTabButton active" data-tab="users" aria-selected="true" aria-controls="tab-users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
                <button role="tab" class="adminTabButton" data-tab="objects" aria-selected="false" aria-controls="tab-objects">–û–±—ä–µ–∫—Ç—ã</button>
                <button role="tab" class="adminTabButton" data-tab="assignments" aria-selected="false" aria-controls="tab-assignments">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</button>
            </div>

            <div id="tab-users" class="adminTabContentPane" role="tabpanel" style="display: block;">
                <button id="createUserBtn" class="admin-action-button" style="background-color: #28a745;">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
                <h4>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</h4>
                <table id="usersTable">
                    <thead>
                        <tr><th>–§–ò–û</th><th>–†–æ–ª—å</th></tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="2">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>

            <div id="tab-objects" class="adminTabContentPane" role="tabpanel">
                <button id="createObjectBtn" class="admin-action-button" style="background-color: #28a745;">‚ûï –°–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç</button>
                <h4>–°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤:</h4>
                <table id="objectsTable">
                    <thead>
                        <tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>

            <div id="tab-assignments" class="adminTabContentPane" role="tabpanel">
                <h4>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:</h4>

                <div class="table-wrap" id="assignmentWrap">
                    <table id="assignment-table" aria-label="–¢–∞–±–ª–∏—Ü–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º">
                        <thead>
                            <tr id="headerRow">
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å \ –û–±—ä–µ–∫—Ç</th>
                            </tr>
                        </thead>
                        <tbody id="bodyRows">
                            <tr><td colspan="100">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <div id="userEditModal" class="admin-modal-window" role="dialog" aria-modal="true" aria-labelledby="userEditTitle">
        <div class="admin-modal-content">
            <span id="userEditModalClose" class="modal-close-btn" title="–ó–∞–∫—Ä—ã—Ç—å" aria-label="–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ">&times;</span>
            <h3 id="userEditTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            <input type="hidden" id="editUserId">

            <label for="editFullName">–§–ò–û (*):</label>
            <input type="text" id="editFullName" required>

            <label for="editRole">–†–æ–ª—å:</label>
            <select id="editRole">
                <option value="user">user</option>
                <option value="admin">admin</option>
            </select>

            <div id="newAccountFields" style="border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 10px;">
                <label style="font-size: 12px; font-weight: normal;">Telegram ID:</label>
                <input type="text" id="editTelegramUsername" placeholder="Telegram Username">
            </div>

            <div id="optionalInfoFields">
                <label for="editPhone">–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                <input type="text" id="editPhone">
                <label for="editAdditionalInfo">–î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</label>
                <textarea id="editAdditionalInfo" rows="2"></textarea>
            </div>

            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button id="saveUserBtn" class="admin-action-button" style="flex-grow: 1;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button id="deleteUserBtn" class="admin-action-button" style="display: none;">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="objectEditModal" class="admin-modal-window" role="dialog" aria-modal="true" aria-labelledby="objectEditTitle">
        <div class="admin-modal-content">
            <span id="objectEditModalClose" class="modal-close-btn" title="–ó–∞–∫—Ä—ã—Ç—å" aria-label="–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ">&times;</span>
            <h3 id="objectEditTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞</h3>
            <input type="hidden" id="editObjectId">

            <label for="editObjectName">–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ (*):</label>
            <input type="text" id="editObjectName" required>

            <label for="editObjectInfo">–î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</label>
            <textarea id="editObjectInfo" rows="3"></textarea>
            <div id="objectPointsList" style="margin-top: 15px;">
                <label>–ú–µ—Ç–∫–∏, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ –æ–±—ä–µ–∫—Ç—É:</label>
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; border-radius: 4px;">
                    <table id="pointTable" style="width: 100%; border-collapse: collapse; text-align: left;">
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button id="saveObjectBtn" class="admin-action-button" style="flex-grow: 1;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button id="deleteObjectBtn" class="admin-action-button" style="display: none;">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>


    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
// =========================================================
// –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
// =========================================================
const SERVER_URL = "http://localhost:5000"; // –ë–∞–∑–æ–≤—ã–π URL –±—ç–∫–µ–Ω–¥-—Å–µ—Ä–≤–µ—Ä–∞

let isAdmin = false; // –§–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
let appInitialized = false; // –§–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π, –±—ã–ª–∞ –ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
const params = new URLSearchParams(window.location.search); // –û–±—ä–µ–∫—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ URL
let currentEntryId = null; // ID —Ç–µ–∫—É—â–µ–π –∑–∞–ø–∏—Å–∏, —Å –∫–æ—Ç–æ—Ä–æ–π —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
let selectedFiles = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —Ñ–∞–π–ª–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏)
let existingPhotos = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è—Ö, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –∑–∞–ø–∏—Å—å—é
let markersMap = {}; // –û–±—ä–µ–∫—Ç-–∫–∞—Ä—Ç–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç–æ–∫ –Ω–∞ –∫–∞—Ä—Ç–µ –ø–æ –∏—Ö ID
let currentCenter = {lat: 54.1032, lon: 28.3186}; // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞ –∫–∞—Ä—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

const COPY_SYMBOL = 'üìã'; // –°–∏–º–≤–æ–ª –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å"
const COPIED_SYMBOL = '‚úîÔ∏è'; // –°–∏–º–≤–æ–ª –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è

// ---
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Web Geolocation API
// ---
function getLocation(successCallback, errorCallback) {
    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Web Geolocation API
    if (!navigator.geolocation) {
        const errorMessage = 'Geolocation is not supported by this browser/device.';
        console.error(errorMessage);
        errorCallback(errorMessage);
        return;
    }

    console.log('Initiating standard Web Geolocation request.');

    // 2. –ó–∞–ø—Ä–æ—Å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è (getCurrentPosition)
    navigator.geolocation.getCurrentPosition(
        // –£—Å–ø–µ—Ö (Success Callback)
        (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            console.log(`Geolocation Success. Latitude: ${lat}, Longitude: ${lon}`);
            // –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ callback
            successCallback({ latitude: lat, longitude: lon });
        },
        // –û—à–∏–±–∫–∞ (Error Callback)
        (error) => {
            let errorMessage = 'Geolocation error.';
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    // –ö–æ–¥ 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–∞–∑–∞–ª –≤ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏
                    errorMessage = 'Permission Denied: User blocked location access.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    // –ö–æ–¥ 2: –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ
                    errorMessage = 'Position Unavailable: Location information could not be determined.';
                    break;
                case error.TIMEOUT:
                    // –ö–æ–¥ 3: –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è
                    errorMessage = 'Timeout: The request to get user location timed out.';
                    break;
                default:
                    errorMessage = `An unknown error occurred: ${error.message}`;
                    break;
            }
            console.error(`Geolocation Error (${error.code}): ${errorMessage}`);
            errorCallback(errorMessage);
        },
        // –û–ø—Ü–∏–∏ (Options)
        {
            enableHighAccuracy: true, // –¢—Ä–µ–±–æ–≤–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
            timeout: 15000, // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (15 —Å–µ–∫—É–Ω–¥)
            maximumAge: 0 // –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –Ω–æ–≤—ã–µ
        }
    );
}

// ---
// –û–±–µ—Ä—Ç–∫–∞ –Ω–∞–¥ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º fetch –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
// –∏–∑ localStorage –∏ –≤–∫–ª—é—á–µ–Ω–∏—è –∫—É–∫–∏-—Å–µ—Å—Å–∏–∏
// ---
async function fetchWithAuth(url, options = {}) {
    options = options || {};
    options.credentials = 'include'; // –í–∫–ª—é—á–µ–Ω–∏–µ –∫—É–∫–∏ –¥–ª—è —Å–µ—Å—Å–∏–∏
    options.headers = options.headers || {};

    const token = localStorage.getItem("userToken"); // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏–∑ localStorage
    if (token) {
        options.headers['Authorization'] = `Bearer ${token}`; // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    }

    return fetch(url, options);
}

// ---
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ª–æ–≥–∏–Ω–∞ Telegram) –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
// –î–æ–±–∞–≤–ª—è–µ—Ç —Å—É—Ñ—Ñ–∏–∫—Å "_admin", –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
// ---
function updateUsernameDisplay() {
    const el = document.getElementById('telegramUsername');

    let displayUsername = currentUsername;

    if (isAdmin) {
        displayUsername = (displayUsername || "Admin") + "_admin"; // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—É—Ñ—Ñ–∏–∫—Å–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞
    }

    if (displayUsername) {
        const finalDisplay = displayUsername.startsWith("@")
            ? displayUsername
            : "@" + displayUsername; // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–∞ '@'

        el.textContent = finalDisplay;
        el.style.display = 'block'; // –ü–æ–∫–∞–∑–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç
    } else {
        el.style.display = 'none'; // –°–∫—Ä—ã—Ç—å —ç–ª–µ–º–µ–Ω—Ç, –µ—Å–ª–∏ –∏–º—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ
    }
}

// ---
// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é –∫–Ω–æ–ø–∫–∏ –∏–ª–∏ –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–ª–∞–≥–∞ isAdmin
// ---
function updateAdminPanelVisibility() {
    const adminPanelBtn = document.getElementById('adminPanelBtn');
    if (adminPanelBtn) {
        adminPanelBtn.style.display = isAdmin ? 'block' : 'none'; // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
    }
}

// ---
// –ó–∞–ø—Ä–æ—Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è/–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
// ---
async function fetchMeAndStatus() {
    const connectionDot = document.getElementById("connectionDot");
    const connectionText = document.getElementById("connectionText");

    try {
        const r = await fetchWithAuth(`${SERVER_URL}/me`); // –ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const d = await r.json();

        if (d.status === "success") {
            // –£—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
            connectionDot.style.background = "#28a745"; // –ó–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç
            connectionText.textContent = "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ";

            currentUsername = d.user.telegram_username;
            isAdmin = d.user.role === 'admin';

            updateUsernameDisplay();
            updateAdminPanelVisibility();
        } else {
            // –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
            connectionDot.style.background = "#d9534f"; // –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç
            connectionText.textContent = "–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω";

            currentUsername = null;
            isAdmin = false;

            updateUsernameDisplay();
            updateAdminPanelVisibility();
        }
    } catch (e) {
        // –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
        connectionDot.style.background = "#d9534f"; // –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç
        connectionText.textContent = "–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è";

        currentUsername = null;
        isAdmin = false;

        updateUsernameDisplay();
        updateAdminPanelVisibility();
    }
}

// ---
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∂–∞—Ç–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π (—É–º–µ–Ω—å—à–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ JPEG)
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç Promise —Å –Ω–æ–≤—ã–º –æ–±—ä–µ–∫—Ç–æ–º File (—Å–∂–∞—Ç—ã–º)
// ---
function compressImage(file, quality = 0.6, maxWidth = 800) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file); // –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∫–∞–∫ Data URL

        reader.onload = event => {
            const img = new Image();
            img.src = event.target.result;

            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ —à–∏—Ä–∏–Ω–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç maxWidth
                if (width > maxWidth) {
                    height *= maxWidth / width;
                    width = maxWidth;
                }

                canvas.width = width;
                canvas.height = height;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height); // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–∂–∞—Ç–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

                // –ü–æ–ª—É—á–µ–Ω–∏–µ Blob –∏–∑ Canvas –≤ —Ñ–æ—Ä–º–∞—Ç–µ JPEG —Å –∑–∞–¥–∞–Ω–Ω–æ–π –∫–æ–º–ø—Ä–µ—Å—Å–∏–µ–π
                canvas.toBlob(blob => {
                    if (blob) {
                        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ File
                        const compressedFile = new File([blob], file.name.replace(/\.(png|gif)$/i, '.jpeg'), {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        });
                        resolve(compressedFile);
                    } else {
                        reject(new Error('Canvas to Blob failed'));
                    }
                }, 'image/jpeg', quality);
            };

            img.onerror = error => reject(error);
        };
        reader.onerror = error => reject(error);
    });
}

// =========================================================
// –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
// =========================================================
function initApp() {
    if (appInitialized) return; // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    appInitialized = true;

    // --- HTML –≠–õ–ï–ú–ï–ù–¢–´: –û—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ---
    const popupWindow = document.getElementById('popupWindow'); // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ—á–∫–∏
    const popupClose = document.getElementById('popupClose'); // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ç–æ—á–∫–∏
    const noteInput = document.getElementById('noteInput'); // –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∑–∞–º–µ—Ç–∫–∏
    const breedInput = document.getElementById('breedInput'); // –ü–æ–ª–µ –≤–≤–æ–¥–∞ –ø–æ—Ä–æ–¥—ã (–∏–ª–∏ –∞–Ω–∞–ª–æ–≥)
    const pointObjectSelect = document.getElementById('pointObjectSelect'); // –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤
    const markerColorSelect = document.getElementById('markerColor'); // –í—ã–±–æ—Ä —Ü–≤–µ—Ç–∞ –º–∞—Ä–∫–µ—Ä–∞
    const photoInput = document.getElementById('photoInput'); // –ü–æ–ª–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
    const photoList = document.getElementById('photoList'); // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–µ–≤—å—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
    const saveBtn = document.getElementById('saveBtn'); // –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏
    const deleteBtn = document.getElementById('deleteBtn'); // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏
    const spinner = document.getElementById('spinner'); // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏/—Å–ø–∏–Ω–Ω–µ—Ä
    const photoModal = document.getElementById('photoModal'); // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ
    const closePhotoModal = document.getElementById('closePhotoModal'); // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ñ–æ—Ç–æ
    const newPointBtn = document.getElementById('newPointBtn'); // –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π —Ç–æ—á–∫–∏
    const coordBtn = document.getElementById('coordBtn'); // –ö–Ω–æ–ø–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
    const popupCoords = document.getElementById('popupCoords'); // –≠–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ –ø–æ–ø–∞–ø–µ
    const copyCoordsBtn = document.getElementById('copyCoordsBtn'); // –ö–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
    const crosshair = document.getElementById('crosshair'); // –ü—Ä–∏—Ü–µ–ª (–¥–ª—è —Ä–µ–∂–∏–º–∞ –≤—ã–±–æ—Ä–∞ —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ)

    // --- HTML –≠–õ–ï–ú–ï–ù–¢–´: –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ ---
    const adminPanelBtn = document.getElementById('adminPanelBtn'); // –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∞
    const adminPanelWindow = document.getElementById('adminPanelWindow'); // –û–∫–Ω–æ –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∞
    const adminPanelClose = document.getElementById('adminPanelClose'); // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∞
    const adminTabButtons = document.querySelectorAll('.adminTabButton'); // –ö–Ω–æ–ø–∫–∏ –≤–∫–ª–∞–¥–æ–∫ –≤ –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∞

    // --- HTML –≠–õ–ï–ú–ï–ù–¢–´: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ ---
    const usersTableBody = document.querySelector('#usersTable tbody'); // –¢–µ–ª–æ —Ç–∞–±–ª–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    const createUserBtn = document.getElementById('createUserBtn'); // –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userEditModal = document.getElementById('userEditModal'); // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userEditModalClose = document.getElementById('userEditModalClose'); // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userEditTitle = document.getElementById('userEditTitle'); // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const saveUserBtn = document.getElementById('saveUserBtn'); // –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const editUserId = document.getElementById('editUserId'); // –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const editFullName = document.getElementById('editFullName'); // –ü–æ–ª–µ –§–ò–û
    const editRole = document.getElementById('editRole'); // –ü–æ–ª–µ –†–æ–ª–∏ (admin/user)
    const editTelegramId = document.getElementById('editTelegramId'); // –ü–æ–ª–µ Telegram ID
    const editPhone = document.getElementById('editPhone'); // –ü–æ–ª–µ –¢–µ–ª–µ—Ñ–æ–Ω–∞
    const editAdditionalInfo = document.getElementById('editAdditionalInfo'); // –ü–æ–ª–µ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    const newAccountFields = document.getElementById('newAccountFields'); // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–ª–µ–π –¥–ª—è –Ω–æ–≤–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
    const optionalInfoFields = document.getElementById('optionalInfoFields'); // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
    const deleteUserBtn = document.getElementById('deleteUserBtn'); // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    // --- HTML –≠–õ–ï–ú–ï–ù–¢–´: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞–º–∏ ---
    const objectsTableBody = document.querySelector('#objectsTable tbody'); // –¢–µ–ª–æ —Ç–∞–±–ª–∏—Ü—ã –æ–±—ä–µ–∫—Ç–æ–≤
    const createObjectBtn = document.getElementById('createObjectBtn'); // –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
    const objectEditModal = document.getElementById('objectEditModal'); // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞
    const objectEditModalClose = document.getElementById('objectEditModalClose'); // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ–±—ä–µ–∫—Ç–∞
    const objectEditTitle = document.getElementById('objectEditTitle'); // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ–±—ä–µ–∫—Ç–∞
    const saveObjectBtn = document.getElementById('saveObjectBtn'); // –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–∞
    const deleteObjectBtn = document.getElementById('deleteObjectBtn'); // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞
    const editObjectId = document.getElementById('editObjectId'); // –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ ID –æ–±—ä–µ–∫—Ç–∞
    const editObjectName = document.getElementById('editObjectName'); // –ü–æ–ª–µ –ò–º–µ–Ω–∏ –æ–±—ä–µ–∫—Ç–∞
    const editObjectInfo = document.getElementById('editObjectInfo'); // –ü–æ–ª–µ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ–±—ä–µ–∫—Ç–µ
    const assignmentWrap = document.getElementById('assignmentWrap'); // –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è —Å–µ–∫—Ü–∏–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
    const assignmentTable = document.getElementById('assignment-table'); // –¢–∞–±–ª–∏—Ü–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π (–∫–æ–º—É –¥–æ—Å—Ç—É–ø–µ–Ω –æ–±—ä–µ–∫—Ç)
    let currentAssignments = new Set(); // Set –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π –æ–±—ä–µ–∫—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

    // --- HTML –≠–õ–ï–ú–ï–ù–¢–´: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ (Doodle) ---
    const photoImage = document.getElementById('photoImage'); // –≠–ª–µ–º–µ–Ω—Ç IMG —Å —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–º —Ñ–æ—Ç–æ
    const doodleCanvas = document.getElementById('doodleCanvas'); // Canvas –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –ø–æ–≤–µ—Ä—Ö —Ñ–æ—Ç–æ
    const startDoodleBtn = document.getElementById('startDoodle'); // –ö–Ω–æ–ø–∫–∞ "–ù–∞—á–∞—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ"
    const saveDoodleBtn = document.getElementById('saveDoodle'); // –ö–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫"
    const cancelDoodleBtn = document.getElementById('cancelDoodle'); // –ö–Ω–æ–ø–∫–∞ "–û—Ç–º–µ–Ω–∏—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ"

    // --- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è ---
    let currentEditingImg = null; // –°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–µ–∫—É—â—É—é –º–∏–Ω–∏–∞—Ç—é—Ä—É (DOM-—ç–ª–µ–º–µ–Ω—Ç), –∫–æ—Ç–æ—Ä—É—é —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º
    let ctx, drawing = false; // –ö–æ–Ω—Ç–µ–∫—Å—Ç Canvas –∏ —Ñ–ª–∞–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è

    // --- –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è (Doodle) ---
    startDoodleBtn.onclick = () => {
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Canvas –ø–æ —Ä–∞–∑–º–µ—Ä—É –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ —Ñ–æ—Ç–æ
        doodleCanvas.width = photoImage.clientWidth;
        doodleCanvas.height = photoImage.clientHeight;
        doodleCanvas.style.display = 'block';

        ctx = doodleCanvas.getContext('2d');
        ctx.strokeStyle = "red";   // –¶–≤–µ—Ç —Ä–∏—Å–æ–≤–∞–Ω–∏—è
        ctx.lineWidth = 3;         // –¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–∏

        // –°–∫—Ä—ã—Ç–∏–µ/–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        startDoodleBtn.style.display = 'none';
        saveDoodleBtn.style.display = 'inline-block';
        cancelDoodleBtn.style.display = 'inline-block';

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ú—ã—à–∏ (Desktop) ---
        doodleCanvas.onmousedown = (e) => {
            drawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        };
        doodleCanvas.onmousemove = (e) => {
            if (drawing) {
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();
            }
        };
        doodleCanvas.onmouseup = () => drawing = false;
        doodleCanvas.onmouseleave = () => drawing = false;


        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ö–∞—Å–∞–Ω–∏—è (Mobile/Touch devices) ---

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∫–∞—Å–∞–Ω–∏—è
        const getTouchPos = (e) => {
            // e.touches[0] - —ç—Ç–æ –ø–µ—Ä–≤–æ–µ –∫–∞—Å–∞–Ω–∏–µ
            const rect = doodleCanvas.getBoundingClientRect();
            return {
                x: e.touches[0].clientX - rect.left,
                y: e.touches[0].clientY - rect.top
            };
        };

        doodleCanvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            const pos = getTouchPos(e);
            drawing = true;
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }, { passive: false }); // { passive: false } –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è —Ä–∞–±–æ—Ç—ã preventDefault

        doodleCanvas.addEventListener('touchmove', (e) => {
            if (drawing) {
                const pos = getTouchPos(e);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            }
        });

        doodleCanvas.addEventListener('touchend', () => {
            drawing = false;
        });

        doodleCanvas.addEventListener('touchcancel', () => {
            drawing = false;
        });
    };

    // --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å —Ä–∏—Å—É–Ω–∫–æ–º ---
    saveDoodleBtn.onclick = () => {
        const finalCanvas = document.createElement('canvas');
        finalCanvas.width = doodleCanvas.width;
        finalCanvas.height = doodleCanvas.height;
        const ctx = finalCanvas.getContext('2d');

        // –†–∏—Å–æ–≤–∞–Ω–∏–µ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞, –∑–∞—Ç–µ–º —Ä–∏—Å—É–Ω–∫–∞ (–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ–µ–≤)
        ctx.drawImage(photoImage, 0, 0, finalCanvas.width, finalCanvas.height);
        ctx.drawImage(doodleCanvas, 0, 0);

        const dataUrl = finalCanvas.toDataURL('image/png');

        // –ó–∞–º–µ–Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ñ–æ—Ç–æ –≤ —Å–ø–∏—Å–∫–µ –Ω–∞ –Ω–æ–≤—É—é Data URL
        replacePhotoInList(currentEditingImg, dataUrl); // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        resetDoodleCanvas();
        photoModal.style.display = 'none'; // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    };

    // --- –°–±—Ä–æ—Å —Ä–µ–∂–∏–º–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è ---
    function resetDoodleCanvas() {
        doodleCanvas.style.display = 'none';
        // –û—á–∏—Å—Ç–∫–∞ Canvas
        doodleCanvas.getContext('2d').clearRect(0, 0, doodleCanvas.width, doodleCanvas.height);

        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫
        startDoodleBtn.style.display = 'inline-block';
        saveDoodleBtn.style.display = 'none';
        cancelDoodleBtn.style.display = 'none';

        currentEditingImg = null; // –°–±—Ä–æ—Å —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—É—é –º–∏–Ω–∏–∞—Ç—é—Ä—É
    }

    // --- –û—Ç–º–µ–Ω–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è ---
    cancelDoodleBtn.onclick = resetDoodleCanvas;

// --- –°–±—Ä–æ—Å —Ä–µ–∂–∏–º–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è (Doodle) ---
// –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –¥–µ–ª–∞–µ—Ç —Ç–æ –∂–µ —Å–∞–º–æ–µ, —á—Ç–æ –∏ resetDoodleCanvas, –Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ –∫–Ω–æ–ø–∫–µ "–û—Ç–º–µ–Ω–∞"
function resetDoodle() {
    doodleCanvas.style.display = 'none';
    // –û—á–∏—Å—Ç–∫–∞ Canvas
    doodleCanvas.getContext('2d').clearRect(0, 0, doodleCanvas.width, doodleCanvas.height);

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫
    startDoodleBtn.style.display = 'inline-block';
    saveDoodleBtn.style.display = 'none';
    cancelDoodleBtn.style.display = 'none';
}

// --- 1. –§–£–ù–ö–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò –î–ê–ù–ù–´–• –ù–ê–ó–ù–ê–ß–ï–ù–ò–ô (–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –ê–¥–º–∏–Ω–∞) ---
async function loadAssignmentData() {
    try {
        const table = document.getElementById('assignment-table');
        if (table) {
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –∑–∞–≥—Ä—É–∑–∫–µ
            table.innerHTML = '<tbody><tr><td colspan="100">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr></tbody>';
        }

        const response = await fetchWithAuth(`${SERVER_URL}/assignments`);
        const data = await response.json();

        console.log("Assignments data:", data);

        if (!data.users || !data.objects) {
            throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç 'users' –∏–ª–∏ 'objects').");
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π –≤ Set –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
        currentAssignments = new Set(data.assignments || []);

        renderAssignmentTable(data.users, data.objects, currentAssignments);

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:', error);
        const table = document.getElementById('assignment-table');
        if (table) {
            table.innerHTML = '<tbody><tr><td colspan="100">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π.</td></tr></tbody>';
        }
    }
}

// --- 2. –§–£–ù–ö–¶–ò–Ø –û–¢–†–ï–°–û–í–ö–ò –¢–ê–ë–õ–ò–¶–´ –ù–ê–ó–ù–ê–ß–ï–ù–ò–ô ---
function renderAssignmentTable(users, objects, assignments) {
    const table = document.getElementById('assignment-table');
    if (!table) return;

    // --- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã (–®–∞–ø–∫–∞) ---
    let html = "<thead id='headerRow'><tr><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>"; // –î–æ–±–∞–≤–ª—è–µ–º id –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–±–æ—Ç—ã —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π
    objects.forEach(obj => {
        html += `<th>${obj.name}</th>`; // –ò–º–µ–Ω–∞ –æ–±—ä–µ–∫—Ç–æ–≤ –∫–∞–∫ —Å—Ç–æ–ª–±—Ü—ã
    });
    html += "</tr></thead><tbody>";

    // --- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–∞ —Ç–∞–±–ª–∏—Ü—ã ---
    users.forEach(user => {
        const label = user.full_name || user.telegram_username || `User #${user.id}`;
        html += `<tr data-user="${user.id}"><td>${label}</td>`; // –ü–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü - –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        objects.forEach(obj => {
            const key = `${user.id}_${obj.id}`; // –ö–ª—é—á –¥–ª—è Set
            const active = assignments.has(key); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
            html += `<td
                        class="assignCell ${active ? 'assigned' : 'unassigned'}"
                        data-user="${user.id}"
                        data-object="${obj.id}">
                    </td>`; // –Ø—á–µ–π–∫–∞ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
        });

        html += "</tr>";
    });

    html += "</tbody>";
    table.innerHTML = html;

    // –ü—Ä–∏–≤—è–∑–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–ª–∏–∫–∞ –∫ —è—á–µ–π–∫–∞–º
    const cells = table.querySelectorAll('.assignCell');
    cells.forEach(cell => {
        cell.addEventListener('click', handleAssignmentToggle);
    });
}

// --- 3. –§–£–ù–ö–¶–ò–Ø –û–ë–†–ê–ë–û–¢–ö–ò –ö–õ–ò–ö–ê (–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è) ---
async function handleAssignmentToggle(event) {
    const cell = event.currentTarget; // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç <td>
    const userId = cell.dataset.user;
    const objectId = cell.dataset.object;

    // –ë–ª–æ–∫–∏—Ä—É–µ–º —è—á–µ–π–∫—É –Ω–∞ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞
    cell.style.pointerEvents = 'none';

    try {
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        const response = await fetchWithAuth(`${SERVER_URL}/assignments/toggle`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId, object_id: objectId })
        });
        const data = await response.json();

        if (data.status === 'success') {
            const assignmentKey = `${userId}_${objectId}`;
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ DOM –∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ Set –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–µ–π—Å—Ç–≤–∏—è —Å–µ—Ä–≤–µ—Ä–∞
            if (data.action === 'added') {
                cell.classList.remove('unassigned');
                cell.classList.add('assigned');
                currentAssignments.add(assignmentKey);
            } else { // data.action === 'removed'
                cell.classList.remove('assigned');
                cell.classList.add('unassigned');
                currentAssignments.delete(assignmentKey);
            }
        } else {
            alert(`–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è: ${data.message}`);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:', error);
        alert('–°–±–æ–π —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è.');
    } finally {
        // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —è—á–µ–π–∫–∏
        cell.style.pointerEvents = 'auto';
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ, –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (typeof refreshMarkers === 'function') refreshMarkers();
}

// --- 4. –ü–û–î–°–í–ï–¢–ö–ê –°–¢–†–û–ö –ò –°–¢–û–õ–ë–¶–û–í –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ ---
// headerRow, assignmentTable, assignmentWrap –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã —Ä–∞–Ω–µ–µ –≤ initApp
const headerRow = document.getElementById('headerRow'); // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —à–∞–ø–∫–∏
const assignmentTable = document.getElementById('assignment-table');
const assignmentWrap = document.getElementById('assignmentWrap');

assignmentTable.addEventListener('mousemove', e => {
    // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –ø–æ–¥—Å–≤–µ—Ç–æ–∫
    assignmentTable.querySelectorAll('.col-hover, .row-hover').forEach(c => c.classList.remove('col-hover', 'row-hover'));
    const cell = e.target.closest('td, th');
    if (!cell) return;
    const colIndex = cell.cellIndex; // –ò–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–æ–ª–±—Ü–∞
    const row = cell.parentElement;

    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–æ–ª–æ–Ω–∫–∏ (–∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏)
    if (colIndex > 0) {
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —è—á–µ–µ–∫ –≤ —Ç–µ–ª–µ —Ç–∞–±–ª–∏—Ü—ã
        assignmentTable.querySelectorAll('tbody tr').forEach(r => {
            const c = r.children[colIndex];
            if (c) c.classList.add('col-hover');
        });
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞
        if (headerRow && headerRow.children[colIndex]) {
            headerRow.children[colIndex].classList.add('col-hover');
        }
    }

    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç—Ä–æ–∫ —Ç–µ–ª–∞ —Ç–∞–±–ª–∏—Ü—ã)
    if (row.parentElement.tagName === 'TBODY') {
        row.querySelectorAll('td').forEach(c => c.classList.add('row-hover'));
    }
});

// –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø—Ä–∏ —É—Ö–æ–¥–µ –∫—É—Ä—Å–æ—Ä–∞ —Å —Ç–∞–±–ª–∏—Ü—ã
assignmentTable.addEventListener('mouseleave', () => {
    assignmentTable.querySelectorAll('.col-hover, .row-hover').forEach(c => c.classList.remove('col-hover', 'row-hover'));
});

// --- 5. DRAG-SCROLL (–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏) ---
let isDown = false; // –§–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π, –Ω–∞–∂–∞—Ç–∞ –ª–∏ –∫–Ω–æ–ø–∫–∞ –º—ã—à–∏
let startX = 0, startY = 0; // –ù–∞—á–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫—É—Ä—Å–æ—Ä–∞
let scrollLeft = 0, scrollTop = 0; // –ù–∞—á–∞–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
let dragMode = false; // –†–µ–∂–∏–º –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ ('hor' –∏–ª–∏ 'ver')

assignmentWrap.addEventListener('mousedown', e => {
    const cell = e.target.closest('td, th');
    if (!cell) {
        isDown = false;
        return;
    }
    const row = cell.parentElement;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º –ø—Ä–æ–∫—Ä—É—Ç–∫–∏: –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π (—à–∞–ø–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤) –∏–ª–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π (–ø–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü)
    if (cell.tagName === 'TH' && row.parentElement.tagName === 'THEAD' && cell.cellIndex > 0) {
        dragMode = 'hor'; // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
    } else if (cell.tagName === 'TD' && cell.cellIndex === 0) {
        dragMode = 'ver'; // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
    } else {
        dragMode = false;
        return;
    }

    isDown = true;
    startX = e.pageX - assignmentWrap.offsetLeft;
    startY = e.pageY - assignmentWrap.offsetTop;
    scrollLeft = assignmentWrap.scrollLeft;
    scrollTop = assignmentWrap.scrollTop;
    assignmentWrap.style.cursor = 'grabbing';
});

// –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
assignmentWrap.addEventListener('mouseup', () => {
    isDown = false;
    assignmentWrap.style.cursor = 'grab';
});
assignmentWrap.addEventListener('mouseleave', () => {
    isDown = false;
    assignmentWrap.style.cursor = 'grab';
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è –º—ã—à–∏ –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
assignmentWrap.addEventListener('mousemove', e => {
    if (!isDown) return;
    e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
    const x = e.pageX - assignmentWrap.offsetLeft;
    const y = e.pageY - assignmentWrap.offsetTop;

    // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
    if (dragMode === 'hor') assignmentWrap.scrollLeft = scrollLeft - (x - startX);
    if (dragMode === 'ver') assignmentWrap.scrollTop = scrollTop - (y - startY);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è –º—ã—à–∏ –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞)
assignmentWrap.addEventListener('mousemove', e => {
    if (!isDown) return;
    e.preventDefault();
    const x = e.pageX - assignmentWrap.offsetLeft;
    const y = e.pageY - assignmentWrap.offsetTop;

    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏: –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∏–ª–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è
    if (dragMode === 'hor') assignmentWrap.scrollLeft = scrollLeft - (x - startX);
    if (dragMode === 'ver') assignmentWrap.scrollTop = scrollTop - (y - startY);
});

// ---------------------------------------------------------
// --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–†–¢–´ (Leaflet) ---
// ---------------------------------------------------------

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∏–∑ URL –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
const defaultLat = parseFloat(params.get("lat")) || 54.1032;
const defaultLon = parseFloat(params.get("lon")) || 28.3186;
currentCenter = {lat: defaultLat, lon: defaultLon};

// –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –∫–∞—Ä—Ç—ã Leaflet
const map = L.map('map', {
    center: [defaultLat, defaultLon],
    zoom: 12, // –ù–∞—á–∞–ª—å–Ω—ã–π –∑—É–º
    attributionControl: false // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –ø–æ–¥–ø–∏—Å–∏ Leaflet
});

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–π–ª–æ–≤–æ–≥–æ —Å–ª–æ—è OpenStreetMap
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// –û–ë–ù–û–í–õ–ï–ù–ò–ï –¶–ï–ù–¢–†–ê: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ –∫–∞—Ä—Ç—ã
map.on('move', () => {
    const c = map.getCenter();
    currentCenter = {lat: c.lat, lon: c.lng};
});

// –°–ö–†–´–¢–ò–ï POPUP: –°–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è/—Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–∞—Ä—Ç—É
map.on('click', () => {
    popupWindow.style.display = 'none';
});

// --- –ü–ï–†–ò–û–î–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê ---
// –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
setInterval(fetchMeAndStatus, 60000);
// –ü–µ—Ä–≤–∞—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
fetchMeAndStatus();

// =========================================================
// MAP & MARKER LOGIC
// =========================================================

// --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∫–æ–Ω–æ–∫ –º–∞—Ä–∫–µ—Ä–æ–≤ ---
function getIcon(color) {
    // URL-–∞–¥—Ä–µ—Å–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤ –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ leaflet-color-markers
    const urls = {
        green: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
        red: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
        blue: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
        yellow: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png',
        black: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-black.png'
    };
    // –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –∏–∫–æ–Ω–∫–∏ Leaflet
    return L.icon({
        iconUrl: urls[color] || urls.green, // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–µ–ª–µ–Ω–æ–π –∏–∫–æ–Ω–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
}

// --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞ –Ω–∞ –∫–∞—Ä—Ç—É ---
function addMarkerToMap(entry) {
    const idStr = String(entry.id);
    if (markersMap[idStr]) return; // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ–±—ã –Ω–µ –¥–æ–±–∞–≤–ª—è—Ç—å –º–∞—Ä–∫–µ—Ä –ø–æ–≤—Ç–æ—Ä–Ω–æ

    // –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –∏ –Ω—É–∂–Ω–æ–π –∏–∫–æ–Ω–∫–æ–π
    const marker = L.marker([entry.lat, entry.lon], {icon: getIcon(entry.color)}).addTo(map);
    marker.entryId = idStr;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞: –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–ø–∞–ø –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    marker.on('click', () => handleOpenMarkerPopup(idStr)); // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ handleOpenMarkerPopup —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

    // –°–æ–∑–¥–∞–Ω–∏–µ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏ (—Ç—É–ª—Ç–∏–ø–∞)
    const tooltipContent = `ID –º–µ—Ç–∫–∏: ${entry.id}<br>–û–±—ä–µ–∫—Ç: ${entry.object_name || '‚Äî'}`;
    marker.bindTooltip(tooltipContent, {
        permanent: false, // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
        direction: 'bottom',
        className: 'marker-tooltip'
    });

    markersMap[idStr] = marker; // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –æ–±—ä–µ–∫—Ç–µ
}

// --- –ü–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –º–∞—Ä–∫–µ—Ä–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞ ---
async function loadMarkers() {
    try {
        const r = await fetchWithAuth(`${SERVER_URL}/markers`);
        const d = await r.json();
        if (d.status === 'success') d.markers.forEach(addMarkerToMap);
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–∞—Ä–∫–µ—Ä–æ–≤', err);
    }
}

// --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤ —Å –¥–∞–Ω–Ω—ã–º–∏ —Å–µ—Ä–≤–µ—Ä–∞ ---
async function refreshMarkers() {
    try {
        const r = await fetchWithAuth(`${SERVER_URL}/markers`);
        let d = {status: 'error', markers: []};
        try {
            d = await r.json(); // –ü–æ–ø—ã—Ç–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
        } catch (e) {
            return; // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç)
        }
        if (d.status !== 'success') return; // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É

        const serverIds = new Set(d.markers.map(m => String(m.id))); // ID –≤—Å–µ—Ö –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞

        // 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö
        d.markers.forEach(m => {
            const idStr = String(m.id);
            if (markersMap[idStr]) {
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∏ –∏–∫–æ–Ω–∫–∏
                markersMap[idStr].setLatLng([m.lat, m.lon]);
                markersMap[idStr].setIcon(getIcon(m.color));
            } else {
                addMarkerToMap(m); // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞
            }
        });

        // 2. –£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö (–∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
        Object.keys(markersMap).forEach(id => {
            // –£–¥–∞–ª—è–µ–º, –µ—Å–ª–∏ ID –Ω–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ò —ç—Ç–æ –Ω–µ —Ç–µ–∫—É—â–∏–π —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π –º–∞—Ä–∫–µ—Ä
            if (!serverIds.has(id) && id !== String(currentEntryId)) {
                map.removeLayer(markersMap[id]);
                delete markersMap[id];
            }
        });
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –º–∞—Ä–∫–µ—Ä–æ–≤:', err);
    }
}

// --- PHOTO & POPUP UTILITIES ---

// --- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞—â–∏—â–µ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–∞ ---
async function fetchProtectedImage(filename) {
    const url = `${SERVER_URL}/photo/${filename}`;

    const options = {
        method: 'GET',
        credentials: 'include', // –í–∫–ª—é—á–µ–Ω–∏–µ –∫—É–∫–∏
        headers: {}
    };

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ USER_TOKEN –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ)
    const token = localStorage.getItem("userToken");
    if (token) {
        options.headers['Authorization'] = `Bearer ${token}`;
    }

    try {
        const response = await fetch(url, options);

        if (!response.ok) {
            console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${filename}: ${response.status} ${response.statusText}`);
            return null;
        }

        const blob = await response.blob();
        // –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ URL –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è Blob-–¥–∞–Ω–Ω—ã—Ö
        return URL.createObjectURL(blob);

    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ:", e);
        return null;
    }
}

// --- –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ ---
function renderPhotoList() {
    photoList.innerHTML = '';

    // –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ñ–æ—Ç–æ —Å —Å–µ—Ä–≤–µ—Ä–∞ (existingPhotos) –∏ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ (selectedFiles)
    const allPhotos = [
        ...existingPhotos.map((p, i) => ({filename: p.filename || p, isExisting: true, index: i})),
        ...selectedFiles.map((f, i) => ({file: f, isExisting: false, index: i}))
    ];

    allPhotos.forEach(p => {
        const div = document.createElement('div');
        div.className = 'photoItem';

        let imgUrl;
        let isExisting = p.isExisting; // –§–ª–∞–≥, –∑–∞–≥—Ä—É–∂–µ–Ω–æ –ª–∏ —Ñ–æ—Ç–æ —Å —Å–µ—Ä–≤–µ—Ä–∞ –∏–ª–∏ —ç—Ç–æ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª

        if (isExisting) {
            imgUrl = ''; // –ù–∞—á–∞–ª—å–Ω–∞—è –ø—É—Å—Ç–∞—è –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ñ–æ—Ç–æ —Å —Å–µ—Ä–≤–µ—Ä–∞
        } else {
            // –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ URL –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞
            imgUrl = URL.createObjectURL(p.file);
        }

        const photoIndex = p.index;

        div.innerHTML = `
            <img src="${imgUrl}"
                 data-index="${photoIndex}"
                 data-is-existing="${isExisting}"
                 data-full-src="${imgUrl}">
            <div class="removePhoto" data-index="${photoIndex}" data-is-existing="${isExisting}">√ó</div>
        `;

        photoList.appendChild(div);

        // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–æ—Ç–æ (—Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
        if (isExisting) {
            const imgElement = div.querySelector('img');
            fetchProtectedImage(p.filename)
                .then(localUrl => {
                    if (localUrl) {
                        imgElement.src = localUrl;
                        imgElement.setAttribute('data-full-src', localUrl); // –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –≤—ã—Å–æ–∫–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
                    } else {
                        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å
                        imgElement.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 24 24" fill="none" stroke="red" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x-octagon"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
                    }
                })
                .catch(error => console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ fetchProtectedImage:", error));
        }
    });


    // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ ---
    photoList.querySelectorAll('.removePhoto').forEach(btn => {
        btn.onclick = (e) => {
            e.stopPropagation();
            const index = parseInt(btn.dataset.index);
            const isExisting = btn.dataset.isExisting === 'true';

            // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ –∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –º–∞—Å—Å–∏–≤–∞
            if (isExisting) {
                existingPhotos.splice(index, 1);
            } else {
                selectedFiles.splice(index, 1);
            }

            renderPhotoList(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞
        };
    });


    // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ---
    photoList.querySelectorAll('img').forEach(img => {
        img.onclick = (e) => {
            e.stopPropagation();

            const src = img.getAttribute('data-full-src') || img.src;
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∑–∞–≥–ª—É—à–∫–∏ —Å –æ—à–∏–±–∫–∞–º–∏
            if (!src || src.startsWith('data:image/svg')) return;

            resetDoodleCanvas(); // –°–±—Ä–æ—Å —Ä–µ–∂–∏–º–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è

            currentEditingImg = img; // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –º–∏–Ω–∏–∞—Ç—é—Ä—É –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥—É–¥–ª–∞

            photoImage.src = src;
            photoModal.style.display = 'flex';
        };
    });
}


// --- –ó–∞–º–µ–Ω–∞ —Ñ–æ—Ç–æ –≤ —Å–ø–∏—Å–∫–µ –ø–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (Doodle) ---
function replacePhotoInList(imgElement, dataUrl) {
    const index = parseInt(imgElement.dataset.index);
    const isExisting = imgElement.dataset.isExisting === 'true';

    // 1. –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ç–æ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
    if (isExisting) {
        existingPhotos.splice(index, 1);
    } else {
        selectedFiles.splice(index, 1);
    }

    // 2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ –∫–∞–∫ –Ω–æ–≤–æ–≥–æ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    const newFile = dataURLtoFile(dataUrl, `edited_${Date.now()}.png`); // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ Data URL –≤ File
    selectedFiles.push(newFile);

    // 3. –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞
    renderPhotoList();
}


// --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Data URL –≤ –æ–±—ä–µ–∫—Ç File ---
function dataURLtoFile(dataurl, filename) {
    const arr = dataurl.split(',');
    const mime = arr[0].match(/:(.*?);/)[1]; // –ü–æ–ª—É—á–µ–Ω–∏–µ MIME-—Ç–∏–ø–∞
    const bstr = atob(arr[1]);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ base64 –≤ Uint8Array
    while (n--) u8arr[n] = bstr.charCodeAt(n);
    // –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ File
    return new File([u8arr], filename, { type: mime });
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è –º—ã—à–∏ –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ (–∫–æ–Ω–µ—Ü)
assignmentWrap.addEventListener('mousemove', e => {
    if (!isDown) return;
    e.preventDefault();
    const x = e.pageX - assignmentWrap.offsetLeft;
    const y = e.pageY - assignmentWrap.offsetTop;
    if (dragMode === 'hor') assignmentWrap.scrollLeft = scrollLeft - (x - startX);
    if (dragMode === 'ver') assignmentWrap.scrollTop = scrollTop - (y - startY);
});

// =========================================================
// MARKER POPUP HANDLERS
// =========================================================

// --- –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ ---
async function loadObjectOptions() {
    pointObjectSelect.innerHTML = '<option value="">-- –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤... --</option>';

    try {
        const r = await fetchWithAuth(`${SERVER_URL}/objects`);
        const d = await r.json();

        pointObjectSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç --</option>'; // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

        if (d.status === 'success' && d.objects) {
            d.objects.forEach(obj => {
                const option = document.createElement('option');
                option.value = obj.id;
                option.textContent = obj.name;
                pointObjectSelect.appendChild(option);
            });
        }
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–±—ä–µ–∫—Ç–æ–≤:', e);
        pointObjectSelect.innerHTML = '<option value="">-- –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ --</option>';
    }
}

// --- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –º–µ—Ç–∫–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ---
async function loadMarkerData(pointId) {
    spinner.style.display = 'block';

    try {
        const response = await fetchWithAuth(`${SERVER_URL}/marker/${pointId}`);
        const data = await response.json();

        if (data.status === 'success' && data.marker) {
            const marker = data.marker;
            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
            popupCoords.textContent = `${marker.lat.toFixed(6)}, ${marker.lon.toFixed(6)}`;
            document.getElementById('popupTitle').textContent = `–ú–µ—Ç–∫–∞ #${pointId}`;
            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π
            noteInput.value = marker.note || '';
            breedInput.value = marker.breed || '';
            pointObjectSelect.value = marker.object_id || '';
            markerColorSelect.value = marker.color || 'green';

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–æ—Ç–æ
            existingPhotos = (marker.photos || []).map(p => {
                if (typeof p === 'string') {
                    return { filename: p }; // –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –∫ –æ–±—ä–µ–∫—Ç—É
                }
                return p;
            });

            renderPhotoList(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–æ—Ç–æ
            map.setView([marker.lat, marker.lon], map.getZoom()); // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã –Ω–∞ –º–µ—Ç–∫–µ

            return true;
        } else {
            alert(data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –º–µ—Ç–∫–∏.');
            return false;
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –º–µ—Ç–∫–∏.');
        console.error("Load Marker Data Error:", e);
        return false;
    } finally {
        spinner.style.display = 'none';
    }
}

// --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ç–∫–∏ ---
async function handleOpenMarkerPopup(pointId = null) {
    // 1. –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ñ–æ—Ä–º—ã
    currentEntryId = pointId;
    selectedFiles = [];
    existingPhotos = [];
    document.getElementById('popupTitle').textContent = `–ú–µ—Ç–∫–∞ #`;
    noteInput.value = '';
    breedInput.value = '';
    markerColorSelect.value = 'green';
    photoInput.value = '';
    photoList.innerHTML = '';
    document.getElementById('copyCoordsBtn').textContent = COPY_SYMBOL;

    // 2. –ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø—Ü–∏–π –æ–±—ä–µ–∫—Ç–æ–≤
    spinner.style.display = 'block';
    await loadObjectOptions();
    spinner.style.display = 'none';

    if (pointId) {
        // –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –°–£–©–ï–°–¢–í–£–Æ–©–ï–ô –¢–û–ß–ö–ò
        const success = await loadMarkerData(pointId);

        if (!success) {
            popupWindow.style.display = 'none';
            return;
        }

        // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –º–µ—Ç–∫–∏
        pointObjectSelect.disabled = true;
        saveBtn.textContent = '–û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–∫—É';
        deleteBtn.style.display = 'block';

    } else {
        // –°–û–ó–î–ê–ù–ò–ï –ù–û–í–û–ô –¢–û–ß–ö–ò
        const {lat, lon} = currentCenter;
        popupCoords.textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`; // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –±–µ—Ä—É—Ç—Å—è –∏–∑ —Ü–µ–Ω—Ç—Ä–∞ –∫–∞—Ä—Ç—ã

        pointObjectSelect.disabled = false;
        pointObjectSelect.value = '';
        saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        deleteBtn.style.display = 'none';
    }

    popupWindow.style.display = 'block';
}

// --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã" ---
coordBtn.onclick = () => {
    // –í–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    coordBtn.classList.add("loading");

    // –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –≥–µ–æ–¥–∞–Ω–Ω—ã—Ö (—Å–º. –Ω–∞—á–∞–ª–æ –∫–æ–¥–∞)
    getLocation(
        (location) => {
            // –£—Å–ø–µ—Ö: –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã –Ω–∞ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö
            console.log('Location received:', location);
            map.setView([location.latitude, location.longitude], map.getZoom());
            coordBtn.classList.remove("loading");
        },
        (errorMsg) => {
            // –û—à–∏–±–∫–∞: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            console.error('Location error:', errorMsg);
            alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: ${errorMsg}`);
            coordBtn.classList.remove("loading");
        }
    );
};

// =========================================================
// POPUP BUTTON HANDLERS (–°–û–•–†–ê–ù–ï–ù–ò–ï / –£–î–ê–õ–ï–ù–ò–ï)
// =========================================================

// --- –ö–Ω–æ–ø–∫–∞ "–ù–æ–≤–∞—è —Ç–æ—á–∫–∞" ---
newPointBtn.onclick = () => handleOpenMarkerPopup(null);

// --- –ö–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å/–û–±–Ω–æ–≤–∏—Ç—å" ---
saveBtn.onclick = async () => {
    // 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ UX
    spinner.style.display = 'block';
    saveBtn.disabled = true;

    const isNew = currentEntryId === null;
    const selectedObjectId = pointObjectSelect.value;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—è –¥–ª—è –Ω–æ–≤–æ–π –º–µ—Ç–∫–∏
    if (isNew && !selectedObjectId) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –û–±—ä–µ–∫—Ç –¥–ª—è –Ω–æ–≤–æ–π –º–µ—Ç–∫–∏.');
        saveBtn.disabled = false;
        spinner.style.display = 'none';
        return;
    }

    // 2. –°–∂–∞—Ç–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
    const compressedFilesPromises = selectedFiles.map(file => compressImage(file)); // compressImage –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
    let compressedFiles = [];
    try {
        compressedFiles = await Promise.all(compressedFilesPromises);
    } catch (err) {
        spinner.style.display = 'none';
        saveBtn.disabled = false;
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∂–∞—Ç–∏–∏ —Ñ–æ—Ç–æ:', err);
        return alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π.');
    }

    // 3. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ FormData
    const fd = new FormData();
    fd.append('note', noteInput.value);
    fd.append('breed', breedInput.value);

    if (selectedObjectId) {
        fd.append('object_id', selectedObjectId);
    }

    fd.append('color', markerColorSelect.value);

    // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∏ —Å–ø–∏—Å–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–æ—Ç–æ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è
    if (!isNew) {
        const remainingPhotoFilenames = existingPhotos.map(p => p.filename);

        if (remainingPhotoFilenames.length > 0) {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–æ—Ç–æ, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –æ—Å—Ç–∞—Ç—å—Å—è
            fd.append('existing_photos', JSON.stringify(remainingPhotoFilenames));
        } else {
            // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ –ø—É—Å—Ç, —è–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä—É —É–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å—Ç–∞—Ä—ã–µ —Ñ–æ—Ç–æ
            fd.append('existing_photos', '[]');
        }
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö, —Å–∂–∞—Ç—ã—Ö —Ñ–∞–π–ª–æ–≤
    compressedFiles.forEach(f => fd.append('photos[]', f));

    // 4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤–æ–π –º–µ—Ç–∫–∏)
    if (isNew) {
        const [lat, lon] = popupCoords.textContent.split(',').map(s => s.trim());
        if (!lat || !lon || lat === '‚Äî') {
            alert('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã. –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ –∫–∞—Ä—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
            saveBtn.disabled = false;
            spinner.style.display = 'none';
            return;
        }
        fd.append('lat', lat);
        fd.append('lon', lon);
    }

    // 5. –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
    const url = isNew ? `${SERVER_URL}/upload` : `${SERVER_URL}/marker/${currentEntryId}`;
    const method = 'POST'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º POST –¥–ª—è –æ–±–µ–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (RESTful UPDATE —á–µ—Ä–µ–∑ POST/PUT –Ω–µ –≤—Å–µ–≥–¥–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ Form Data)

    try {
        const r = await fetchWithAuth(url, { method: method, body: fd });

        if (!r.ok) {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ HTTP-—Å—Ç–∞—Ç—É—Å–∞
            const errorData = await r.json().catch(() => ({ message: `HTTP Error: ${r.status}` }));
            alert(errorData.message || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${r.statusText}`);
            return;
        }

        const d = await r.json();

        if (d.status === 'success') {
            popupWindow.style.display = 'none';
            loadMarkers(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –º–∞—Ä–∫–µ—Ä–æ–≤
        } else {
            alert(d.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.');
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –º–µ—Ç–∫–∏.');
        console.error("Save Point Error:", e);
    } finally {
        // 6. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ UX
        spinner.style.display = 'none';
        saveBtn.disabled = false;
    }

    refreshMarkers(); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ (–≤–∫–ª—é—á–∞—è –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏/–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
};

// --- –ö–Ω–æ–ø–∫–∞ "–£–¥–∞–ª–∏—Ç—å" ---
deleteBtn.onclick = async () => {
    if (!currentEntryId) return; // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ ID –º–µ—Ç–∫–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

    // –í –∫–æ–¥–µ —É–±—Ä–∞–Ω confirm, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –æ–Ω –µ—Å—Ç—å –≤ UI

    try {
        const r = await fetchWithAuth(`${SERVER_URL}/marker/${currentEntryId}`, { method: 'DELETE' });
        const d = await r.json();
        if (d.status === 'success') {
            // –£–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ —Å –∫–∞—Ä—Ç—ã
            if (markersMap[currentEntryId]) {
                map.removeLayer(markersMap[currentEntryId]);
                delete markersMap[currentEntryId];
            }
            popupWindow.style.display = 'none'; // –°–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã
            selectedFiles = []; // –û—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            existingPhotos = [];
        } else {
            alert(d.message);
        }
    } catch (err) {
        console.error(err);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
    }
};
// --- GENERAL EVENT HANDLERS ---

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤: –æ–±–Ω–æ–≤–ª—è–µ—Ç –º–∞—Å—Å–∏–≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫
photoInput.addEventListener('change', () => {
    selectedFiles = Array.from(photoInput.files);
    renderPhotoList(); // renderPhotoList –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ä–∞–Ω–µ–µ
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–µ—Ç–∫–∏
popupClose.onclick = () => {
    popupWindow.style.display = 'none';
    currentEntryId = null; // –°–±—Ä–æ—Å ID —Ç–µ–∫—É—â–µ–π —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–π –º–µ—Ç–∫–∏
};

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ
closePhotoModal.onclick = () => photoModal.style.display = 'none';

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
copyCoordsBtn.onclick = async () => {
    const coordsText = popupCoords.textContent;
    if (coordsText && coordsText !== '‚Äî') {
        try {
            await navigator.clipboard.writeText(coordsText); // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
            copyCoordsBtn.textContent = COPIED_SYMBOL; // –ü–æ–∫–∞–∑–∞—Ç—å —Å–∏–º–≤–æ–ª —É—Å–ø–µ—Ö–∞
            // –°–±—Ä–æ—Å —Å–∏–º–≤–æ–ª–∞ —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                copyCoordsBtn.textContent = COPY_SYMBOL;
            }, 1500);

        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
            alert(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${coordsText}`);
        }
    }
};

// --- LOGIN HANDLERS (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã/—É–¥–∞–ª–µ–Ω—ã) ---
// –õ–æ–≥–∏–∫–∞ –≤—Ö–æ–¥–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ)

// =========================================================
// ADMIN PANEL LOGIC (–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏)
// =========================================================

// --- USER LOGIC: –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ---
async function loadUsersTable() {
    if (!isAdmin) return; // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    usersTableBody.innerHTML = '<tr><td colspan="2">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';

    try {
        const r = await fetchWithAuth(`${SERVER_URL}/admin/users`);
        const d = await r.json();

        usersTableBody.innerHTML = '';
        if (d.status === 'success' && d.users) {
            d.users.forEach(user => {
                const row = usersTableBody.insertRow();
                row.onclick = () => openUserEditModal(user.id); // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                row.style.cursor = 'pointer';
                row.innerHTML = `
                    <td>${user.full_name}</td>
                    <td>${user.role}</td>
                `;
            });
        } else {
            usersTableBody.innerHTML = `<tr><td colspan="2">${d.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π'}</td></tr>`;
        }
    } catch (e) {
        usersTableBody.innerHTML = '<tr><td colspan="2">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º</td></tr>';
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', e);
    }
}

// --- USER LOGIC: –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
async function openUserEditModal(userId = null) {
    // –°–±—Ä–æ—Å –ø–æ–ª–µ–π
    editUserId.value = userId || '';
    editFullName.value = '';
    editRole.value = 'user';
    editTelegramUsername.value = '';
    editPhone.value = '';
    editAdditionalInfo.value = '';

    if (userId) {
        // –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø
        userEditTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
        deleteUserBtn.style.display = 'block';

        try {
            const r = await fetchWithAuth(`${SERVER_URL}/admin/user/${userId}`);
            const d = await r.json();

            if (d.status === 'success' && d.user) {
                // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π –¥–∞–Ω–Ω—ã–º–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
                editFullName.value = d.user.full_name || '';
                editRole.value = d.user.role;
                editPhone.value = d.user.phone || '';
                editAdditionalInfo.value = d.user.additional_info || '';
                editTelegramUsername.value = d.user.telegram_username || ''; // –ò–º—è Telegram
            } else {
                alert(d.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
                userEditModal.style.display = 'none';
                return;
            }
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
            userEditModal.style.display = 'none';
            return;
        }
    } else {
        // –†–ï–ñ–ò–ú –°–û–ó–î–ê–ù–ò–Ø
        userEditTitle.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
        deleteUserBtn.style.display = 'none';
    }

    userEditModal.style.display = 'flex';
}

// --- USER LOGIC: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–°–æ–∑–¥–∞–Ω–∏–µ/–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ) ---
saveUserBtn.onclick = async () => {
    const userId = editUserId.value;

    const url = userId
        ? `${SERVER_URL}/admin/user/${userId}` // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        : `${SERVER_URL}/admin/user`; // –°–æ–∑–¥–∞–Ω–∏–µ

    const data = {
        full_name: editFullName.value.trim(),
        role: editRole.value,
        phone: editPhone.value.trim(),
        additional_info: editAdditionalInfo.value.trim()
    };

    if (!data.full_name) {
        alert('–ü–æ–ª–µ –§–ò–û –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.');
        return;
    }

    if (!userId) { // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
        data.telegram_username = editTelegramUsername.value.trim();

        if (!data.telegram_username) {
            alert('–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å Telegram Username.');
            return;
        }
    }

    try {
        const r = await fetchWithAuth(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const d = await r.json();

        if (d.status === 'success') {
            userEditModal.style.display = 'none';
            loadUsersTable(); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        } else {
            alert(d.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.');
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
        console.error(e);
    }
};
// --- USER LOGIC: –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
deleteUserBtn.onclick = async () => {
    const userId = editUserId.value;

    if (!userId) return;

    try {
        const url = `${SERVER_URL}/admin/user/${userId}`;
        const r = await fetchWithAuth(url, { method: 'DELETE' }); // –û—Ç–ø—Ä–∞–≤–∫–∞ DELETE-–∑–∞–ø—Ä–æ—Å–∞

        if (!r.ok) {
            const errorData = await r.json().catch(() => ({ message: `HTTP Error: ${r.status}` }));
            alert(errorData.message || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${r.statusText}`);
            return;
        }

        const d = await r.json();

        if (d.status === 'success') {
            userEditModal.style.display = 'none'; // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            loadUsersTable(); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
        } else {
            alert(d.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è.');
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
        console.error("Delete User Error:", e);
    }
};

// --- USER LOGIC: –ö–Ω–æ–ø–∫–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è ---
createUserBtn.onclick = () => openUserEditModal(); // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
userEditModalClose.onclick = () => userEditModal.style.display = 'none'; // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞

// --- OBJECT LOGIC: –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –æ–±—ä–µ–∫—Ç–æ–≤ ---
async function loadObjectsTable() {
    if (!isAdmin) return;
    objectsTableBody.innerHTML = '<tr><td>–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';

    try {
        const r = await fetchWithAuth(`${SERVER_URL}/admin/objects`);
        const d = await r.json();

        objectsTableBody.innerHTML = '';
        if (d.status === 'success' && d.objects) {
            d.objects.forEach(obj => {
                const row = objectsTableBody.insertRow();
                row.onclick = () => openObjectEditModal(obj.id); // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                row.style.cursor = 'pointer';
                row.innerHTML = `<td>${obj.name}</td>`;
            });

            loadObjectOptions(); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è –º–µ—Ç–æ–∫

        } else {
            objectsTableBody.innerHTML = `<tr><td>${d.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä–µ–∫—Ç–æ–≤'}</td></tr>`;
        }
    } catch (e) {
        objectsTableBody.innerHTML = '<tr><td>–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º</td></tr>';
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–±—ä–µ–∫—Ç–æ–≤:', e);
    }
}

// --- OBJECT LOGIC: –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ ---
async function openObjectEditModal(objectId = null) {
    // –°–±—Ä–æ—Å –ø–æ–ª–µ–π
    editObjectId.value = objectId || '';
    editObjectName.value = '';
    editObjectInfo.value = '';
    const objectPointsList = document.getElementById('objectPointsList'); // –ë–ª–æ–∫ —Å–æ —Å–ø–∏—Å–∫–æ–º –º–µ—Ç–æ–∫

    if (objectId) {
        // –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø
        objectEditTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞';
        deleteObjectBtn.style.display = 'block';
        objectPointsList.style.display = 'block'; // –ü–æ–∫–∞–∑ —Å–ø–∏—Å–∫–∞ –º–µ—Ç–æ–∫

        try {
            const r = await fetchWithAuth(`${SERVER_URL}/admin/object/${objectId}`);
            const d = await r.json();

            if (d.status === 'success' && d.object) {
                editObjectName.value = d.object.name;
                editObjectInfo.value = d.object.additional_info || '';
            } else {
                alert(d.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.');
                objectEditModal.style.display = 'none';
                return;
            }
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–∞.');
            objectEditModal.style.display = 'none';
            return;
        }
    } else {
        // –†–ï–ñ–ò–ú –°–û–ó–î–ê–ù–ò–Ø
        objectEditTitle.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞';
        deleteObjectBtn.style.display = 'none';
        objectPointsList.style.display = 'none'; // –°–∫—Ä—ã—Ç–∏–µ —Å–ø–∏—Å–∫–∞ –º–µ—Ç–æ–∫ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
    }
    loadObjectPoints(objectId); // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ç–æ–∫, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –∫ –æ–±—ä–µ–∫—Ç—É
    objectEditModal.style.display = 'flex';
}

// --- OBJECT LOGIC: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–∞ (–°–æ–∑–¥–∞–Ω–∏–µ/–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ) ---
saveObjectBtn.onclick = async () => {
    const objectId = editObjectId.value;
    const url = objectId ? `${SERVER_URL}/admin/object/${objectId}` : `${SERVER_URL}/admin/object`;

    const data = {
        name: editObjectName.value.trim(),
        additional_info: editObjectInfo.value.trim()
    };

    if (!data.name) {
        alert('–ü–æ–ª–µ "–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞" –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.');
        return;
    }

    try {
        const r = await fetchWithAuth(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        if (!r.ok) {
            const errorData = await r.json().catch(() => ({ message: `HTTP Error: ${r.status}` }));
            alert(errorData.message || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${r.statusText}`);
            return;
        }

        const d = await r.json();

        if (d.status === 'success') {
            objectEditModal.style.display = 'none';
            await loadObjectsTable(); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –æ–±—ä–µ–∫—Ç–æ–≤
        } else {
            alert(d.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.');
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–∞.');
        console.error("Save Object Error:", e);
    }
};

// --- OBJECT LOGIC: –£–¥–∞–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ ---
deleteObjectBtn.onclick = async () => {
    const objectId = editObjectId.value;

    if (!objectId) return;

    try {
        const url = `${SERVER_URL}/admin/object/${objectId}`;
        const r = await fetchWithAuth(url, { method: 'DELETE' });

        if (!r.ok) {
            const errorData = await r.json().catch(() => ({ message: `HTTP Error: ${r.status}` }));
            alert(errorData.message || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${r.statusText}`);
            return;
        }

        const d = await r.json();

        if (d.status === 'success') {
            objectEditModal.style.display = 'none';
            loadObjectsTable(); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
        } else {
            alert(d.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è.');
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞.');
        console.error("Delete Object Error:", e);
    }
    refreshMarkers(); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ (–µ—Å–ª–∏ –º–µ—Ç–∫–∏ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã)
};

// --- OBJECT LOGIC: –ö–Ω–æ–ø–∫–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è ---
createObjectBtn.onclick = () => openObjectEditModal();
objectEditModalClose.onclick = () => objectEditModal.style.display = 'none';

// --- ADMIN PANEL GENERAL LOGIC: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ ---
function switchAdminTab(tabName) {
    const adminTabContentPanes = document.querySelectorAll('.adminTabContentPane');

    // –°–±—Ä–æ—Å —Å—Ç–∏–ª–µ–π –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –≤–∫–ª–∞–¥–æ–∫
    adminTabButtons.forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = '#f4f4f4';
        btn.style.borderBottom = 'none';
    });

    // –°–∫—Ä—ã—Ç–∏–µ –≤—Å–µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –≤–∫–ª–∞–¥–æ–∫
    adminTabContentPanes.forEach(pane => {
        pane.style.display = 'none';
    });

    const selectedButton = document.querySelector(`.adminTabButton[data-tab="${tabName}"]`);
    const selectedContent = document.getElementById(`tab-${tabName}`);

    if (selectedButton && selectedContent) {
        selectedButton.classList.add('active');
        selectedButton.style.background = 'white';

        selectedContent.style.display = 'block';
    }
}

// –ü—Ä–∏–≤—è–∑–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–ª–∏–∫–∞ –∫ –∫–Ω–æ–ø–∫–∞–º –≤–∫–ª–∞–¥–æ–∫
adminTabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
        const tabName = btn.getAttribute('data-tab');
        switchAdminTab(tabName);

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
        if (tabName === 'users') {
            loadUsersTable();
        } else if (tabName === 'objects') {
            loadObjectsTable();
        } else if (tabName === 'assignments') {
            loadAssignmentData(); // loadAssignmentData –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ä–∞–Ω–µ–µ
        }
    });
});

// –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
adminPanelBtn.onclick = () => {
    if (isAdmin) {
        adminPanelWindow.style.display = 'flex';
        switchAdminTab('users'); // –û—Ç–∫—Ä—ã—Ç–∏–µ –≤–∫–ª–∞–¥–∫–∏ "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        loadUsersTable();
    } else {
        alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.');
    }
};

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
adminPanelClose.onclick = () => {
    adminPanelWindow.style.display = 'none';
};

// --- –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –º–µ—Ç–æ–∫, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –∫ –æ–±—ä–µ–∫—Ç—É (–¥–ª—è –≤–∫–ª–∞–¥–∫–∏ –æ–±—ä–µ–∫—Ç–æ–≤) ---
async function loadObjectPoints(objectId) {
    try {
        const response = await fetchWithAuth(`${SERVER_URL}/markers/by-object/${objectId}`);
        const data = await response.json();

        const tbody = document.querySelector("#pointTable tbody");
        tbody.innerHTML = ""; // –û—á–∏—Å—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü—ã

        if (data.status === "success" && Array.isArray(data.markers) && data.markers.length > 0) {
            data.markers.forEach(marker => {
                const tr = document.createElement("tr");
                tr.style.cursor = "pointer";

                tr.innerHTML = `
                    <td style="padding: 6px; border-bottom: 1px solid #eee;">–ú–µ—Ç–∫–∞ #${marker.id}</td>
                `;

                // –ö–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–ø–∞–ø —Å –¥–∞–Ω–Ω—ã–º–∏ –º–µ—Ç–∫–∏ (handleOpenMarkerPopup –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ä–∞–Ω–µ–µ)
                tr.onclick = () => handleOpenMarkerPopup(marker.id);

                tbody.appendChild(tr);
            });
        } else {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td style="padding: 6px; text-align: center;">–ù–µ—Ç –º–µ—Ç–æ–∫</td>`;
            tbody.appendChild(tr);
        }
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç–æ–∫:", e);
        const tbody = document.querySelector("#pointTable tbody");
        tbody.innerHTML = `<tr><td style="padding: 6px; text-align: center;">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</td></tr>`;
    }
}

// --- FINAL CALLS (–ü–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ app) ---
// –ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ä–∫–µ—Ä–æ–≤
loadMarkers();

// –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥)
setInterval(refreshMarkers, 30000);
}

document.addEventListener('DOMContentLoaded', async () => {
    // --- 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ ---
    const urlParams = new URLSearchParams(window.location.search);
    const tokenFromUrl = urlParams.get("token"); // –¢–æ–∫–µ–Ω –∏–∑ URL-–ø–∞—Ä–∞–º–µ—Ç—Ä–∞

    if (tokenFromUrl) {
        // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω –≤ URL, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º
        USER_TOKEN = tokenFromUrl; // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ USER_TOKEN –æ–±—ä—è–≤–ª–µ–Ω –∫–∞–∫ –≥–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è
        localStorage.setItem("userToken", USER_TOKEN);
        console.log('‚úÖ –¢–æ–∫–µ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ URL –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage.');
    } else {
        // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–∞ –≤ URL –Ω–µ—Ç, –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –µ–≥–æ –∏–∑ localStorage
        USER_TOKEN = localStorage.getItem("userToken");
        if (USER_TOKEN) {
            console.log('‚úÖ –¢–æ–∫–µ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ localStorage.');
        } else {
            // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–∏–≥–¥–µ –Ω–µ –Ω–∞–π–¥–µ–Ω
            console.error('‚ùå –û—à–∏–±–∫–∞: –¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.');
            alert('–î–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.');
            return; // –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, —Ç–∞–∫ –∫–∞–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞
        }
    }

    // --- 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ —á–µ—Ä–µ–∑ —ç–Ω–¥–ø–æ–∏–Ω—Ç /me ---
    try {
        // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ fetchWithAuth –∏—Å–ø–æ–ª—å–∑—É–µ—Ç USER_TOKEN –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ Authorization
        const r = await fetchWithAuth(`${SERVER_URL}/me`);
        const d = await r.json();

        if (d.status === "success") {
            // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            currentUsername = d.user.telegram_username; // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ currentUsername –æ–±—ä—è–≤–ª–µ–Ω
            isAdmin = d.user.role === 'admin'; // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (isAdmin –æ–±—ä—è–≤–ª–µ–Ω)

            updateUsernameDisplay(); // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª—è–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–º–µ–Ω–∏
            updateAdminPanelVisibility(); // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç/—Å–∫—Ä—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

            // --- 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
            // –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            initApp(); // –í—ã–∑–æ–≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

        } else {
            // –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω (—Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—Ç–∏–ª 401/403 –∏–ª–∏ status:"error")
            console.error("‚ùå –û—à–∏–±–∫–∞: –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.");
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω.");
            localStorage.removeItem("userToken"); // –û—á–∏—Å—Ç–∫–∞ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
        }
    } catch (e) {
        // –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω
        console.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–æ–∫–µ–Ω–∞:", e);
        alert("–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.");
    }
});


    </script>
</body>
</html>
