<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Leaflet с двухуровневыми метками</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
    #map { height: 100vh; width: 100%; position: relative; }
    .crosshair { position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; margin-left: -10px; margin-top: -10px; pointer-events: none; z-index: 999; }
    .crosshair::before, .crosshair::after { content: ''; position: absolute; background: black; }
    .crosshair::before { left: 50%; top: 0; width: 2px; height: 100%; margin-left: -1px; }
    .crosshair::after { top: 50%; left: 0; width: 100%; height: 2px; margin-top: -1px; }

    #coords { position: absolute; bottom: 50px; left: 10px; background: rgba(255,255,255,0.9); padding: 6px 10px; border-radius: 6px; font-family: monospace; z-index: 1000; }
    #newPointBtn { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; padding: 8px 16px; font-size: 16px; border: none; border-radius: 6px; background-color: #28a745; color: white; cursor: pointer; }

    #popupWindow { position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); z-index: 1001; width: 340px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); padding: 16px; display: none; font-family: sans-serif; }
    #popupWindow .closeBtn { position: absolute; top: 6px; right: 6px; width: 20px; height: 20px; cursor: pointer; }
    #popupWindow .closeBtn::before, #popupWindow .closeBtn::after { content: ''; position: absolute; width: 2px; height: 100%; background: black; top: 0; left: 50%; transform: translateX(-50%) rotate(45deg); }
    #popupWindow .closeBtn::after { transform: translateX(-50%) rotate(-45deg); }
    #popupWindow label { display: block; margin-top: 10px; font-weight: bold; }
    #popupWindow input[type="text"], #popupWindow textarea, #popupWindow input[type="file"] { width: 100%; padding: 6px; margin-top: 4px; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; }
    #popupWindow textarea { resize: vertical; }

    #photoList { margin-top: 8px; max-height: 100px; overflow-y: auto; }
    .photoItem { display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 4px 6px; border-radius: 4px; margin-bottom: 4px; font-size: 13px; }
    .removePhoto { color: red; cursor: pointer; font-weight: bold; }

    #spinner { display: none; margin-top: 10px; text-align: center; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; display: inline-block; }
    @keyframes spin { 0% {transform: rotate(0);} 100% {transform: rotate(360deg);} }

    .popup-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.7); display: none; align-items: center; justify-content: center; border-radius: 8px; z-index: 1002; }
    .popup-overlay.active { display: flex; }
</style>
</head>
<body>
<div id="map"></div>
<div class="crosshair"></div>
<div id="coords">Координаты: —</div>
<button id="newPointBtn">Новая точка</button>

<div id="popupWindow">
    <div class="closeBtn" title="Закрыть"></div>

    <div><strong>Координаты:</strong> <div id="popupCoords">—</div></div>

    <label for="locationInput">Локация <span style="color:red;">*</span>:</label>
    <input type="text" id="locationInput" placeholder="Введите название локации" required>

    <label for="noteInput">Запись:</label>
    <textarea id="noteInput" rows="4" placeholder="Введите текст..."></textarea>

    <label>Цвет метки:</label>
    <div>
        <label><input type="radio" name="markerColor" value="green" checked> Зелёный</label>
        <label style="margin-left:15px;"><input type="radio" name="markerColor" value="red"> Красный</label>
    </div>

    <label for="photoInput">Фотография:</label>
    <input type="file" id="photoInput" accept="image/*">
    <div id="photoList"></div>

    <button id="createBtn" style="margin-top:10px; padding:8px 12px; border:none; border-radius:4px; background:#007bff; color:white; cursor:pointer;">Создать</button>
    <div id="spinner"><div class="loader"></div><div>Отправка...</div></div>
    <div class="popup-overlay" id="popupOverlay">
        <div><div class="loader"></div><div style="text-align:center;margin-top:6px;">Отправка...</div></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const map = L.map('map', { center:[55.8892,37.445], zoom:12, attributionControl:false });
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const coordsDiv=document.getElementById('coords');
const popupCoordsDiv=document.getElementById('popupCoords');
function updateCenterCoords(){
    const c=map.getCenter();
    coordsDiv.textContent=`Координаты: ${c.lat.toFixed(6)}, ${c.lng.toFixed(6)}`;
    popupCoordsDiv.textContent=`${c.lat.toFixed(6)}, ${c.lng.toFixed(6)}`;
    window.currentCenter={lat:c.lat, lon:c.lng};
}
map.on('move', updateCenterCoords);
map.on('moveend', updateCenterCoords);
updateCenterCoords();

const popupWindow=document.getElementById('popupWindow');
const closeBtn=popupWindow.querySelector('.closeBtn');
const noteInput=document.getElementById('noteInput');
const locationInput=document.getElementById('locationInput');
const photoInput=document.getElementById('photoInput');
const photoList=document.getElementById('photoList');
const createBtn=document.getElementById('createBtn');
const overlay=document.getElementById('popupOverlay');
let selectedFile=null;

photoInput.addEventListener('change',()=>{selectedFile=photoInput.files[0];});

document.getElementById('newPointBtn').onclick=()=>{
    noteInput.value='';
    locationInput.value='';
    photoInput.value='';
    selectedFile=null;
    document.querySelector('input[name="markerColor"][value="green"]').checked=true;
    popupWindow.style.display='block';
};

closeBtn.onclick=()=>{popupWindow.style.display='none'; noteInput.value=''; locationInput.value=''; photoInput.value=''; selectedFile=null;};

function lockUI(lock){overlay.classList.toggle('active',lock); createBtn.disabled=lock; noteInput.disabled=lock; locationInput.disabled=lock; photoInput.disabled=lock;}

function addMarkerToMap(entry){
    const iconUrl=entry.color==='red'
        ? 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png'
        : 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png';
    const icon=L.icon({iconUrl, shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]});
    const marker=L.marker([entry.lat,entry.lon],{icon}).addTo(map);
    marker.bindPopup(entry.location);
}

fetch('https://91c99ab5bb3f.ngrok-free.app/entries').then(r=>r.json()).then(data=>{
    if(data.status==='success') data.entries.forEach(addMarkerToMap);
});

createBtn.onclick=()=>{
    const coords=window.currentCenter;
    const note=noteInput.value.trim();
    const location=locationInput.value.trim();
    if(!location) return alert('Введите название локации!');
    if(!note) return alert('Введите текст записи!');
    const color=document.querySelector('input[name="markerColor"]:checked')?.value||'green';

    const fd=new FormData();
    fd.append('lat', coords.lat);
    fd.append('lon', coords.lon);
    fd.append('note', note);
    fd.append('location', location);
    fd.append('color', color);
    if(selectedFile) fd.append('photos[]', selectedFile);

    lockUI(true);
    fetch('https://91c99ab5bb3f.ngrok-free.app/upload',{method:'POST', body:fd})
      .then(r=>r.json())
      .then(d=>{
          if(d.status==='success'){
              alert('Отправлено успешно!');
              popupWindow.style.display='none';
              noteInput.value=''; locationInput.value=''; photoInput.value=''; selectedFile=null;
              addMarkerToMap(d.entry);
          } else throw new Error(d.message||'Ошибка');
      })
      .catch(e=>alert('Ошибка: '+e.message))
      .finally(()=>lockUI(false));
};
</script>
</body>
</html>
